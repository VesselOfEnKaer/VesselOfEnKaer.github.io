<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–†–µ–∂–∏–º —Å–Ω–∞ ‚Äî Telegram WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0f1115; --card:#161923; --text:#e9eef6; --muted:#9aa4b2; --border:#232838; --accent:#4f8cff; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    .wrap{min-height:100%;display:grid;place-items:center;padding:24px}
    .card{width:100%;max-width:560px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,.35)}
    h1{margin:0 0 12px;font-size:20px}
    p{margin:0 0 18px;color:var(--muted)}
    .grid{display:grid;gap:12px}
    .menu-btn{display:flex;align-items:center;justify-content:space-between;width:100%;padding:14px 16px;font-size:16px;border-radius:12px;border:1px solid var(--border);background:#10141e;color:var(--text);cursor:pointer}
    .row{display:grid;gap:14px}
    .row.two{grid-template-columns:1fr 1fr}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="time"]{display:block;width:100%;background:#0e1118;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:16px;outline:none;transition:border-color .2s}
    input[type="time"]:focus{border-color:var(--accent)}
    textarea{width:100%;min-height:120px;resize:vertical;background:#0e1118;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:16px;outline:none}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
    .topbar{display:flex;align-items:center;gap:8px;margin:-8px 0 12px}
    .back{padding:6px 10px;border-radius:10px;background:#10141e;border:1px solid var(--border);color:var(--text);cursor:pointer}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- HOME -->
      <section id="screen-home" class="grid">
        <h1>üåô –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h1>
        <p>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ—Ç–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Å–Ω–∞.</p>
        <button class="menu-btn" id="btn-settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ <span>‚Ä∫</span></button>
        <button class="menu-btn" disabled>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ <span>‚Ä¢</span></button>
        <button class="menu-btn" disabled>‚è±Ô∏è –¢–∞–π–º–µ—Ä <span>‚Ä¢</span></button>
      </section>

      <!-- SETTINGS -->
      <section id="screen-settings" class="grid hidden">
        <div class="topbar"><button class="back" id="back-from-settings">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1></div>
        <button class="menu-btn" id="btn-edit-schedule">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ <span>‚Ä∫</span></button>
        <button class="menu-btn" id="btn-edit-goal">üéØ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å <span>‚Ä∫</span></button>
      </section>

      <!-- SCHEDULE -->
      <section id="screen-schedule" class="grid hidden">
        <div class="topbar"><button class="back" id="back-from-schedule">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üõå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞ —Å–Ω–∞</h1></div>
        <p>–£–∫–∞–∂–∏ –≤—Ä–µ–º—è –æ—Ç—Ö–æ–¥–∞ –∫–æ —Å–Ω—É –∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è. –§–æ—Ä–º–∞—Ç 24-—á–∞—Å–æ–≤–æ–π, HH:MM.</p>
        <div class="row two">
          <div><label for="sleep">–û—Ç—Ö–æ–¥ –∫–æ —Å–Ω—É</label><input id="sleep" type="time" step="60" required /></div>
          <div><label for="wake">–ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ</label><input id="wake" type="time" step="60" required /></div>
        </div>
        <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</div>
      </section>

      <!-- GOAL -->
      <section id="screen-goal" class="grid hidden">
        <div class="topbar"><button class="back" id="back-from-goal">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üéØ –¶–µ–ª—å</h1></div>
        <p><b>–Ø —Å–¥–µ–ª–∞—é –≤—Å—ë —Ä–∞–¥–∏‚Ä¶</b> –ù–∞–ø–∏—à–∏ —Å–≤–æ—é –ª–∏—á–Ω—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É —Ü–µ–ª–∏.</p>
        <textarea id="goal" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Å–Ω–∞ –∏ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"></textarea>
        <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å.</div>
      </section>
    </div>
  </div>

  <script>
  const tg = window.Telegram?.WebApp;

  // helpers
  function byId(id){ return document.getElementById(id); }
  function isValidTime(v){ return /^\d{2}:\d{2}$/.test(v); }

  // element refs (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤ init)
  let sleepEl, wakeEl, goalEl;
  let btnSettings, btnEditSchedule, btnEditGoal;
  let backFromSettings, backFromSchedule, backFromGoal;

  function applyTheme() {
    if (!tg) return;
    const t = tg.themeParams || {};
    const m = (k, d) => t[k] || d;
    document.documentElement.style.setProperty('--bg',    m('bg_color', '#0f1115'));
    document.documentElement.style.setProperty('--text',  m('text_color', '#e9eef6'));
    document.documentElement.style.setProperty('--muted', m('hint_color', '#9aa4b2'));
    document.documentElement.style.setProperty('--card',  m('secondary_bg_color', '#161923'));
    document.documentElement.style.setProperty('--border',m('section_separator_color', '#232838'));
  }

  function showScreen(name){
    for (const id of ['home','settings','schedule','goal']) {
      byId(`screen-${id}`).classList.toggle('hidden', id !== name);
    }
    if (!tg) return;
    if (name === 'schedule') {
      tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å');
      updateMainButtonSchedule();
    } else if (name === 'goal') {
      tg.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å');
      updateMainButtonGoal();
    } else {
      tg.MainButton.hide();
    }
  }

  function updateMainButtonSchedule(){
    if (!tg) return;
    const ok = isValidTime(sleepEl.value) && isValidTime(wakeEl.value);
    if (ok) tg.MainButton.show(); else tg.MainButton.hide();
  }

  function updateMainButtonGoal(){
    if (!tg) return;
    const ok = (goalEl.value || '').trim().length > 0;
    if (ok) tg.MainButton.show(); else tg.MainButton.hide();
  }

  function sendPayload(){
    // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —ç–∫—Ä–∞–Ω –≤–∏–¥–µ–Ω —Å–µ–π—á–∞—Å
    const visibleSchedule = !byId('screen-schedule').classList.contains('hidden');
    const visibleGoal     = !byId('screen-goal').classList.contains('hidden');

    const payload = {};
    if (visibleSchedule) {
      const st = sleepEl.value, wt = wakeEl.value;
      if (!isValidTime(st) || !isValidTime(wt)) return;
      payload.sleep_time = st; payload.wake_time = wt;
    }
    if (visibleGoal) {
      const g = (goalEl.value || '').trim();
      if (!g) return;
      payload.goal = g;
    }

    try { tg?.sendData(JSON.stringify(payload)); } catch(e) { console.error('sendData error', e); }
    try { tg?.HapticFeedback?.notificationOccurred('success'); } catch {}
    setTimeout(() => tg?.close(), 150);
  }

  function init(){
    // refs
    sleepEl = byId('sleep');
    wakeEl  = byId('wake');
    goalEl  = byId('goal');

    btnSettings      = byId('btn-settings');
    btnEditSchedule  = byId('btn-edit-schedule');
    btnEditGoal      = byId('btn-edit-goal');
    backFromSettings = byId('back-from-settings');
    backFromSchedule = byId('back-from-schedule');
    backFromGoal     = byId('back-from-goal');

    if (tg) {
      tg.ready();
      tg.expand();
      applyTheme();
      tg.onEvent('themeChanged', applyTheme);
      // —Å–ª—É—à–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –Ω–∏–∂–Ω–µ–π —Å–∏—Å—Ç–µ–º–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram
      tg.onEvent('mainButtonClicked', sendPayload);
    }

    // –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    if (btnSettings)     btnSettings.addEventListener('click',      () => showScreen('settings'));
    if (btnEditSchedule) btnEditSchedule.addEventListener('click',  () => showScreen('schedule'));
    if (btnEditGoal)     btnEditGoal.addEventListener('click',      () => showScreen('goal'));
    if (backFromSettings)backFromSettings.addEventListener('click', () => showScreen('home'));
    if (backFromSchedule)backFromSchedule.addEventListener('click', () => showScreen('settings'));
    if (backFromGoal)    backFromGoal.addEventListener('click',     () => showScreen('settings'));

    // –ø–æ–ª—è
    if (sleepEl) sleepEl.addEventListener('input', updateMainButtonSchedule);
    if (wakeEl)  wakeEl.addEventListener('input', updateMainButtonSchedule);
    if (goalEl)  goalEl.addEventListener('input', updateMainButtonGoal);

    // deep-link: ?screen=schedule | goal | home
    const s = (new URLSearchParams(location.search).get('screen') || 'home').toLowerCase();
    if (s === 'schedule') showScreen('schedule');
    else if (s === 'goal') showScreen('goal');
    else showScreen('home');
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
