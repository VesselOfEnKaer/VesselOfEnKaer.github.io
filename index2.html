<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GER40 — график</title>

  <!-- Минимальная стилизация, чтобы было видно статусы -->
  <style>
    body { background: #ffffff; color: #111111; }
    header { border-bottom-color: #ccc; background: #fafafa; }
    .btn { background: #f0f0f0; border-color: #ccc; color:#000; }
    .muted { color:#555; }
    #title { font-weight:700; }
    #subtitle { color:#666; font-size:12px; }
    #err { color:#c00; white-space:pre-wrap; font-family:ui-monospace, Menlo, Consolas, monospace; }
    #chart { height: calc(100vh - 68px); }
    
  </style>

  <!-- Библиотеки (без defer, чтобы гарантированно были до нашего кода) -->
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
</head>
<body>
  <header>
    <div id="title">Загрузка…</div>
    <div id="subtitle" class="muted">Ожидаем данные</div>
    <div style="margin-left:auto">
      <button id="copyLinkBtn" class="btn">Скопировать ссылку</button>
    </div>
  </header>
  <div id="chart"></div>
  <div id="err" style="padding:10px 14px; display:none"></div>

  <script>
    // Показ ошибок на странице
    function showError(msg) {
      const e = document.getElementById('err');
      e.style.display = 'block';
      e.textContent = String(msg || 'Неизвестная ошибка');
      document.getElementById('title').textContent = 'Ошибка';
      document.getElementById('subtitle').textContent = 'Смотри раздел ниже';
    }
    window.addEventListener('error', ev => showError(ev.error?.message || ev.message));

    // Утилиты
    const qs = new URLSearchParams(location.search);
    function b64urlToBytes(b64u) {
      const b64 = (b64u || '').replace(/-/g,'+').replace(/_/g,'/');
      const pad = b64.length % 4 ? 4 - (b64.length % 4) : 0;
      const binStr = atob(b64 + '='.repeat(pad));
      const out = new Uint8Array(binStr.length);
      for (let i=0;i<binStr.length;i++) out[i] = binStr.charCodeAt(i);
      return out;
    }

    function parsePayload() {
      // DEMO: ?demo=1 — генерим 30 свечей
      if (qs.get('demo') === '1') {
        const start = new Date('2025-01-02T00:00:00Z');
        const candles = Array.from({length:30}, (_,i)=>{
          const d = new Date(start.getTime() + i*86400000);
          const base = 17000 + i*15;
          const open = base + (i%2? -30:20);
          const high = open + 120;
          const low  = open - 90;
          const close= open + (i%3===0? 60 : -40);
          return { time: d.toISOString().slice(0,10), open, high, low, close };
        });
        return { symbol:'DEMO', exchange:'TEST', timeframe:'1D', candles };
      }

      const d = qs.get('d');
      const j = qs.get('j');
      try {
        if (d) {
          const inflated = pako.inflate(b64urlToBytes(d));
          const txt = new TextDecoder().decode(inflated);
          return JSON.parse(txt);
        }
        if (j) {
          return JSON.parse(decodeURIComponent(j));
        }
      } catch (e) {
        showError('Ошибка разбора параметров: ' + (e && e.message));
      }
      return null;
    }

    function renderChart(payload) {
      if (!window.LightweightCharts) {
        showError('Не загрузилась библиотека lightweight-charts');
        return;
      }
      if (!payload || !Array.isArray(payload.candles) || payload.candles.length===0) {
        document.getElementById('title').textContent = 'Нет данных';
        document.getElementById('subtitle').textContent = 'Добавь ?demo=1 или передай d=/j=';
        return;
      }
      const need = ['time','open','high','low','close'];
      for (const k of need) {
        if (!(k in payload.candles[0])) {
          showError('Неверный формат свечей: отсутствует ключ ' + k);
          return;
        }
      }

      const container = document.getElementById('chart');
      const chart = LightweightCharts.createChart(container, {
        autoSize: true,
        layout: { background:{type:'solid', color:'transparent'}, textColor:'#111' },
        rightPriceScale: { borderVisible:false },
        timeScale: { borderVisible:false, rightOffset:2, barSpacing:8, fixLeftEdge:true },
        grid: { vertLines:{ color:'rgba(128,128,128,.12)' }, horzLines:{ color:'rgba(128,128,128,.12)' } },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
      });
      const series = chart.addCandlestickSeries({
        upColor:'#22c55e', downColor:'#ef4444',
        borderUpColor:'#16a34a', borderDownColor:'#dc2626',
        wickUpColor:'#16a34a', wickDownColor:'#dc2626',
      });
      series.setData(payload.candles);
      chart.timeScale().fitContent();

      document.getElementById('title').textContent =
        (payload.symbol || 'GER40') + ' — дневные свечи';
      document.getElementById('subtitle').textContent =
        (payload.exchange || 'FOREXCOM') + ' • ' + (payload.timeframe || '1D') + ' • баров: ' + payload.candles.length;
    }

    // Кнопка "скопировать ссылку"
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('copyLinkBtn').addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(location.href); } catch {}
        const b = document.getElementById('copyLinkBtn');
        const t = b.textContent; b.textContent = 'Скопировано!'; setTimeout(()=>b.textContent=t, 1000);
      });

      const payload = parsePayload();
      try { renderChart(payload); }
      catch (e) { showError(e && e.message ? e.message : e); }
    });
  </script>
</body>
</html>
