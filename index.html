<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>ForHer ‚Äî –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f6f8fc; --card:#fff; --text:#0b1220; --muted:#5b6676; --border:#e6e9f2;
      --surface:#f1f4fa; --accent:#4f8cff; --btn-bg:var(--surface); --btn-fg:var(--text);
      --input-bg:#fbfcff; --input-fg:var(--text);
      --ease:cubic-bezier(.2,.7,.2,1);
      --t-fast:.15s; --t-med:.25s; --t-slow:.6s;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1115; --card:#161923; --text:#e9eef6; --muted:#9aa4b2; --border:#232838;
        --surface:#10141e; --accent:#4f8cff; --btn-bg:var(--surface); --btn-fg:var(--text);
        --input-bg:#0e1118; --input-fg:var(--text);
      }
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}

    /* —Ñ–æ–Ω —Å –º—è–≥–∫–∏–º ¬´–¥—ã—Ö–∞–Ω–∏–µ–º¬ª */
    .wrap{min-height:100%;display:grid;place-items:center;padding:24px;position:relative;overflow:hidden}
    .wrap::before{
      content:""; position:fixed; inset:-30%;
      background:
        radial-gradient(40% 35% at 20% 25%, rgba(79,140,255,.16), transparent 60%),
        radial-gradient(35% 30% at 80% 20%, rgba(255,150,190,.14), transparent 62%),
        radial-gradient(45% 40% at 50% 85%, rgba(120,220,180,.14), transparent 60%);
      filter: blur(40px); animation: floatBg 18s ease-in-out infinite alternate;
      pointer-events:none; z-index:0;
    }
    @keyframes floatBg{ 0%{transform:translate3d(0,0,0)} 50%{transform:translate3d(0,-10px,0)} 100%{transform:translate3d(0,0,0)} }

    .card{
      position:relative; z-index:1; width:min(560px,92vw);
      padding:clamp(14px,4vw,20px); background:var(--card); border:1px solid var(--border);
      border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,.12); overflow:hidden;
    }

    h1{margin:0 0 12px;font-size:22px}
    p{margin:0 0 18px;color:var(--muted)}
    .grid{display:grid;gap:12px;width:100%}

    /* –∫–Ω–æ–ø–∫–∏ + ripple */
    .menu-btn,.back{
      position:relative; overflow:hidden; transition:transform var(--t-fast) var(--ease), box-shadow var(--t-med) var(--ease);
      touch-action:manipulation;
    }
    .menu-btn{
      display:flex; align-items:center; justify-content:space-between; width:100%;
      padding:14px 16px; font-size:16px; border-radius:12px;
      background:var(--btn-bg); color:var(--btn-fg); border:1px solid var(--border); cursor:pointer;
    }
    .menu-btn.pressed,.back.pressed{ transform:translateY(1px) scale(.985); box-shadow:inset 0 2px 10px rgba(0,0,0,.08) }
    .back{padding:6px 10px;border-radius:10px;background:var(--surface);border:1px solid var(--border);cursor:pointer}
    .ripple{ position:absolute; border-radius:50%; transform:scale(0); pointer-events:none; background:currentColor; opacity:.15; animation:ripple .6s var(--ease) forwards }
    @keyframes ripple{ to{ transform:scale(12); opacity:0 } }

    label{display:block;font-size:20px;color:var(--muted);margin-bottom:0}
    input[type="time"],input[type="text"],textarea{
      display:block;width:100%;background:var(--input-bg);color:var(--input-fg);
      border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:16px;outline:none;
      transition:border-color var(--t-med) var(--ease), box-shadow var(--t-med) var(--ease);
    }
    input[type="time"]{height:48px;line-height:48px;appearance:none;-webkit-appearance:none;background-clip:padding-box}
    input[type="time"]:focus,input[type="text"]:focus,textarea:focus{border-color:var(--accent); box-shadow:0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent)}
    textarea{min-height:120px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
    .topbar{display:flex;align-items:center;gap:8px;margin:-8px 0 12px}
    .hidden{display:none}

    /* –ø–µ—Ä–µ—Ö–æ–¥—ã —ç–∫—Ä–∞–Ω–æ–≤ */
    section{opacity:0; transform:translateY(8px); pointer-events:none}
    section.active{opacity:1; transform:none; pointer-events:auto; transition:opacity var(--t-med) var(--ease), transform var(--t-med) var(--ease)}
    section.leaving{opacity:0; transform:translateY(8px) scale(.98); transition:opacity var(--t-med) var(--ease), transform var(--t-med) var(--ease)}

    /* ===== –°–õ–ê–ô–î–ï–† –í–ê–ñ–ù–û–°–¢–ò ===== */
    .imp-wrap{ position:relative; }
    .imp-labels{ display:flex; justify-content:space-between; font-size:13px; color:var(--muted); margin:-2px 0 4px }
    .imp-row{ position:relative; padding:10px 8px 2px }
    .imp-value{
      position:absolute; top:-10px; transform:translateX(-50%);
      padding:4px 8px; font-size:12px; border-radius:10px; color:#fff; background:hsl(var(--h,120),80%,50%);
      box-shadow:0 2px 10px rgba(0,0,0,.15); user-select:none;
    }

    input.range{
      --fill:50%; --h:120; --scale:1;
      width:100%; height:44px; appearance:none; -webkit-appearance:none; background:transparent; outline:none;
    }
    /* —Ç—Ä–µ–∫ */
    input.range::-webkit-slider-runnable-track{
      height:6px; border-radius:6px;
      background:linear-gradient(to right,
                 hsl(var(--h),80%,55%) 0 var(--fill),
                 color-mix(in oklab, var(--border) 80%, transparent) var(--fill) 100%);
    }
    input.range::-moz-range-track{
      height:6px; border-radius:6px;
      background:linear-gradient(to right,
                 hsl(var(--h),80%,55%) 0 var(--fill),
                 color-mix(in oklab, var(--border) 80%, transparent) var(--fill) 100%);
    }
    /* –ø–æ–ª–∑—É–Ω–æ–∫ */
    input.range::-webkit-slider-thumb{
      -webkit-appearance:none; width:22px; height:22px; margin-top:-8px; border-radius:50%;
      background:#fff; border:3px solid hsl(var(--h),80%,55%);
      box-shadow:0 2px 10px rgba(0,0,0,.2); transition:transform .12s var(--ease), border-color .12s var(--ease);
      transform:scale(var(--scale));
    }
    input.range:active::-webkit-slider-thumb{ transform:scale(calc(var(--scale) * 1.08)) }
    input.range::-moz-range-thumb{
      width:22px; height:22px; border-radius:50%; background:#fff; border:3px solid hsl(var(--h),80%,55%);
      box-shadow:0 2px 10px rgba(0,0,0,.2); transition:transform .12s var(--ease), border-color .12s var(--ease);
      transform:scale(var(--scale));
    }

    /* Task layout */
    #screen-task .form{ display:grid; gap:14px }
    #screen-task .goal-line{ margin:0 0 10px; color:var(--muted) }

    @media (prefers-reduced-motion: reduce){ *{animation:none!important;transition:none!important} }
    @media (max-width:520px){ .grid{gap:12px} }
    @media (max-width:360px){ .card{padding:12px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- HOME -->
      <section id="screen-home" class="grid active">
        <h1>üè† –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h1>
        <p>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ForHer.</p>
        <button class="menu-btn" id="btn-settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ <span>‚Ä∫</span></button>
        <button class="menu-btn" id="btn-task">‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É <span>‚Ä∫</span></button>
      </section>

      <!-- SETTINGS -->
      <section id="screen-settings" class="grid hidden">
        <div class="topbar"><button class="back" id="back-from-settings">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1></div>
        <button class="menu-btn" id="btn-edit-schedule">üõå –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ <span>‚Ä∫</span></button>
        <button class="menu-btn" id="btn-edit-goal">üéØ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å <span>‚Ä∫</span></button>
      </section>

      <!-- SCHEDULE -->
      <section id="screen-schedule" class="grid hidden">
        <div class="topbar"><button class="back" id="back-from-schedule">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üõå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞ —Å–Ω–∞</h1></div>
        <p>–£–∫–∞–∂–∏ –≤—Ä–µ–º—è –æ—Ç—Ö–æ–¥–∞ –∫–æ —Å–Ω—É –∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è. –§–æ—Ä–º–∞—Ç 24-—á–∞—Å–æ–≤–æ–π, HH:MM.</p>
        <div class="row two">
          <div><label for="sleep">–û—Ç—Ö–æ–¥ –∫–æ —Å–Ω—É</label><input id="sleep" type="time" step="60" required /></div>
          <div><label for="wake">–ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ</label><input id="wake" type="time" step="60" required /></div>
        </div>
        <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</div>
      </section>

      <!-- GOAL -->
      <section id="screen-goal" class="grid hidden">
        <div class="topbar"><button class="back" id="back-from-goal">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üéØ –¶–µ–ª—å</h1></div>
        <p><b>–Ø —Å–¥–µ–ª–∞—é –≤—Å—ë —Ä–∞–¥–∏‚Ä¶</b> –ù–∞–ø–∏—à–∏ —Å–≤–æ—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É —Ü–µ–ª–∏.</p>
        <textarea id="goal" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Å–Ω–∞ –∏ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"></textarea>
        <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å.</div>
      </section>

      <!-- TASK -->
      <section id="screen-task" class="grid hidden">
        <div class="topbar">
          <button class="back" id="back-from-task">‚Üê –ù–∞–∑–∞–¥</button>
          <h1 style="margin:0">‚úçÔ∏è –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h1>
        </div>
        <p>–§–æ—Ä–º–∞—Ç: <b>–Ø</b> [—Å–¥–µ–ª–∞—é –¥–µ–π—Å—Ç–≤–∏–µ] <b>—Ä–∞–¥–∏</b> [–º–æ–µ–π —Ü–µ–ª–∏].</p>
        <div class="form">
          <label for="action">–Ø</label>
          <input id="action" type="text" placeholder="–∏–∑—É—á—É –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—Å–¥–µ–ª–∞—é 10 –æ—Ç–∂–∏–º–∞–Ω–∏–π" />
          <p class="goal-line">—Ä–∞–¥–∏ <b id="goal-view">–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –º–µ—á—Ç—ã</b></p>

          <div class="imp-wrap">
            <div class="imp-labels"><span>–ö–æ—Å–≤–µ–Ω–Ω–æ–µ</span><span>–ü—Ä—è–º–æ–µ</span></div>
            <div class="imp-row">
              <input class="range" id="imp" type="range" min="0.1" max="3" step="0.1" value="1.0" />
              <div class="imp-value" id="imp-badge">1,0</div>
            </div>
          </div>

          <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É.</div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    const $ = (id) => document.getElementById(id);
    const isValidTime = (v) => /^\d{2}:\d{2}$/.test(v);

    function applyTheme(){
      const scheme = tg?.colorScheme ?? 'light';
      const set=(k,v)=>document.documentElement.style.setProperty(k,v);
      if(scheme==='dark'){
        set('--bg','#0f1115'); set('--card','#161923'); set('--text','#e9eef6'); set('--muted','#9aa4b2');
        set('--border','#232838'); set('--surface','#10141e'); set('--accent','#4f8cff');
        set('--btn-bg','var(--surface)'); set('--btn-fg','var(--text)');
        set('--input-bg','#0e1118'); set('--input-fg','var(--text)');
      }else{
        set('--bg','#f6f8fc'); set('--card','#ffffff'); set('--text','#0b1220'); set('--muted','#5b6676');
        set('--border','#e6e9f2'); set('--surface','#f1f4fa'); set('--accent','#4f8cff');
        set('--btn-bg','var(--surface)'); set('--btn-fg','var(--text)');
        set('--input-bg','#fbfcff'); set('--input-fg','var(--text)');
      }
      if(tg?.themeParams?.button_color){ set('--accent', tg.themeParams.button_color); }
    }

    /* –ø–µ—Ä–µ—Ö–æ–¥—ã —ç–∫—Ä–∞–Ω–æ–≤ */
    function showScreen(name){
      const ids=['home','settings','schedule','goal','task'];
      const next=$(`screen-${name}`);
      const current=document.querySelector('section.active');
      if(current===next) return;

      next.classList.remove('hidden');
      requestAnimationFrame(()=>{
        current?.classList.add('leaving');
        next.classList.add('active'); next.classList.remove('leaving');
        setTimeout(()=>{
          current?.classList.remove('active','leaving');
          if(current && !ids.some(k=>current.id===`screen-${k}` && current.classList.contains('active'))){
            current.classList.add('hidden');
          }
        }, 260);
      });

      if(!tg) return;
      if(name==='schedule'){ tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å'); updateMainButtonSchedule(); }
      else if(name==='goal'){ tg.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'); updateMainButtonGoal(); }
      else if(name==='task'){ tg.MainButton.setText('–°–æ–∑–¥–∞—Ç—å'); updateMainButtonTask(); }
      else { tg.MainButton.hide(); }
    }

    function updateMainButtonSchedule(){ if(!tg) return; const ok=isValidTime($('sleep').value||'')&&isValidTime($('wake').value||''); tg.MainButton[ok?'show':'hide'](); }
    function updateMainButtonGoal(){ if(!tg) return; const ok=( $('goal').value||'' ).trim().length>0; tg.MainButton[ok?'show':'hide'](); }
    function updateMainButtonTask(){
      if(!tg) return;
      const actionOk=( $('action').value||'' ).trim().length>0;
      const imp=parseFloat(($('imp').value||'').replace(',','.'));
      const impOk = !Number.isNaN(imp) && imp>=0.1 && imp<=3;
      tg.MainButton[ actionOk && impOk ? 'show' : 'hide' ]();
    }

    /* ripple + press fx */
    function addRipple(e){
      const el=e.currentTarget, rect=el.getBoundingClientRect(), size=Math.max(rect.width,rect.height);
      const r=document.createElement('span'); r.className='ripple'; r.style.width=r.style.height=size+'px';
      r.style.left=(e.clientX-rect.left-size/2)+'px'; r.style.top=(e.clientY-rect.top-size/2)+'px';
      el.appendChild(r); setTimeout(()=>r.remove(),650);
    }
    function pressOn(e){ e.currentTarget.classList.add('pressed'); try{tg?.HapticFeedback?.impactOccurred('light')}catch{} }
    function pressOff(e){ e.currentTarget.classList.remove('pressed'); }
    function wireButtonFX(selector){
      document.querySelectorAll(selector).forEach(el=>{
        el.addEventListener('pointerdown', pressOn);
        el.addEventListener('pointerup', pressOff);
        el.addEventListener('pointerleave', pressOff);
        el.addEventListener('click', addRipple);
      });
    }

    /* ===== importance slider live UI ===== */
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function mapHue(v){ // 0.1..3 -> 0..120 (–∫—Ä–∞—Å–Ω—ã–π -> –∑–µ–ª—ë–Ω—ã–π)
      const t = (v-0.1)/(3-0.1);
      return Math.round(0 + (120-0)*t);
    }
    function updateImpUI(){
      const el=$('imp'); const badge=$('imp-badge');
      const v = clamp(parseFloat(el.value||'1'), 0.1, 3.0);
      const pct = ((v-0.1)/(3-0.1))*100;
      const hue = mapHue(v);
      const scale = 0.98 + (v-0.1)/(3-0.1)*0.12; // —á—É—Ç—å –±–æ–ª—å—à–µ ‚Äî —á—É—Ç—å ¬´–≤–µ—Å–æ–º–µ–µ¬ª

      el.style.setProperty('--fill', pct+'%');
      el.style.setProperty('--h', hue);
      el.style.setProperty('--scale', scale);

      badge.textContent = v.toFixed(1).replace('.', ',');
      const rect = el.getBoundingClientRect();
      const x = rect.left + rect.width * pct/100;
      const parentLeft = el.parentElement.getBoundingClientRect().left;
      badge.style.left = (x - parentLeft) + 'px';
      badge.style.background = `hsl(${hue} 80% 50%)`;

      updateMainButtonTask();
    }

    function sendPayload(){
      const payload={};
      payload.tz_offset_min = new Date().getTimezoneOffset();

      if(!$('screen-schedule').classList.contains('hidden')){
        const st=$('sleep').value, wt=$('wake').value;
        if(!isValidTime(st)||!isValidTime(wt)) return;
        payload.sleep_time=st; payload.wake_time=wt;
      }
      if(!$('screen-goal').classList.contains('hidden')){
        const g=($('goal').value||'').trim(); if(!g) return; payload.goal=g;
      }
      if(!$('screen-task').classList.contains('hidden')){
        const a=($('action').value||'').trim(); if(!a) return;
        const goal=($('goal-view').textContent||'').trim();
        const imp=parseFloat(($('imp').value||'1').replace(',','.'));
        if(Number.isNaN(imp)) return;
        payload.task = `–Ø ${a} —Ä–∞–¥–∏ ${goal}`;
        payload.importance = Math.round(imp*10)/10; // 1 —Ü–∏—Ñ—Ä–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
      }

      try{ tg?.sendData(JSON.stringify(payload)); }catch(e){ console.error(e) }
      try{ tg?.HapticFeedback?.notificationOccurred('success'); }catch{}
      setTimeout(()=>tg?.close(), 120);
    }

    function bind(){
      // –Ω–∞–≤–∏–≥–∞—Ü–∏—è
      $('btn-settings')?.addEventListener('click', ()=>showScreen('settings'));
      $('btn-task')?.addEventListener('click', ()=>showScreen('task'));
      $('btn-edit-schedule')?.addEventListener('click', ()=>showScreen('schedule'));
      $('btn-edit-goal')?.addEventListener('click', ()=>showScreen('goal'));
      $('back-from-settings')?.addEventListener('click', ()=>showScreen('home'));
      $('back-from-schedule')?.addEventListener('click', ()=>showScreen('settings'));
      $('back-from-goal')?.addEventListener('click', ()=>showScreen('settings'));
      $('back-from-task')?.addEventListener('click', ()=>showScreen('home'));

      // –∏–Ω–ø—É—Ç—ã
      $('sleep')?.addEventListener('input', updateMainButtonSchedule);
      $('wake')?.addEventListener('input', updateMainButtonSchedule);
      $('goal')?.addEventListener('input', updateMainButtonGoal);
      $('action')?.addEventListener('input', updateMainButtonTask);

      // —Å–ª–∞–π–¥–µ—Ä
      $('imp')?.addEventListener('input', updateImpUI);
      window.addEventListener('resize', updateImpUI);

      // —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∏
      wireButtonFX('.menu-btn, .back');
    }

    function init(){
      tg?.ready(); tg?.expand(); applyTheme();
      tg?.onEvent('themeChanged', applyTheme);
      tg?.onEvent('mainButtonClicked', sendPayload);

      bind();

      const params=new URLSearchParams(location.search);
      let screen=(params.get('screen')||'home').toLowerCase();
      let goalFromQuery=params.get('goal');

      const sp=tg?.initDataUnsafe?.start_param;
      if(sp && typeof sp==='string'){
        const usp=new URLSearchParams(sp);
        screen=(usp.get('screen')||screen||'home').toLowerCase();
        goalFromQuery=usp.get('goal')||goalFromQuery;
      }
      if(goalFromQuery){ $('goal-view').textContent=goalFromQuery; }

      if      (screen==='schedule') showScreen('schedule');
      else if (screen==='goal')     showScreen('goal');
      else if (screen==='task')     showScreen('task');
      else                          showScreen('home');

      updateImpUI(); // –ø–µ—Ä–≤–∏—á–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–µ–π–¥–∂–∞/—Ü–≤–µ—Ç–∞
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
