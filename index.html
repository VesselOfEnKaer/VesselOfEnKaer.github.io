<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>ForHer ‚Äî –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#f6f8fc; --card:#ffffff; --text:#0b1220; --muted:#5b6676; --border:#e6e9f2; --surface:#f1f4fa; --accent:#4f8cff; --btn-bg:var(--surface); --btn-fg:var(--text); --input-bg:#fbfcff; --input-fg:var(--text); --mood:#8aa0b4; }
    @media (prefers-color-scheme: dark){
      :root { --bg:#0f1115; --card:#161923; --text:#e9eef6; --muted:#9aa4b2; --border:#232838; --surface:#10141e; --accent:#4f8cff; --btn-bg:var(--surface); --btn-fg:var(--text); --input-bg:#0e1118; --input-fg:var(--text); }
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    .wrap{min-height:100%;display:grid;place-items:center;padding:24px;position:relative;overflow:hidden}
    .card{width:min(560px,92vw);padding:clamp(14px,4vw,20px);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.12);overflow:hidden;position:relative}
    h1{margin:0 0 12px;font-size:22px}
    p{margin:0 0 18px;color:var(--muted)}
    .grid{display:grid;gap:12px;width:100%}
    .menu-btn{display:flex;align-items:center;justify-content:space-between;width:100%;padding:14px 16px;font-size:16px;border-radius:12px;background:var(--btn-bg);color:var(--btn-fg);border:1px solid var(--border);cursor:pointer;transition:transform .08s ease, background .2s ease}
    .menu-btn:active{transform:scale(.98)}
    .row{display:grid;gap:14px;width:100%}
    .row.two{grid-template-columns:1fr 1fr}
    .row>div{min-width:0}
    label{display:block;font-size:20px;color:var(--muted);margin-bottom:0px}
    input[type="time"], input[type="text"], textarea{display:block;width:100%;max-width:100%;min-width:0;background:var(--input-bg);color:var(--input-fg);border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:16px;outline:none;transition:border-color .2s}
    input[type="time"]{height:48px;line-height:48px;appearance:none;-webkit-appearance:none;background-clip:padding-box}
    input[type="time"]:focus, input[type="text"]:focus, textarea:focus{border-color:var(--accent)}
    textarea{min-height:120px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
    .topbar{display:flex;align-items:center;gap:8px;margin:-8px 0 12px}
    .back{padding:6px 10px;border-radius:10px;background:var(--surface);border:1px solid var(--border);color:var(--text);cursor:pointer;transition:transform .08s ease}
    .back:active{transform:translateY(1px)}
    .hidden{display:none}
    @media (max-width:520px){ .row.two{grid-template-columns:1fr} .grid,.row{gap:12px} }
    @media (max-width:360px){ .grid,.row{gap:10px} .card{padding:12px} }

    /* ====== –ì—Ä–∞–¥–∏–µ–Ω—Ç –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ mood) ====== */
    .mood-overlay{
      position:fixed; inset:0; pointer-events:none; opacity:0; transition:opacity .35s ease;
      background:
        radial-gradient(900px 600px at 80% -10%, color-mix(in srgb, var(--mood) 40%, transparent), transparent 60%),
        radial-gradient(600px 400px at -10% 100%, color-mix(in srgb, var(--mood) 30%, transparent), transparent 60%);
    }
    .mood-on .mood-overlay{ opacity:.65 }

    /* ===== –ë–µ–π–¥–∂ –±–∞–ª–∞–Ω—Å–∞ ===== */
    .balance-badge{
      position:fixed; top:10px; right:12px; z-index:20;
      padding:8px 12px; border-radius:12px;
      background:rgba(0,0,0,.06); backdrop-filter:blur(6px);
      color:var(--text); border:1px solid var(--border);
      font-weight:700; font-size:14px;
      transition:transform .12s ease, opacity .2s ease;
      user-select:none;
    }
    .balance-badge:active{ transform:scale(.98) }
    @media (prefers-color-scheme: dark){ .balance-badge{ background:rgba(255,255,255,.06) } }

    /* ===== –ü—Ä–µ–∂–Ω—è—è —Ä–∞–∑–º–µ—Ç–∫–∞ –≤–∞–∂–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–µ–≥–º–µ–Ω—Ç—ã) ===== */
    .segmented {
      display:flex; gap:8px; background:var(--surface); border:1px solid var(--border);
      border-radius:12px; padding:6px; align-items:center; justify-content:space-between;
    }
    .seg-btn {
      flex:1; padding:10px 12px; text-align:center; border-radius:10px; border:1px solid transparent;
      background:transparent; color:var(--text); cursor:pointer; font-size:14px;
      user-select:none; transition:transform .06s ease, background .2s ease;
    }
    .seg-btn:active{ transform:scale(.98) }
    .seg-btn small { display:block; font-size:15px; color:var(--muted); margin-top:10px; }
    .seg-btn.active { background:var(--card); border-color:var(--border); box-shadow:0 1px 0 rgba(0,0,0,.05) inset; }

    /* Task layout tweaks */
    #screen-task .form { display: grid; gap: 14px; }
    #screen-task .goal-line { margin: 0px 0 15px; color: var(--muted); }
    #screen-task .segmented { width: 100%; }
    
    /* ===== Mood big card ===== */
    .mood-card{
      display:grid; gap:10px; place-items:center; text-align:center;
      padding:24px; border-radius:16px; border:1px solid var(--border);
      background:color-mix(in srgb, var(--mood) 6%, var(--card));
    }
    .mood-emoji{ font-size:48px; line-height:1 }
    .mood-title{ font-size:20px; font-weight:800; margin-top:4px }
    .mood-desc{ font-size:14px; color:var(--muted) }
  </style>
</head>
<body>
  <!-- –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ -->
  <div class="mood-overlay" id="mood-overlay"></div>

  <!-- –ë–µ–π–¥–∂ –±–∞–ª–∞–Ω—Å–∞ –≤—Å–µ–≥–¥–∞ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
  <div id="balance-badge" class="balance-badge">0 üé¥</div>

  <div class="wrap">
    <div class="card">
      <!-- HOME -->
      <section id="screen-home" class="grid">
        <h1>üè† –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h1>
        <p>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ForHer.</p>
        <button class="menu-btn" id="btn-settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ <span>‚Ä∫</span></button>
        <button class="menu-btn" id="btn-task">‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É <span>‚Ä∫</span></button>
        <button class="menu-btn" id="btn-stats">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ <span>‚Ä∫</span></button>
      </section>

      <!-- SETTINGS -->
      <section id="screen-settings" class="grid hidden">
        <div class="topbar"><button class="back" id="back-from-settings">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1></div>
        <button class="menu-btn" id="btn-edit-schedule">üõå –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ <span>‚Ä∫</span></button>
        <button class="menu-btn" id="btn-edit-goal">üéØ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å <span>‚Ä∫</span></button>
      </section>

      <!-- STATS (–≤—Ö–æ–¥) -->
      <section id="screen-stats" class="grid hidden">
        <div class="topbar"><button class="back" id="back-from-stats">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1></div>
        <button class="menu-btn" id="btn-stats-mood">üß† –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –±–æ—Ç–∞ <span>‚Ä∫</span></button>
        <!-- –∑–¥–µ—Å—å –ø–æ–∑–∂–µ –ø–æ—è–≤—è—Ç—Å—è –¥—Ä—É–≥–∏–µ –ø—É–Ω–∫—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü) -->
      </section>

      <!-- MOOD -->
      <section id="screen-stats-mood" class="grid hidden">
        <div class="topbar"><button class="back" id="back-from-stats-mood">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üß† –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –±–æ—Ç–∞</h1></div>

        <div class="mood-card">
          <div class="mood-emoji" id="mood-emoji">üòå</div>
          <div class="mood-title" id="mood-title">–†–æ–≤–Ω—ã–π (0)</div>
          <div class="mood-desc" id="mood-desc">–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å. –ü–æ—Ä–æ–≤–Ω—É –º—è–≥–∫–∏—Ö –∏ –∂—ë—Å—Ç–∫–∏—Ö —Ñ—Ä–∞–∑ ‚Äî –ø–æ –¥–µ–ª—É.</div>
        </div>

        <p class="hint">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ üé¥ –∏ –º–µ–Ω—è–µ—Ç —Å—Ç–∏–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π.</p>
      </section>

      <!-- SCHEDULE -->
      <section id="screen-schedule" class="grid hidden">
        <div class="topbar"><button class="back" id="back-from-schedule">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üõå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞ —Å–Ω–∞</h1></div>
        <p>–£–∫–∞–∂–∏ –≤—Ä–µ–º—è –æ—Ç—Ö–æ–¥–∞ –∫–æ —Å–Ω—É –∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è. –§–æ—Ä–º–∞—Ç 24-—á–∞—Å–æ–≤–æ–π, HH:MM.</p>
        <div class="row two">
          <div><label for="sleep">–û—Ç—Ö–æ–¥ –∫–æ —Å–Ω—É</label><input id="sleep" type="time" step="60" required /></div>
          <div><label for="wake">–ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ</label><input id="wake" type="time" step="60" required /></div>
        </div>
        <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</div>
      </section>

      <!-- GOAL -->
      <section id="screen-goal" class="grid hidden">
        <div class="topbar"><button class="back" id="back-from-goal">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üéØ –¶–µ–ª—å</h1></div>
        <p><b>–Ø —Å–¥–µ–ª–∞—é –≤—Å—ë —Ä–∞–¥–∏‚Ä¶</b> –ù–∞–ø–∏—à–∏ —Å–≤–æ—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É —Ü–µ–ª–∏.</p>
        <textarea id="goal" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Å–Ω–∞ –∏ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"></textarea>
        <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å.</div>
      </section>

      <!-- TASK (–æ—Å—Ç–∞–≤–ª—è—é —Ç–≤–æ—é —Ç–µ–∫—É—â—É—é —Ñ–æ—Ä–º—É; –µ—Å–ª–∏ —É —Ç–µ–±—è —É–∂–µ —Å–ª–∞–π–¥–µ—Ä/—á–µ–∫–±–æ–∫—Å—ã ‚Äî –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç) -->
      <section id="screen-task" class="grid hidden">
        <div class="topbar">
          <button class="back" id="back-from-task">‚Üê –ù–∞–∑–∞–¥</button>
          <h1 style="margin:0">‚úçÔ∏è –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h1>
        </div>
        <p>–§–æ—Ä–º–∞—Ç: <b>–Ø</b> [—Å–¥–µ–ª–∞—é –¥–µ–π—Å—Ç–≤–∏–µ] <b>—Ä–∞–¥–∏</b> [–º–æ–µ–π —Ü–µ–ª–∏].</p>
        <div class="form">
          <label for="action">–Ø</label>
          <input id="action" type="text" placeholder="–∏–∑—É—á—É –º–∞—Ç–µ—Ä–∏–∞–ª—ã/—Å–¥–µ–ª–∞—é 10 –æ—Ç–∂–∏–º–∞–Ω–∏–π" />
          <p class="goal-line">—Ä–∞–¥–∏ <b id="goal-view">–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –º–µ—á—Ç—ã</b></p>
          <label>–í–ª–∏—è–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–∏</label>
          <div class="segmented" id="importance">
            <button type="button" class="seg-btn" data-val="1">‚òÖ‚òÜ‚òÜ<small>–°–ª–∞–±–æ–µ</small></button>
            <button type="button" class="seg-btn" data-val="2">‚òÖ‚òÖ‚òÜ<small>–°—Ä–µ–¥–Ω–µ–µ</small></button>
            <button type="button" class="seg-btn" data-val="3">‚òÖ‚òÖ‚òÖ<small>–ü—Ä—è–º–æ–µ</small></button>
          </div>
          <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É.</div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    const $ = (id) => document.getElementById(id);
    const isValidTime = (v) => /^\d{2}:\d{2}$/.test(v);

    // ===== –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    const MOOD = {
      2:  { emoji:'üòá', title:'–î–æ–±—Ä—è—á–æ–∫ (+2)', color:'#20c997', desc:'–Ø –º—è–≥–∫–∏–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π. –ü–æ–¥–∫–∏–¥—ã–≤–∞—é –ª–∞–π—Ç–æ–≤—ã–µ –Ω—É–¥–∂–∏, –±–æ–ª—å—à–µ –ø–æ—Ö–≤–∞–ª—ã.' },
      1:  { emoji:'üôÇ', title:'–¢—ë–ø–ª—ã–π (+1)',   color:'#2ea8ff', desc:'–ß—É—Ç—å —Å—Ç—Ä–æ–∂–µ, –Ω–æ –≤—Å—ë –µ—â—ë –¥—Ä—É–∂–µ–ª—é–±–µ–Ω. –ù–∞–ø–æ–º–∏–Ω–∞—é –º—è–≥–∫–æ, –º–æ—Ç–∏–≤–∏—Ä—É—é.' },
      0:  { emoji:'üòå', title:'–†–æ–≤–Ω—ã–π (0)',    color:'#8aa0b4', desc:'–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å. –ü–æ—Ä–æ–≤–Ω—É –º—è–≥–∫–∏—Ö –∏ –∂—ë—Å—Ç–∫–∏—Ö —Ñ—Ä–∞–∑ ‚Äî –ø–æ –¥–µ–ª—É.' },
      [-1]:{ emoji:'üòæ', title:'–ö–æ–ª—é—á–∏–π (‚àí1)', color:'#ff9966', desc:'–ù–∞—á–∏–Ω–∞—é –ø–æ–¥–¥–∞–≤–ª–∏–≤–∞—Ç—å. –ë–æ–ª—å—à–µ –ø—Ä—è–º–æ—Ç—ã, –º–µ–Ω—å—à–µ –Ω–µ–∂–Ω–æ—Å—Ç–µ–π.' },
      [-2]:{ emoji:'üòà', title:'–ó–ª–æ–π (‚àí2)',    color:'#ff4d4f', desc:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–≥–æ—Å—Ç—å. –ñ—ë—Å—Ç–∫–∏–µ –Ω—É–¥–∂–∏ ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ —Ü–µ–ª—å –≤–∞–∂–Ω–µ–µ –æ—Ç–≥–æ–≤–æ—Ä–æ–∫.' },
    };

    let selectedImportance = null;
    let balanceTotal = 0;
    let moodLevel = 0;
    let userGoal = '';
    let userName = '';

    function applyTheme(){
      const scheme = tg?.colorScheme ?? 'light';
      const set = (k,v)=>document.documentElement.style.setProperty(k,v);
      if(scheme==='dark'){
        set('--bg','#0f1115'); set('--card','#161923'); set('--text','#e9eef6'); set('--muted','#9aa4b2'); set('--border','#232838'); set('--surface','#10141e'); set('--accent','#4f8cff'); set('--btn-bg','var(--surface)'); set('--btn-fg','var(--text)'); set('--input-bg','#0e1118'); set('--input-fg','var(--text)');
      } else {
        set('--bg','#f6f8fc'); set('--card','#ffffff'); set('--text','#0b1220'); set('--muted','#5b6676'); set('--border','#e6e9f2'); set('--surface','#f1f4fa'); set('--accent','#4f8cff'); set('--btn-bg','var(--surface)'); set('--btn-fg','var(--text)'); set('--input-bg','#fbfcff'); set('--input-fg','var(--text)');
      }
      if(tg?.themeParams?.button_color){ set('--accent', tg.themeParams.button_color); }
    }

    function clampMood(m){ m = parseInt(m||0,10); if(m>2)m=2; if(m<-2)m=-2; return m; }

    function renderBalanceBadge(){
      const el = $('balance-badge');
      if(!el) return;
      el.textContent = `${balanceTotal} üé¥`;
    }

    function setMoodColor(){
      const m = MOOD[moodLevel] || MOOD[0];
      document.documentElement.style.setProperty('--mood', m.color);
    }

    function showScreen(name){
      ['home','settings','schedule','goal','task','stats','stats-mood'].forEach(id=>{
        $(`screen-${id}`).classList.toggle('hidden', id!==name);
      });
      // —Ñ–æ–Ω –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ mood
      document.body.classList.toggle('mood-on', name==='stats-mood');

      if(!tg) return;
      if(name==='schedule'){ tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å'); updateMainButtonSchedule(); }
      else if(name==='goal'){ tg.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'); updateMainButtonGoal(); }
      else if(name==='task'){ tg.MainButton.setText('–°–æ–∑–¥–∞—Ç—å'); updateMainButtonTask(); }
      else { tg.MainButton.hide(); }

      // —Ä–µ–Ω–¥–µ—Ä mood-–∫–∞—Ä—Ç–æ—á–∫–∏
      if(name==='stats-mood'){
        const m = MOOD[moodLevel] || MOOD[0];
        $('mood-emoji').textContent = m.emoji;
        $('mood-title').textContent = m.title;
        $('mood-desc').textContent  = m.desc;
        setMoodColor();
      }
    }

    function updateMainButtonSchedule(){ if(!tg) return; const ok = isValidTime($('sleep').value||'') && isValidTime($('wake').value||''); tg.MainButton[ok?'show':'hide'](); }
    function updateMainButtonGoal(){ if(!tg) return; const ok = ( $('goal').value||'' ).trim().length>0; tg.MainButton[ok?'show':'hide'](); }
    function updateMainButtonTask(){
      if(!tg) return;
      const ok = ( $('action').value||'' ).trim().length>0 && (selectedImportance===1 || selectedImportance===2 || selectedImportance===3);
      tg.MainButton[ ok ? 'show' : 'hide' ]();
    }

    function bindImportance(){
      const cont = $('importance');
      if(!cont) return;
      cont.querySelectorAll('.seg-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          cont.querySelectorAll('.seg-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          selectedImportance = parseInt(btn.dataset.val, 10);
          updateMainButtonTask();
        });
      });
    }

    function sendPayload(){
      const payload = {};
      payload.tz_offset_min = new Date().getTimezoneOffset();

      if(!$('screen-schedule').classList.contains('hidden')){
        const st=$('sleep').value, wt=$('wake').value;
        if(!isValidTime(st)||!isValidTime(wt)) return;
        payload.sleep_time=st; payload.wake_time=wt;
      }
      if(!$('screen-goal').classList.contains('hidden')){
        const g=($('goal').value||'').trim(); if(!g) return; payload.goal=g;
      }
      if(!$('screen-task').classList.contains('hidden')){
        const a=($('action').value||'').trim(); if(!a) return;
        const goalText=($('goal-view').textContent||'').trim();
        if(!(selectedImportance===1 || selectedImportance===2 || selectedImportance===3)) return;
        payload.task = `–Ø ${a} —Ä–∞–¥–∏ ${goalText}`;
        payload.importance = selectedImportance;
      }

      try { tg?.sendData(JSON.stringify(payload)); } catch(e){ console.error(e); }
      try { tg?.HapticFeedback?.notificationOccurred('success'); } catch {}
      setTimeout(()=>tg?.close(), 120);
    }

    function bind(){
      $('btn-settings')?.addEventListener('click', ()=>showScreen('settings'));
      $('btn-task')?.addEventListener('click', ()=>showScreen('task'));
      $('btn-stats')?.addEventListener('click', ()=>showScreen('stats'));

      $('btn-stats-mood')?.addEventListener('click', ()=>showScreen('stats-mood'));

      $('btn-edit-schedule')?.addEventListener('click', ()=>showScreen('schedule'));
      $('btn-edit-goal')?.addEventListener('click', ()=>showScreen('goal'));

      $('back-from-settings')?.addEventListener('click', ()=>showScreen('home'));
      $('back-from-schedule')?.addEventListener('click', ()=>showScreen('settings'));
      $('back-from-goal')?.addEventListener('click', ()=>showScreen('settings'));
      $('back-from-task')?.addEventListener('click', ()=>showScreen('home'));
      $('back-from-stats')?.addEventListener('click', ()=>showScreen('home'));
      $('back-from-stats-mood')?.addEventListener('click', ()=>showScreen('stats'));

      $('sleep')?.addEventListener('input', updateMainButtonSchedule);
      $('wake')?.addEventListener('input', updateMainButtonSchedule);
      $('goal')?.addEventListener('input', updateMainButtonGoal);
      $('action')?.addEventListener('input', updateMainButtonTask);

      bindImportance();
    }

    function init(){
      tg?.ready(); tg?.expand(); applyTheme();
      tg?.onEvent('themeChanged', applyTheme);
      tg?.onEvent('mainButtonClicked', sendPayload);

      // —á–∏—Ç–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–¥–∞–ª –±–æ—Ç
      const params = new URLSearchParams(location.search);
      balanceTotal = parseInt(params.get('b') || '0', 10);
      moodLevel    = clampMood(params.get('m'));
      userGoal     = (params.get('g') || params.get('goal') || '').trim();
      userName     = (params.get('name') || '').trim();

      if (userGoal) $('goal-view').textContent = userGoal;
      renderBalanceBadge();
      setMoodColor();

      bind();

      // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ start_param (deep-link —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
      let screen = (params.get('screen')||'home').toLowerCase();
      const sp = tg?.initDataUnsafe?.start_param;
      if (sp && typeof sp === 'string') {
        const usp = new URLSearchParams(sp);
        screen = (usp.get('screen') || screen || 'home').toLowerCase();
        if (!userGoal) {
          const g2 = usp.get('g') || usp.get('goal');
          if (g2) { userGoal = g2; $('goal-view').textContent = userGoal; }
        }
      }

      if      (screen==='schedule')   showScreen('schedule');
      else if (screen==='goal')       showScreen('goal');
      else if (screen==='task')       showScreen('task');
      else if (screen==='stats')      showScreen('stats');
      else if (screen==='stats_mood' || screen==='mood') showScreen('stats-mood');
      else                            showScreen('home');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
