<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>ForHer ‚Äî –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg:#f6f8fc; --card:#ffffff; --text:#0b1220; --muted:#5b6676; --border:#e6e9f2;
  --surface:#f1f4fa; --accent:#4f8cff; --btn-bg:var(--surface); --btn-fg:var(--text);
  --input-bg:#fbfcff; --input-fg:var(--text);
  --mood:#8aa0b4; --meter:#4f8cff; --radius:16px;
  --good:#20c997; --bad:#ff4d4f; --warn:#ff9f40;
}
@media (prefers-color-scheme: dark){
:root{
  --bg:#0f1115; --card:#161923; --text:#e9eef6; --muted:#9aa4b2; --border:#232838;
  --surface:#10141e; --accent:#4f8cff; --btn-bg:var(--surface); --btn-fg:var(--text);
  --input-bg:#0e1118; --input-fg:var(--text);
}
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
.wrap{min-height:100%;display:grid;place-items:center;padding:24px;position:relative;overflow:hidden}
.card{
  width:min(560px,92vw);padding:clamp(14px,4vw,20px);
  background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:0 8px 32px rgba(0,0,0,.12);overflow:hidden;position:relative;
  transition:transform .18s ease, opacity .18s ease; z-index:2; margin-inline:auto;
}
h1{margin:0 0 12px;font-size:22px}
p{margin:0 0 18px;color:var(--muted)}
.grid{display:grid;gap:12px;width:100%}

/* –∫–Ω–æ–ø–∫–∏-–º–µ–Ω—é */
.menu-btn{
  display:flex;align-items:center;justify-content:space-between;width:100%;padding:14px 16px;
  font-size:16px;border-radius:12px;background:var(--btn-bg);color:var(--btn-fg);
  border:1px solid var(--border);cursor:pointer;transition:transform .08s ease, background .2s ease, box-shadow .2s ease;
  box-shadow:0 1px 0 rgba(0,0,0,.04) inset; -webkit-tap-highlight-color: transparent;
  will-change:transform;
}
.menu-btn:hover{ box-shadow:0 4px 14px rgba(0,0,0,.08) }
.menu-btn:active{ transform:scale(.98) }
.menu-btn > * { pointer-events:none }

/* —Ñ–æ—Ä–º—ã */
.row{display:grid;gap:14px;width:100%}
.row.two{grid-template-columns:1fr 1fr}
.row>div{min-width:0}
label{display:block;font-size:15px;color:var(--muted);margin-bottom:6px}
input[type="time"], input[type="text"], textarea{
  display:block;width:100%;max-width:100%;min-width:0;background:var(--input-bg);color:var(--input-fg);
  border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:16px;outline:none;transition:border-color .2s, box-shadow .2s;
}
input[type="time"]{height:48px;line-height:48px;appearance:none;-webkit-appearance:none;background-clip:padding-box}
input[type="time"]:focus, input[type="text"]:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgb(79 140 255 / 12%)}
textarea{min-height:120px;resize:vertical}
.hint{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
.topbar{display:flex;align-items:center;gap:8px;margin:-8px 0 12px}
.back{padding:6px 10px;border-radius:10px;background:var(--surface);border:1px solid var(--border);color:var(--text);cursor:pointer;transition:transform .08s ease}
.back:active{transform:translateY(1px)}
.hidden{display:none}
@media (max-width:520px){ .row.two{grid-template-columns:1fr} .grid,.row{gap:12px} }
@media (max-width:360px){ .grid,.row{gap:10px} .card{padding:12px} }

/* —Ñ–æ–Ω–æ–≤—ã–µ —à–∞—Ä—ã */
.wrap::before,.wrap::after{
  content:""; position:absolute; inset:auto; width:70vmax; height:70vmax; border-radius:50%;
  background: radial-gradient(closest-side, rgba(79,140,255,.12), transparent 70%);
  filter: blur(20px); z-index:0; animation:float 24s ease-in-out infinite alternate;
  pointer-events:none;
}
.wrap::before{ top:-30vmax; left:-20vmax }
.wrap::after { bottom:-30vmax; right:-25vmax; animation-duration:28s }
@keyframes float{ 0%{transform:translateY(-10px)} 100%{transform:translateY(10px)} }

/* –æ–≤–µ—Ä–ª–µ–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è */
.mood-overlay{
  position:fixed; inset:0; pointer-events:none; opacity:0; transition:opacity .35s ease;
  background:
    radial-gradient(900px 600px at 80% -10%, color-mix(in srgb, var(--mood) 35%, transparent), transparent 60%),
    radial-gradient(600px 400px at -10% 100%, color-mix(in srgb, var(--mood) 30%, transparent), transparent 60%);
  z-index:1;
}
.mood-on .mood-overlay{ opacity:.65 }

/* –±–µ–π–¥–∂ –±–∞–ª–∞–Ω—Å–∞ */
.balance-badge{
  position:fixed; top:10px; right:12px; z-index:20;
  padding:8px 12px; border-radius:12px;
  background:rgba(0,0,0,.06); backdrop-filter:blur(6px);
  color:var(--text); border:1px solid var(--border);
  font-weight:800; font-size:14px; line-height:1;
  transition:transform .12s ease, opacity .2s ease;
  user-select:none; display:flex; align-items:baseline; gap:6px;
}
.balance-badge:active{ transform:scale(.98) }
@media (prefers-color-scheme: dark){ .balance-badge{ background:rgba(255,255,255,.06) } }
.balance-badge .delta{ font-size:11px; font-weight:800 }
.balance-badge .delta.pos{ color:var(--good) }
.balance-badge .delta.neg{ color:var(--bad) }
.balance-badge .delta.zero{ color:var(--muted) }

/* –∫–∞—Ä—Ç–æ—á–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è */
.mood-card{
  display:grid; gap:10px; place-items:center; text-align:center;
  padding:24px; border-radius:16px; border:1px solid var(--border);
  background:color-mix(in srgb, var(--mood) 6%, var(--card)); position:relative; overflow:hidden;
}
.mood-card::after{
  content:""; position:absolute; inset:-40%; background:radial-gradient(circle at 60% 40%, color-mix(in srgb, var(--mood) 25%, transparent), transparent 60%);
  filter: blur(30px); opacity:.6; z-index:-1; animation: breathe 6s ease-in-out infinite;
}
@keyframes breathe{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.06)} }
.mood-emoji{ font-size:48px; line-height:1; transform:translateZ(0); transition:transform .12s ease }
.mood-emoji:active{ transform:scale(1.06) }
.mood-title{ font-size:20px; font-weight:800; margin-top:4px }
.mood-desc{ font-size:14px; color:var(--muted) }

/* —á–∏–ø—ã —Ä–µ–∂–∏–º–æ–≤ */
.chips{ display:flex; gap:8px; flex-wrap:wrap }
.chip{
  flex:1 1 0; min-width:calc(50% - 4px);
  text-align:center; padding:8px 12px; border-radius:999px; border:1px solid var(--border);
  background:var(--surface); color:var(--text); cursor:pointer; user-select:none; font-size:14px;
  transition:background .2s, transform .06s ease, border-color .2s, box-shadow .2s;
  white-space:nowrap;
}
.chip:active{ transform:scale(.98) }
.chip.active{ background:var(--card); border-color:var(--accent); box-shadow:0 0 0 4px rgb(79 140 255 / 12%) }

/* —Å–ª–∞–π–¥–µ—Ä –≤–∞–∂–Ω–æ—Å—Ç–∏ */
.scale-head{ display:flex; align-items:baseline; justify-content:space-between; gap:10px }
.scale-labels{ display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-top:4px }
.slider-wrap{ padding:10px 2px 0; position:relative; z-index:1 }
input[type="range"]{
  -webkit-appearance:none; width:100%; height:38px; background:transparent; outline:none;
  --val:0%; touch-action: pan-x; pointer-events:auto;
}
input[type="range"]::-webkit-slider-runnable-track{
  height:10px; border-radius:999px; background:
  linear-gradient(to right, var(--meter) 0% , var(--meter) var(--val), var(--border) var(--val), var(--border) 100%);
  border:1px solid color-mix(in srgb, var(--meter) 30%, var(--border));
  transition:background .06s linear, border-color .15s ease;
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none; margin-top:-6px; width:22px; height:22px; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #fff, #fff0 65%), var(--meter);
  border:2px solid #fff; box-shadow:0 2px 10px rgba(0,0,0,.18);
  transition:transform .08s ease, box-shadow .12s ease, background .15s ease;
}
input[type="range"]:active::-webkit-slider-thumb{ transform:scale(1.08); box-shadow:0 4px 16px rgba(0,0,0,.25) }
input[type="range"]::-moz-range-track{
  height:10px; border-radius:999px; background:
  linear-gradient(to right, var(--meter) 0% , var(--meter) var(--val), var(--border) var(--val), var(--border) 100%);
  border:1px solid color-mix(in srgb, var(--meter) 30%, var(--border));
}
input[type="range"]::-moz-range-thumb{
  width:22px; height:22px; border-radius:50%; background:var(--meter); border:2px solid #fff; box-shadow:0 2px 10px rgba(0,0,0,.18);
}
.readout{ display:flex; align-items:center; justify-content:flex-end; gap:8px; margin-top:4px; color:var(--muted); font-weight:700; }
.pill{
  padding:6px 10px; border-radius:999px; background:color-mix(in srgb, var(--meter) 16%, var(--card)); border:1px solid color-mix(in srgb, var(--meter) 40%, var(--border));
  color:var(--text); font-variant-numeric: tabular-nums; box-shadow:0 1px 0 rgba(0,0,0,.06) inset;
  transition:background .15s ease, border-color .15s ease;
}

/* ===== –ò—Ç–æ–≥–∏ –¥–Ω—è ===== */
.summary{ display:grid; gap:14px; place-items:center; text-align:center;
  padding:14px; border:1px solid var(--border); border-radius:14px; background:var(--surface); }
.summary-row{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:12px; width:100%; }
.summary-col{ display:grid; gap:6px; justify-items:center; }
.summary-amount{ font-size:26px; font-weight:900; letter-spacing:.2px; }
.summary-label{ font-size:12px; color:var(--muted) }
.summary-arrow{ position:relative; font-size:20px; font-weight:900; color:var(--muted);
  display:flex; align-items:center; justify-content:center; min-width:44px; }
.delta-badge{ position:absolute; top:-10px; right:-18px; font-size:11px; font-weight:900;
  padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:var(--card); }
.delta-badge.pos{ color:var(--good) } .delta-badge.neg{ color:var(--bad) } .delta-badge.zero{ color:var(--muted) }
.divider{ height:1px; width:100%; background:var(--border); margin:4px 0; }
.swap{ transform:translateY(4px); opacity:.98 }

/* ===== –ò–Ω—Ñ–æ: –±–æ–Ω—É—Å—ã –∏ —à—Ç—Ä–∞—Ñ—ã ===== */
.subttl{ margin:8px 0 6px; font-size:16px; }
.subttl.good{ color: var(--good); } .subttl.bad{ color: var(--bad); }
.subhint{ margin:0 0 10px; color: var(--muted); font-size:12px; }
.rule-table{ display:grid; gap:8px; }
.rule-head{ display:grid; grid-template-columns: 3fr 1fr 1fr; gap:8px;
  padding:6px 8px; border-radius:10px; background:var(--surface); border:1px solid var(--border); color:var(--muted); font-size:12px; }
.rule-row{ display:grid; grid-template-columns: 3fr 1fr 1fr; gap:8px; align-items:stretch;
  border:1px solid var(--border); border-radius:12px; overflow:hidden;
  background:linear-gradient(0deg, rgba(0,0,0,.02), rgba(0,0,0,0)); box-shadow:0 4px 14px rgba(0,0,0,.06); }
.rule-row.streak .ttl{ color: var(--warn); }
.rule-name{ padding:10px 12px; display:grid; gap:4px; }
.rule-name .ttl{ font-weight:700; font-size:14px; }
.rule-name .desc{ font-size:12px; color:var(--muted); line-height:1.3; }
.rule-per,.rule-max{ display:flex; align-items:center; justify-content:flex-end;
  padding:10px 12px; font-weight:800; font-variant-numeric: tabular-nums; }
.rule-per.good,.rule-max.good{ color:var(--good); } .rule-per.bad, .rule-max.bad { color:var(--bad);  }
.rule-total{ margin:6px 0 16px; font-weight:800; }
.rule-total.good{ color:var(--good); } .rule-total.bad{ color:var(--bad); }
@media (max-width:480px){ .rule-head, .rule-row{ grid-template-columns: 1.5fr .8fr .8fr; } }

/* ===== –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ===== */
.dep-list{ display:grid; gap:8px; }
.dep-item{
  display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--border);
  border-radius:12px; background:var(--surface);
}
.dep-item .name{ font-weight:800; }
.sev-pill{ margin-left:auto; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:var(--card); font-variant-numeric: tabular-nums; }
.dep-empty{ font-size:14px; color:var(--muted); padding:10px 0; text-align:center; }

.dep-chips{ display:flex; gap:8px; flex-wrap:wrap; }
.dep-chip{
  padding:6px 10px; border:1px solid var(--border); background:var(--surface); border-radius:999px; cursor:pointer; user-select:none;
}
.dep-chip.active{ border-color:var(--accent); background:var(--card); box-shadow:0 0 0 4px rgb(79 140 255 / 12%) }
</style>
</head>
<body>
<div class="mood-overlay" id="mood-overlay"></div>

<!-- –ë–µ–π–¥–∂ —Å –æ–±—â–∏–º –±–∞–ª–∞–Ω—Å–æ–º –∏ –¥–Ω–µ–≤–Ω–æ–π –¥–µ–ª—å—Ç–æ–π -->
<div id="balance-badge" class="balance-badge">
  <span id="balance-total">0 üé¥</span>
  <span id="balance-delta" class="delta zero">0</span>
</div>

<div class="wrap">
  <div class="card" id="card">
    <!-- HOME -->
    <section id="screen-home" class="grid">
      <h1>üè† –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h1>
      <p>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ForHer.</p>
      <button class="menu-btn" id="btn-settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-task">‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-info">‚ÑπÔ∏è –ò–Ω—Ñ–æ <span>‚Ä∫</span></button>
    </section>

    <!-- SETTINGS -->
    <section id="screen-settings" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-settings">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1></div>
      <button class="menu-btn" id="btn-edit-schedule">üõå –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-edit-goal">üéØ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-dependencies">üß≤ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ <span>‚Ä∫</span></button>
    </section>

    <!-- INFO HUB -->
    <section id="screen-info" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-info">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">‚ÑπÔ∏è –ò–Ω—Ñ–æ</h1></div>
      <button class="menu-btn" id="btn-info-day">üìÖ –ò—Ç–æ–≥–∏ –¥–Ω—è <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-info-mood">üß† –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –±–æ—Ç–∞ <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-info-bonuses">üé¥ –ë–æ–Ω—É—Å—ã –∏ —à—Ç—Ä–∞—Ñ—ã <span>‚Ä∫</span></button>
    </section>

    <!-- DAY SUMMARY -->
    <section id="screen-stats-day" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-stats-day">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üìÖ –ò—Ç–æ–≥–∏ –¥–Ω—è</h1></div>
      <div class="summary">
        <div class="summary-row">
          <div class="summary-col">
            <div class="summary-amount" id="sum-current">0 üé¥</div>
            <div class="summary-label">—Å–µ–≥–æ–¥–Ω—è</div>
          </div>
          <div class="summary-arrow">‚Üí <div id="sum-delta" class="delta-badge zero">0</div></div>
          <div class="summary-col">
            <div class="summary-amount" id="sum-next">0 üé¥</div>
            <div class="summary-label">–∑–∞–≤—Ç—Ä–∞</div>
          </div>
        </div>
        <div class="divider"></div>
        <button class="menu-btn" id="btn-day-details">üßæ –ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ —á–∞—Ç–µ <span>‚Ä∫</span></button>
        <div class="hint">–°–ª–µ–≤–∞ ‚Äî —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å, —Å–ø—Ä–∞–≤–∞ ‚Äî –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ —É—á—ë—Ç–∞ —Å—É–º–º—ã –∑–∞ –¥–µ–Ω—å.</div>
      </div>
    </section>

    <!-- MOOD -->
    <section id="screen-stats-mood" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-stats-mood">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üß† –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –±–æ—Ç–∞</h1></div>
      <div class="mood-card">
        <div class="mood-emoji" id="mood-emoji">üòå</div>
        <div class="mood-title" id="mood-title">–†–æ–≤–Ω—ã–π (0)</div>
        <div class="mood-desc" id="mood-desc">–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å. –ü–æ—Ä–æ–≤–Ω—É –º—è–≥–∫–∏—Ö –∏ –∂—ë—Å—Ç–∫–∏—Ö —Ñ—Ä–∞–∑ ‚Äî –ø–æ –¥–µ–ª—É.</div>
      </div>
      <p class="hint">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ üé¥ –∏ –º–µ–Ω—è–µ—Ç —Å—Ç–∏–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π.</p>
    </section>

    <!-- BONUSES & PENALTIES -->
    <section id="screen-bonuses" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-bonuses">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üé¥ –ë–æ–Ω—É—Å—ã –∏ —à—Ç—Ä–∞—Ñ—ã</h1></div>

      <h2 class="subttl good">–ë–æ–Ω—É—Å—ã</h2>
      <p class="subhint">–ü—Ä–æ—Ü–µ–Ω—Ç—ã –¥–µ–π—Å—Ç–≤—É—é—Ç –Ω–∞ –º–æ–¥—É–ª—å –¥–Ω–µ–≤–Ω–æ–π —Å—É–º–º—ã. –û—Ä–∞–Ω–∂–µ–≤—ã–µ ‚Äî —Å–µ—Ä–∏–∏.</p>
      <div class="rule-table" id="bonus-table">
        <div class="rule-head"><div>–ü—Ä–∞–≤–∏–ª–æ</div><div>–ó–∞ —Ä–∞–∑</div><div>–ú–∞–∫—Å/–¥–µ–Ω—å</div></div>
      </div>
      <div class="rule-total good" id="bonus-total">–ò—Ç–æ–≥–æ –º–∞–∫—Å–∏–º—É–º –±–æ–Ω—É—Å–æ–≤: +0%</div>

      <h2 class="subttl bad" style="margin-top:10px">–®—Ç—Ä–∞—Ñ—ã</h2>
      <p class="subhint">–°—É–º–º–∏—Ä—É—é—Ç—Å—è: –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã üé¥.</p>
      <div class="rule-table" id="penalty-table">
        <div class="rule-head"><div>–ü—Ä–∞–≤–∏–ª–æ</div><div>–ó–∞ —Ä–∞–∑</div><div>–ú–∞–∫—Å/–¥–µ–Ω—å</div></div>
      </div>
      <div class="rule-total bad" id="penalty-total">–ú–∞–∫—Å–∏–º—É–º —à—Ç—Ä–∞—Ñ–æ–≤: ‚àí0%</div>
    </section>

    <!-- SCHEDULE -->
    <section id="screen-schedule" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-schedule">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üõå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞ —Å–Ω–∞</h1></div>
      <p>–£–∫–∞–∂–∏ –≤—Ä–µ–º—è –æ—Ç—Ö–æ–¥–∞ –∫–æ —Å–Ω—É –∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è. –§–æ—Ä–º–∞—Ç 24-—á–∞—Å–æ–≤–æ–π, HH:MM.</p>
      <div class="row two">
        <div><label for="sleep">–û—Ç—Ö–æ–¥ –∫–æ —Å–Ω—É</label><input id="sleep" type="time" step="60" required /></div>
        <div><label for="wake">–ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ</label><input id="wake" type="time" step="60" required /></div>
      </div>
      <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</div>
    </section>

    <!-- GOAL -->
    <section id="screen-goal" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-goal">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üéØ –¶–µ–ª—å</h1></div>
      <p><b>–Ø —Å–¥–µ–ª–∞—é –≤—Å—ë —Ä–∞–¥–∏‚Ä¶</b> –ù–∞–ø–∏—à–∏ —Å–≤–æ—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É —Ü–µ–ª–∏.</p>
      <textarea id="goal" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Å–Ω–∞ –∏ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"></textarea>
      <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å.</div>
    </section>

    <!-- DEPENDENCIES: LIST/MANAGE -->
    <section id="screen-deps" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-deps">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üß≤ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</h1></div>
      <div class="dep-list" id="deps-list"></div>
      <button class="menu-btn" id="btn-dep-add">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å <span>‚Ä∫</span></button>
      <p class="hint">–°–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–æ—Ç–∞ –∏ –ø–æ—è–≤—è—Ç—Å—è –≤ –∑–∞–¥–∞—á–∞—Ö ¬´–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å¬ª.</p>
    </section>

    <!-- DEPENDENCIES: ADD FORM -->
    <section id="screen-deps-add" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-deps-add">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">‚ûï –ù–æ–≤–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å</h1></div>
      <label for="dep-name">–Ø –∑–∞–≤–∏—Å–∏–º –æ—Ç‚Ä¶</label>
      <input id="dep-name" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: —Å–ª–∞–¥–∫–æ–≥–æ / —Å–æ—Ü—Å–µ—Ç–µ–π / –∞–ª–∫–æ–≥–æ–ª—è" />

      <div class="scale-head">
        <label id="dep-scale-title">–°–∏–ª–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</label>
        <div class="readout"><span>—É—Ä–æ–≤–µ–Ω—å</span> <span class="pill" id="dep-imp-pill">1,0</span></div>
      </div>
      <div class="scale-labels"><span id="dep-lbl-min">–õ—ë–≥–∫–∞—è —Ç—è–≥–∞</span><span id="dep-lbl-max">–°–∏–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å</span></div>
      <div class="slider-wrap">
        <input id="dep-range" type="range" min="0.1" max="3" step="0.1" value="1.0" />
      </div>

      <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å.</div>
    </section>

    <!-- TASK -->
    <section id="screen-task" class="grid hidden">
      <div class="topbar">
        <button class="back" id="back-from-task">‚Üê –ù–∞–∑–∞–¥</button>
        <h1 style="margin:0">‚úçÔ∏è –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h1>
      </div>
      <p>–§–æ—Ä–º–∞—Ç: <b>–Ø</b> [—Å–¥–µ–ª–∞—é –¥–µ–π—Å—Ç–≤–∏–µ] <b>—Ä–∞–¥–∏</b> [–º–æ–µ–π —Ü–µ–ª–∏].</p>

      <div class="grid">
        <label for="action">–Ø</label>
        <input id="action" type="text" placeholder="–∏–∑—É—á—É –º–∞—Ç–µ—Ä–∏–∞–ª—ã / —Å–¥–µ–ª–∞—é 10 –æ—Ç–∂–∏–º–∞–Ω–∏–π / –Ω–µ –µ–º —Å–ª–∞–¥–∫–æ–µ —Å–µ–≥–æ–¥–Ω—è" />
        <p class="goal-line" style="margin:-6px 0 10px; color:var(--muted)">—Ä–∞–¥–∏ <b id="goal-view">–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –º–µ—á—Ç—ã</b></p>

        <div class="grid" style="gap:8px">
          <label>–†–µ–∂–∏–º</label>
          <div class="chips">
            <div class="chip" id="chip-will">üí™ –í–æ–ª–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ</div>
            <div class="chip" id="chip-add">üß≤ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å</div>
          </div>
        </div>

        <!-- –ü–∏–∫–µ—Ä –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å" -->
        <div id="dep-picker-wrap" class="grid hidden" style="gap:8px">
          <label>–í—ã–±–µ—Ä–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å</label>
          <div class="dep-chips" id="dep-chips"></div>
          <div class="hint" id="dep-picker-hint">–ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π? –î–æ–±–∞–≤—å –∏—Ö –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏¬ª.</div>
        </div>

        <div class="scale-head">
          <label id="scale-title">–í–ª–∏—è–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —Ü–µ–ª—å</label>
          <div class="readout"><span>–≤–µ—Å</span> <span class="pill" id="imp-pill">1,0</span></div>
        </div>
        <div class="scale-labels"><span id="lbl-min">–ö–æ—Å–≤–µ–Ω–Ω–æ–µ</span><span id="lbl-max">–ü—Ä—è–º–æ–µ</span></div>
        <div class="slider-wrap">
          <input id="importanceRange" type="range" min="0.1" max="3" step="0.1" value="1.0" />
        </div>

        <div class="hint" id="task-hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É.</div>
      </div>
    </section>
  </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
const $  = (id) => document.getElementById(id);
const isValidTime = (v) => /^\d{2}:\d{2}$/.test(v);

/* CloudStorage helpers */
const cs = {
  get: (k) => new Promise(res => tg?.CloudStorage?.getItem?.(k, v => res(v))),
  set: (k, v) => new Promise(res => tg?.CloudStorage?.setItem?.(k, String(v), () => res(true)))
};

let balanceTotal = 0, balanceToday = 0, moodLevel = 0;
let userGoal = '', userName = '';
let mode = 'normal';

/* –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å CloudStorage, –∞ –±–æ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç —É —Å–µ–±—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ) */
let deps = []; // [{id, name, sev}] sev ‚àà [0.1..3.0]
let selectedDepId = null;

/* –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç—ã */
const MOOD = {
  2:   { emoji:'üòá', title:'–î–æ–±—Ä—è—á–æ–∫ (+2)', color:'#20c997', desc:'–Ø –º—è–≥–∫–∏–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π. –õ–∞–π—Ç–æ–≤—ã–µ –Ω—É–¥–∂–∏, –º–Ω–æ–≥–æ –ø–æ—Ö–≤–∞–ª—ã.' },
  1:   { emoji:'üôÇ', title:'–¢—ë–ø–ª—ã–π (+1)',   color:'#2ea8ff', desc:'–î—Ä—É–∂–µ–ª—é–±–µ–Ω, –Ω–æ —Å–æ–±—Ä–∞–Ω. –ù–∞–ø–æ–º–∏–Ω–∞—é –º—è–≥–∫–æ, –º–æ—Ç–∏–≤–∏—Ä—É—é.' },
  0:   { emoji:'üòå', title:'–†–æ–≤–Ω—ã–π (0)',    color:'#8aa0b4', desc:'–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å. –ü–æ—Ä–æ–≤–Ω—É –º—è–≥–∫–∏—Ö –∏ –∂—ë—Å—Ç–∫–∏—Ö —Ñ—Ä–∞–∑.' },
  [-1]:{ emoji:'üòæ', title:'–ö–æ–ª—é—á–∏–π (‚àí1)',  color:'#ff9966', desc:'–°—Ç–∞–Ω–æ–≤–ª—é—Å—å –ø—Ä—è–º–µ–µ. –ú–µ–Ω—å—à–µ –Ω–µ–∂–Ω–æ—Å—Ç–µ–π ‚Äî –±–æ–ª—å—à–µ –¥–µ–ª–∞.' },
  [-2]:{ emoji:'üòà', title:'–ó–ª–æ–π (‚àí2)',     color:'#ff4d4f', desc:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–≥–æ—Å—Ç—å. –¶–µ–ª—å –≤–∞–∂–Ω–µ–µ –æ—Ç–≥–æ–≤–æ—Ä–æ–∫.' },
};
const clampMood = (m)=>{ m = parseInt(m||0,10); if(m>2)m=2; if(m<-2)m=-2; return m; }
const fmtInt = (n)=> new Intl.NumberFormat('ru-RU').format(n);

/* ====== –ë–æ–Ω—É—Å—ã/—à—Ç—Ä–∞—Ñ—ã (–∏–Ω—Ñ–æ) ====== */
/* –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: kind: 'pct' | 'fixed' */
const BONUS_RULES = [
  { emoji:"üßÆ", title:"–ö–∞–∂–¥–∞—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞", desc:"–ó–∞ –∫–∞–∂–¥—É—é –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É: +1% –∫ –º–æ–¥—É–ª—é –¥–Ω–µ–≤–Ω–æ–π —Å—É–º–º—ã. –õ–∏–º–∏—Ç +10%/–¥–µ–Ω—å.", kind:"pct", per:+1, max:+10 },
  { emoji:"‚≠êÔ∏è", title:"–ö–∞–∂–¥–∞—è –∑–Ω–∞—á–∏–º–∞—è (‚â•2.0)", desc:"+10% –∑–∞ –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É —Å –≤–∞–∂–Ω–æ—Å—Ç—å—é ‚â•2.0. –ë–µ–∑ –ª–∏–º–∏—Ç–∞ ‚Äî —Å—Ç–µ–∫—É–µ—Ç—Å—è.", kind:"pct", per:+10, max:null },
  { emoji:"üö¶", title:"–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–Ω—è", desc:"–ü–µ—Ä–≤–∞—è –∑–∞–¥–∞—á–∞ –≤ –ø–µ—Ä–≤—ã–µ 60 –º–∏–Ω—É—Ç —Ä–∞–±–æ—á–µ–π —Ñ–∞–∑—ã: +5% (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ).", kind:"pct", per:+5, max:+5 },
  { emoji:"‚è∞", title:"–†–∞–Ω–Ω–∏–π hi-impact", desc:"–õ—é–±–∞—è –∑–∞–¥–∞—á–∞ ‚â•2.0 –≤ –ø–µ—Ä–≤—ã–µ 5 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –ø–æ–¥—ä—ë–º–∞: +10% (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ).", kind:"pct", per:+10, max:+10 },
  { emoji:"üß≤", title:"–í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–æ–±–µ–∂–¥–µ–Ω—ã", desc:"–ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è –≤—Å–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ ¬´–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å¬ª –∑–∞–∫—Ä—ã—Ç—ã –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ: +20%.", kind:"pct", per:+20, max:+20 },
  { emoji:"ü´ô", title:"–ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", desc:"–ï—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—É—Å—Ç–æ: –ø–∞—Å—Å–∏–≤–Ω—ã–π –±–æ–Ω—É—Å +10% –µ–∂–µ–¥–Ω–µ–≤–Ω–æ.", kind:"pct", per:+10, max:+10 },
  { emoji:"üõå", title:"–†–µ–∂–∏–º —Å–æ–±–ª—é–¥—ë–Ω", desc:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–¥—ä—ë–º –∏ –æ—Ç–±–æ–π –≤ –æ–∫–Ω–µ 10 –º–∏–Ω—É—Ç: +20% (–∑–∞ –¥–µ–Ω—å).", kind:"pct", per:+20, max:+20 },

  /* –°–µ—Ä–∏–∏ (–æ—Ä–∞–Ω–∂–µ–≤—ã–º) */
  { emoji:"üß©", title:"–°–µ—Ä–∏—è: –¥–Ω–∏ —Å –∑–∞–¥–∞—á–∞–º–∏", desc:"–° 2-–≥–æ –ø–æ–¥—Ä—è–¥ –¥–Ω—è: +1% √ó –¥–ª–∏–Ω–∞ —Å–µ—Ä–∏–∏ (–º–∞–∫—Å +7%). –°–±—Ä–æ—Å –ø—Ä–∏ –¥–Ω–µ –±–µ–∑ –∑–∞–¥–∞—á.", kind:"pct", per:"+1%/–¥–µ–Ω—å", max:+7, streak:true },
  { emoji:"üî•", title:"–°–µ—Ä–∏—è: hi-impact", desc:"–° 2-–≥–æ –¥–Ω—è —Å ‚â•1 –∑–∞–¥–∞—á–µ–π ‚â•2.0: +2% √ó –¥–ª–∏–Ω–∞ —Å–µ—Ä–∏–∏ (–º–∞–∫—Å +14%).", kind:"pct", per:"+2%/–¥–µ–Ω—å", max:+14, streak:true },
  { emoji:"üõ°Ô∏è", title:"–°–µ—Ä–∏—è: –±–µ–∑ –ø—Ä–æ–≤–∞–ª–æ–≤", desc:"–° 2-–≥–æ –¥–Ω—è –±–µ–∑ ‚ùå: +3% √ó –¥–ª–∏–Ω–∞ —Å–µ—Ä–∏–∏ (–º–∞–∫—Å +18%).", kind:"pct", per:"+3%/–¥–µ–Ω—å", max:+18, streak:true },
  { emoji:"‚õìÔ∏è", title:"–°–µ—Ä–∏—è: –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–æ —Å–ø–∏—Å–∫—É", desc:"–° 1-–≥–æ –¥–Ω—è; –∫–∞–∂–¥–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–∞—ë—Ç +0.5% √ó —Å–ª–æ–∂–Ω–æ—Å—Ç—å √ó –¥–ª–∏–Ω–∞ (–º–∞–∫—Å 21 –¥–µ–Ω—å).", kind:"pct", per:"–¥–æ +0.5%¬∑S/–¥", max:"+–ø–æ —Å–ø–∏—Å–∫—É", streak:true },
];

const PENALTY_RULES = [
  { emoji:"‚ùå", title:"–ü—Ä–æ–≤–∞–ª–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞", desc:"‚àí5% –∑–∞ –∫–∞–∂–¥—ã–π —Ñ–µ–π–ª; –º–∞–∫—Å–∏–º—É–º ‚àí30% –∑–∞ –¥–µ–Ω—å.", kind:"pct", per:-5, max:-30 },
  { emoji:"üìµ", title:"–ò–≥–Ω–æ—Ä –Ω—É–¥–∂–∞", desc:"‚àí1% –∑–∞ –∏–≥–Ω–æ—Ä; –º–∞–∫—Å–∏–º—É–º ‚àí10% –∑–∞ –¥–µ–Ω—å.", kind:"pct", per:-1, max:-10 },
  { emoji:"‚è∞", title:"–†–µ–∂–∏–º –Ω–∞—Ä—É—à–µ–Ω", desc:"–ü–æ–∑–¥–Ω–∏–π –ø–æ–¥—ä—ë–º –∏–ª–∏ –æ—Ç–±–æ–π: ‚àí10% –∫–∞–∂–¥–æ–µ (–¥–æ ‚àí20% –∑–∞ –¥–µ–Ω—å).", kind:"pct", per:-10, max:-20 },
  { emoji:"üéØ", title:"–ù–µ—Ç —à–∞–≥–æ–≤ –∫ —Ü–µ–ª–∏", desc:"–ï—Å–ª–∏ –Ω–µ –±—ã–ª–æ –∑–∞–¥–∞—á –ø–æ —Ü–µ–ª–∏ (–Ω–µ –≤–æ–ª—è/–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å): —Ñ–∏–∫—Å ‚àí300 üé¥.", kind:"fixed", per:-300, max:-300 },
  { emoji:"ü™´", title:"–ü—É—Å—Ç–æ–π –¥–µ–Ω—å", desc:"–ï—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ –±—ã–ª–æ –≤–æ–≤—Å–µ: —Ñ–∏–∫—Å ‚àí500 üé¥.", kind:"fixed", per:-500, max:-500 },
];

function fmtPct(n){ return (n>0?`+${n}`:`${n}`) + "%"; }
function fmtFixed(n){ return (n>0?`+${n}`:`${n}`) + " üé¥"; }
function cellFmt(kind, v){
  if (v === null || v === undefined) return "‚Äî";
  if (kind === "fixed") return fmtFixed(v);
  if (typeof v === "string") return v;
  return fmtPct(v);
}
function renderRuleList(tableEl, rules, isBonus){
  tableEl.querySelectorAll('.rule-row').forEach(n=>n.remove());
  rules.forEach(r=>{
    const row = document.createElement('div');
    row.className = 'rule-row' + (r.streak?' streak':'');
    const isGood = r.kind==="fixed" ? (r.per>0) : (typeof r.per==="number" ? r.per>0 : true);
    const perClass = r.kind==="fixed" ? (r.per<0?'bad':'good') : (typeof r.per==="number" ? (r.per<0?'bad':'good') : '');
    const maxVal = r.max;
    const maxClass = (typeof maxVal==="number") ? (maxVal<0?'bad':'good') : '';
    row.innerHTML = `
      <div class="rule-name">
        <div class="ttl">${r.emoji} ${r.title}</div>
        <div class="desc">${r.desc}</div>
      </div>
      <div class="rule-per ${perClass}">${cellFmt(r.kind, r.per)}</div>
      <div class="rule-max ${maxClass}">${cellFmt(r.kind, r.max)}</div>
    `;
    tableEl.appendChild(row);
  });
}
function renderBonusesScreen(){
  const bt = $('bonus-table'), pt = $('penalty-table');
  if (bt && pt){
    renderRuleList(bt, BONUS_RULES, true);
    renderRuleList(pt, PENALTY_RULES, false);
    const bonusSum = BONUS_RULES
      .filter(r=>r.kind==='pct' && typeof r.max==="number" && !r.streak)
      .reduce((s,r)=>s+(r.max>0?r.max:0),0);
    const penSumPct = PENALTY_RULES
      .filter(r=>r.kind==='pct' && typeof r.max==="number")
      .reduce((s,r)=>s+(r.max<0?r.max:0),0);
    $('bonus-total').textContent   = `–ò—Ç–æ–≥–æ –º–∞–∫—Å–∏–º—É–º –±–æ–Ω—É—Å–æ–≤ (–±–µ–∑ —Å–µ—Ä–∏–π): ${fmtPct(bonusSum)}`;
    $('penalty-total').textContent = `–ú–∞–∫—Å–∏–º—É–º —à—Ç—Ä–∞—Ñ–æ–≤ (–ø—Ä–æ—Ü.): ${fmtPct(penSumPct)}; —Ñ–∏–∫—Å: ‚àí800 üé¥`;
  }
}

/* ====== –¢–µ–º–∞/–±–∞–ª–∞–Ω—Å/–º—É–¥ ====== */
function applyTheme(){
  const scheme = tg?.colorScheme ?? 'light';
  const set = (k,v)=>document.documentElement.style.setProperty(k,v);
  if(scheme==='dark'){
    set('--bg','#0f1115'); set('--card','#161923'); set('--text','#e9eef6'); set('--muted','#9aa4b2'); set('--border','#232838'); set('--surface','#10141e'); set('--accent','#4f8cff'); set('--btn-bg','var(--surface)'); set('--btn-fg','var(--text)'); set('--input-bg','#0e1118'); set('--input-fg','var(--text)');
  } else {
    set('--bg','#f6f8fc'); set('--card','#ffffff'); set('--text','#0b1220'); set('--muted','#5b6676'); set('--border','#e6e9f2'); set('--surface','#f1f4fa'); set('--accent','#4f8cff'); set('--btn-bg','var(--surface)'); set('--btn-fg','var(--text)'); set('--input-bg','#fbfcff'); set('--input-fg','var(--text)');
  }
  if(tg?.themeParams?.button_color){ set('--accent', tg.themeParams.button_color); }
}
function renderBalanceBadge(){
  $('balance-total').textContent = `${fmtInt(balanceTotal)} üé¥`;
  const d = $('balance-delta');
  if (balanceToday > 0){ d.textContent = `+${fmtInt(balanceToday)}`; d.className = 'delta pos'; }
  else if (balanceToday < 0){ d.textContent = `${fmtInt(balanceToday)}`; d.className = 'delta neg'; }
  else { d.textContent = '0'; d.className = 'delta zero'; }
}
function setMoodColor(){
  const c = (MOOD[moodLevel] || MOOD[0]).color;
  document.documentElement.style.setProperty('--mood', c);
}

/* ====== –≠–∫—Ä–∞–Ω—ã ====== */
function showScreen(name){
  ['home','settings','schedule','goal','task','info','stats-mood','stats-day','bonuses','deps','deps-add'].forEach(id=>{
    $(`screen-${id}`).classList.toggle('hidden', id!==name);
  });
  const card = $('card');
  card.classList.add('swap'); setTimeout(()=>card.classList.remove('swap'), 180);
  document.body.classList.toggle('mood-on', name==='stats-mood');

  if(!tg) return;
  if(name==='schedule'){ tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å'); updateMainButtonSchedule(); }
  else if(name==='goal'){ tg.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'); updateMainButtonGoal(); }
  else if(name==='deps-add'){ tg.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'); updateMainButtonDep(); }
  else if(name==='task'){ tg.MainButton.setText('–°–æ–∑–¥–∞—Ç—å'); updateMainButtonTask(); }
  else { tg.MainButton.hide(); }

  if(name==='stats-mood'){
    const m = MOOD[moodLevel] || MOOD[0];
    $('mood-emoji').textContent = m.emoji;
    $('mood-title').textContent = m.title;
    $('mood-desc').textContent  = m.desc;
    setMoodColor();
  }
  if(name==='stats-day'){ renderDaySummary(); }
  if(name==='bonuses'){ renderBonusesScreen(); }
  if(name==='deps'){ renderDepsList(); }
  if(name==='task'){ renderDepPicker(); }
}

/* ====== –ò—Ç–æ–≥–∏ –¥–Ω—è ====== */
function renderDaySummary(){
  const cur = balanceTotal;
  const delta = balanceToday;
  const nxt = cur + delta;
  $('sum-current').textContent = `${fmtInt(cur)} üé¥`;
  $('sum-next').textContent    = `${fmtInt(nxt)} üé¥`;
  const db = $('sum-delta');
  if (delta > 0) { db.textContent = `+${fmtInt(delta)}`; db.className = 'delta-badge pos'; }
  else if (delta < 0){ db.textContent = `${fmtInt(delta)}`; db.className = 'delta-badge neg'; }
  else { db.textContent = '0'; db.className = 'delta-badge zero'; }
}

/* ====== –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: UI ====== */
function fmtRu(x){ return new Intl.NumberFormat('ru-RU',{minimumFractionDigits:1,maximumFractionDigits:1}).format(x); }
function renderDepsList(){
  const box = $('deps-list'); box.innerHTML = '';
  if (!deps.length){
    box.innerHTML = `<div class="dep-empty">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å üëá</div>`;
    return;
  }
  deps.forEach(d=>{
    const el = document.createElement('div');
    el.className = 'dep-item';
    el.innerHTML = `<span class="name">${d.name}</span><span class="sev-pill">—É—Ä–æ–≤–µ–Ω—å: ${fmtRu(d.sev)}</span>`;
    box.appendChild(el);
  });
}
function renderDepPicker(){
  const wrap = $('dep-picker-wrap'), chips = $('dep-chips');
  if (mode!=='addiction'){ wrap.classList.add('hidden'); return; }
  wrap.classList.remove('hidden');
  chips.innerHTML = '';
  if (!deps.length){
    $('dep-picker-hint').classList.remove('hidden');
    return;
  }
  $('dep-picker-hint').classList.add('hidden');
  deps.forEach(d=>{
    const chip = document.createElement('div');
    chip.className = 'dep-chip' + (selectedDepId===d.id?' active':'');
    chip.textContent = d.name;
    chip.addEventListener('click', ()=>{
      selectedDepId = d.id;
      // —Å–ª–∞–π–¥–µ—Ä ‚Üí –±–∞–∑–æ–≤–∞—è —Å–∏–ª–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      const r = $('importanceRange');
      r.value = String(d.sev);
      updateSliderUI();
      // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
      renderDepPicker();
    });
    chips.appendChild(chip);
  });
}

/* ====== –í–∞–∂–Ω–æ—Å—Ç—å/—Ä–µ–∂–∏–º—ã/—Å–ª–∞–π–¥–µ—Ä ====== */
function updateMainButtonSchedule(){ if(!tg) return; const ok = isValidTime($('sleep').value||'') && isValidTime($('wake').value||''); tg.MainButton[ok?'show':'hide'](); }
function updateMainButtonGoal(){ if(!tg) return; const ok = ( $('goal').value||'' ).trim().length>0; tg.MainButton[ok?'show':'hide'](); }
function updateMainButtonDep(){ if(!tg) return; const ok = ( $('dep-name').value||'' ).trim().length>0; tg.MainButton[ok?'show':'hide'](); }
function updateMainButtonTask(){
  if(!tg) return;
  const hasText = ( $('action').value||'' ).trim().length>0;
  let ok = hasText;
  if (mode==='addiction'){
    ok = ok && !!selectedDepId; // –Ω–∞–¥–æ –≤—ã–±—Ä–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
  }
  tg.MainButton[ ok ? 'show' : 'hide' ]();
}

function setMode(newMode){
  if (newMode === mode) {
    mode = 'normal';
    $('chip-will').classList.remove('active');
    $('chip-add').classList.remove('active');
  } else {
    mode = newMode;
    $('chip-will').classList.toggle('active', mode==='willpower');
    $('chip-add').classList.toggle('active', mode==='addiction');
  }
  updateScaleLabels();
  renderDepPicker();
  updateSliderUI();
  updateMainButtonTask();
}
function updateScaleLabels(){
  const lblMin = $('lbl-min'), lblMax = $('lbl-max'), title = $('scale-title');
  if (mode === 'willpower'){
    lblMin.textContent = '–ü—Ä–æ—Å—Ç–æ–µ'; lblMax.textContent = '–ú—É—á–∏—Ç–µ–ª—å–Ω–æ–µ';
    title.textContent = '–°–∏–ª–∞ –≤–æ–ª–∏ ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ —Ç—è–∂–µ–ª–æ';
    $('task-hint').textContent = '–°–∏—Å—Ç–µ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ‚Üí —Å–æ–∑–¥–∞—Ç—å –∏ —Å—Ä–∞–∑—É –æ—Ç–º–µ—Ç–∏—Ç—å –≤ —á–∞—Ç–µ –ø–æ–∑–∂–µ.';
  } else if (mode === 'addiction'){
    lblMin.textContent = '–ë–∞–ª—É—é—Å—å'; lblMax.textContent = '–°–µ—Ä—å—ë–∑–Ω–æ –∑–∞–≤–∏—Å–∏–º';
    title.textContent = '–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å ‚Äî –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ç—è–≥–∏ (–º–æ–∂–µ—à—å –ø–æ–ø—Ä–∞–≤–∏—Ç—å)';
    $('task-hint').textContent = '–í—ã–±–µ—Ä–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –æ—Ç—Ä–µ–≥—É–ª–∏—Ä—É–π —É—Ä–æ–≤–µ–Ω—å –∏ —Å–æ–∑–¥–∞–π. –û—Ç–º–µ—Ç–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–µ—á–µ—Ä–æ–º.';
  } else {
    lblMin.textContent = '–ö–æ—Å–≤–µ–Ω–Ω–æ–µ'; lblMax.textContent = '–ü—Ä—è–º–æ–µ';
    title.textContent = '–í–ª–∏—è–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —Ü–µ–ª—å';
    $('task-hint').textContent = '–°–∏—Å—Ç–µ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ‚Üí —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É.';
  }
}
function colorForValue(val){
  const t = Math.min(1, Math.max(0, (val - 0.1) / (3 - 0.1)));
  if (mode === 'willpower'){
    const start = [79,140,255], end = [192,72,255];
    const r = Math.round(start[0] + (end[0]-start[0])*t);
    const g = Math.round(start[1] + (end[1]-start[1])*t);
    const b = Math.round(start[2] + (end[2]-start[2])*t);
    return `rgb(${r} ${g} ${b})`;
  } else if (mode === 'addiction'){
    const start = [255,170,54], end = [255,77,79];
    const r = Math.round(start[0] + (end[0]-start[0])*t);
    const g = Math.round(start[1] + (end[1]-start[1])*t);
    const b = Math.round(start[2] + (end[2]-start[2])*t);
    return `rgb(${r} ${g} ${b})`;
  } else {
    const start = [64,199,129], end = [79,140,255];
    const r = Math.round(start[0] + (end[0]-start[0])*t);
    const g = Math.round(start[1] + (end[1]-start[1])*t);
    const b = Math.round(start[2] + (end[2]-start[2])*t);
    return `rgb(${r} ${g} ${b})`;
  }
}
function updateSliderUI(){
  const r = $('importanceRange'); if(r){
    const v = parseFloat(r.value||'1') || 1;
    const p = ((v - 0.1) / (3 - 0.1)) * 100;
    const color = colorForValue(v);
    r.style.setProperty('--val', `${p}%`);
    document.documentElement.style.setProperty('--meter', color);
    $('imp-pill').textContent = fmtRu(v);
  }
  const rd = $('dep-range'); if (rd){
    const v = parseFloat(rd.value||'1') || 1;
    const p = ((v - 0.1) / (3 - 0.1)) * 100;
    const color = colorForValue(v);
    rd.style.setProperty('--val', `${p}%`);
    document.documentElement.style.setProperty('--meter', color);
    $('dep-imp-pill').textContent = fmtRu(v);
  }
}

/* ====== bind/init/send ====== */
function bind(){
  // –ù–∞–≤–∏–≥–∞—Ü–∏—è
  $('btn-settings')?.addEventListener('click', ()=>showScreen('settings'));
  $('btn-task')?.addEventListener('click', ()=>showScreen('task'));
  $('btn-info')?.addEventListener('click', ()=>showScreen('info'));
  $('back-from-info')?.addEventListener('click', ()=>showScreen('home'));

  $('btn-info-day')?.addEventListener('click', ()=>showScreen('stats-day'));
  $('btn-info-mood')?.addEventListener('click', ()=>showScreen('stats-mood'));
  $('btn-info-bonuses')?.addEventListener('click', ()=>showScreen('bonuses'));
  $('back-from-bonuses')?.addEventListener('click', ()=>showScreen('info'));

  $('btn-day-details')?.addEventListener('click', ()=>{
    try { tg?.HapticFeedback?.impactOccurred('heavy'); } catch {}
    try { tg?.sendData(JSON.stringify({ request: 'day_details' })); } catch(e){ console.error(e); }
    setTimeout(()=>tg?.close?.(), 120);
  });

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
  $('btn-edit-schedule')?.addEventListener('click', ()=>showScreen('schedule'));
  $('btn-edit-goal')?.addEventListener('click', ()=>showScreen('goal'));
  $('back-from-settings')?.addEventListener('click', ()=>showScreen('home'));

  // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
  $('btn-dependencies')?.addEventListener('click', ()=>showScreen('deps'));
  $('back-from-deps')?.addEventListener('click', ()=>showScreen('settings'));
  $('btn-dep-add')?.addEventListener('click', ()=>showScreen('deps-add'));
  $('back-from-deps-add')?.addEventListener('click', ()=>showScreen('deps'));
  $('dep-name')?.addEventListener('input', updateMainButtonDep);

  // –ü–æ–ª—è
  $('sleep')?.addEventListener('input', updateMainButtonSchedule);
  $('wake')?.addEventListener('input', updateMainButtonSchedule);
  $('goal')?.addEventListener('input', updateMainButtonGoal);
  $('action')?.addEventListener('input', updateMainButtonTask);

  // –†–µ–∂–∏–º—ã
  $('chip-will')?.addEventListener('click', ()=>setMode('willpower'));
  $('chip-add')?.addEventListener('click',  ()=>setMode('addiction'));

  // –°–ª–∞–π–¥–µ—Ä—ã
  $('importanceRange')?.addEventListener('input', ()=>{ updateSliderUI(); updateMainButtonTask(); });
  $('dep-range')?.addEventListener('input', updateSliderUI);
}

function sendPayload(){
  const payload = {};
  payload.tz_offset_min = new Date().getTimezoneOffset();

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
  if(!$('screen-schedule').classList.contains('hidden')){
    const st=$('sleep').value, wt=$('wake').value;
    if(!isValidTime(st)||!isValidTime(wt)) return;
    payload.sleep_time=st; payload.wake_time=wt;
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–ª–∏
  if(!$('screen-goal').classList.contains('hidden')){
    const g=($('goal').value||'').trim(); if(!g) return; payload.goal=g;
  }

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
  if(!$('screen-deps-add').classList.contains('hidden')){
    const name = ($('dep-name').value||'').trim(); if(!name) return;
    const sev = parseFloat($('dep-range').value||'1') || 1;
    const dep = { id: crypto.randomUUID?.() || ('dep-'+Date.now()), name, sev };
    // –ª–æ–∫–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–º –∏ –≤ CS
    deps.push(dep);
    try { cs.set('deps', JSON.stringify(deps)); } catch {}
    // –≤ –±–æ—Ç ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
    payload.cmd = "save_dependency";
    payload.dependency = dep;
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
  if(!$('screen-task').classList.contains('hidden')){
    const a=($('action').value||'').trim(); if(!a) return;
    const goalText=($('goal-view').textContent||'').trim();
    const range = $('importanceRange');
    const val = parseFloat(range.value||'1') || 1;
    const valInt = Math.min(3, Math.max(1, Math.round(val)));

    payload.task           = `–Ø ${a} —Ä–∞–¥–∏ ${goalText}`;
    payload.importance     = valInt;
    payload.importance_f   = val;
    payload.importance_ru  = fmtRu(val);
    payload.mode           = mode;
    payload.willpower      = (mode==='willpower');
    payload.addiction      = (mode==='addiction');

    if (mode==='addiction'){
      // –ø—Ä–∏–∫—Ä–µ–ø–∏–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
      const dep = deps.find(d=>d.id===selectedDepId);
      if (!dep){ return; }
      payload.addiction_dep = { id: dep.id, name: dep.name, base_sev: dep.sev };
      payload.deferred = true; // –ø–æ–ø—Ä–æ—Å–∏–º –±—ç–∫–µ–Ω–¥ –æ—Ç–ª–æ–∂–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É –¥–æ –≤–µ—á–µ—Ä–∞
    }
  }

  try { tg?.sendData(JSON.stringify(payload)); } catch(e){ console.error(e); }
  try { tg?.HapticFeedback?.notificationOccurred('success'); } catch {}
  setTimeout(()=>tg?.close?.(), 120);
}

/* ====== hydrate ====== */
async function hydrate(){
  const p = new URLSearchParams(location.search);
  const b  = p.get('b'),  bt = p.get('bt');
  const m  = p.get('m'),  g  = p.get('g') || p.get('goal');
  const n  = p.get('name');
  let changed = false;
  if (b  !== null) { balanceTotal = parseInt(b,10) || 0; changed = true; }
  if (bt !== null) { balanceToday = parseInt(bt,10) || 0; changed = true; }
  if (m  !== null) { moodLevel    = clampMood(m);        changed = true; }
  if (g)           { userGoal     = g.trim();             changed = true; }
  if (n)           { userName     = n.trim();             changed = true; }

  // deps –∏–∑ CloudStorage
  try {
    const raw = await cs.get('deps');
    if (raw){
      try { deps = JSON.parse(raw) || []; } catch { deps = []; }
    }
  } catch {}

  if (!changed && tg?.CloudStorage){
    const [cb, cbt, cm, cg, cn] = await Promise.all([
      cs.get('b'), cs.get('bt'), cs.get('m'), cs.get('g'), cs.get('name')
    ]);
    if (cb  != null) balanceTotal = parseInt(cb,10)  || 0;
    if (cbt != null) balanceToday = parseInt(cbt,10) || 0;
    if (cm  != null) moodLevel    = clampMood(cm);
    if (cg) userGoal = cg;
    if (cn) userName = cn;
  }
  if (changed && tg?.CloudStorage){
    await Promise.allSettled([
      cs.set('b', balanceTotal), cs.set('bt', balanceToday),
      cs.set('m', moodLevel), cs.set('g', userGoal || ''), cs.set('name', userName || '')
    ]);
  }
}

/* ====== init ====== */
async function init(){
  tg?.ready(); tg?.expand(); applyTheme(); tg?.onEvent('themeChanged', applyTheme);
  await hydrate();
  renderBalanceBadge(); setMoodColor();

  if (userGoal && $('goal-view')) { $('goal-view').textContent = userGoal; }

  bind(); updateScaleLabels(); updateSliderUI();

  const params = new URLSearchParams(location.search);
  let screen = (params.get('screen') || 'home').toLowerCase();

  const sp = tg?.initDataUnsafe?.start_param;
  if (sp && typeof sp === 'string') {
    const usp = new URLSearchParams(sp);
    screen = (usp.get('screen') || screen || 'home').toLowerCase();
    if (!userGoal) {
      const g2 = usp.get('g') || usp.get('goal');
      if (g2 && $('goal-view')) { $('goal-view').textContent = g2; }
    }
  }

  if      (screen==='schedule')   showScreen('schedule');
  else if (screen==='goal')       showScreen('goal');
  else if (screen==='task')       showScreen('task');
  else if (screen==='info')       showScreen('info');
  else if (screen==='stats-day')  showScreen('stats-day');
  else if (screen==='stats_mood' || screen==='mood') showScreen('stats-mood');
  else if (screen==='bonuses')    showScreen('bonuses');
  else if (screen==='deps')       showScreen('deps');
  else if (screen==='deps-add')   showScreen('deps-add');
  else                            showScreen('home');

  tg?.onEvent('mainButtonClicked', sendPayload);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
