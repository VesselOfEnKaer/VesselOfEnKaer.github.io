<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>ForHer ‚Äî –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg:#0f1115; --card:#161923; --text:#e9eef6; --muted:#9aa4b2; --border:#232838;
  --surface:#10141e; --accent:#4f8cff; --radius:16px;
  --good:#20c997; --bad:#ff4d4f; --warn:#ff9f43;
}
@media (prefers-color-scheme: light){
:root{
  --bg:#f6f8fc; --card:#ffffff; --text:#0b1220; --muted:#5b6676; --border:#e6e9f2;
  --surface:#f1f4fa; --accent:#4f8cff;
}}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
.wrap{min-height:100%;display:grid;place-items:center;padding:24px;position:relative;overflow:hidden}
.card{
  width:min(560px,92vw);padding:clamp(14px,4vw,20px);
  background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:0 8px 32px rgba(0,0,0,.12);overflow:hidden;position:relative;
  transition:transform .18s ease, opacity .18s ease; z-index:2; margin-inline:auto;
}
h1{margin:0 0 12px;font-size:22px}
p{margin:0 0 18px;color:var(--muted)}
.grid{display:grid;gap:12px;width:100%}
.hidden{display:none}

/* –∫–Ω–æ–ø–∫–∏ –∏ –ø—Ä–æ—á–µ–µ (–∫–∞–∫ –±—ã–ª–æ) */
.menu-btn{
  display:flex;align-items:center;justify-content:space-between;width:100%;padding:14px 16px;
  font-size:16px;border-radius:12px;background:var(--surface);color:var(--text);
  border:1px solid var(--border);cursor:pointer;transition:transform .08s ease, background .2s ease, box-shadow .2s ease;
  box-shadow:0 1px 0 rgba(0,0,0,.04) inset; -webkit-tap-highlight-color: transparent;
}
.menu-btn:active{ transform:scale(.98) }

/* –±–µ–π–¥–∂ –±–∞–ª–∞–Ω—Å–∞ */
.balance-badge{
  position:fixed; top:10px; right:12px; z-index:20;
  padding:8px 12px; border-radius:12px;
  background:rgba(255,255,255,.06); backdrop-filter:blur(6px);
  color:var(--text); border:1px solid var(--border);
  font-weight:800; font-size:14px; line-height:1;
  display:flex; align-items:baseline; gap:6px;
}
.balance-badge .delta{ font-size:11px; font-weight:800 }
.balance-badge .delta.pos{ color:var(--good) }
.balance-badge .delta.neg{ color:var(--bad) }
.balance-badge .delta.zero{ color:var(--muted) }

/* ====== –ú–ê–ì–ê–ó–ò–ù ====== */
.shop-top{display:flex;align-items:center;gap:10px}
.shop-cats{ display:flex; gap:8px; flex-wrap:wrap; margin-top:2px }
.shop-chip{
  padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:var(--surface);
  cursor:pointer; user-select:none; font-size:13px; transition:.15s; white-space:nowrap;
}
.shop-chip.active{ background:var(--card); border-color:var(--accent); box-shadow:0 0 0 4px rgb(79 140 255 / 12%) }

/* –°–µ—Ç–∫–∞: –≤—Å–µ–≥–¥–∞ 2 –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Ä—è–¥ */
.shop-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px }
@media (max-width:360px){ .shop-grid{ gap:10px } }

/* –ö–∞—Ä—Ç–æ—á–∫–∞ c –≥–ª—É–±–∏–Ω–æ–π */
.shop-card{
  display:grid; grid-template-rows:auto auto auto auto; gap:6px;
  background:linear-gradient(180deg, color-mix(in srgb, var(--card) 94%, transparent), var(--card));
  border:1px solid color-mix(in srgb, var(--border) 80%, transparent);
  border-radius:16px; overflow:hidden; position:relative;
  box-shadow:
    0 1px 0 rgba(255,255,255,.05) inset,
    0 10px 24px rgba(0,0,0,.20), 0 2px 8px rgba(0,0,0,.18);
  cursor:pointer; transition:transform .08s ease, box-shadow .12s ease, border-color .2s ease;
}
.shop-card::after{
  content:""; position:absolute; inset:-25% -25% auto -25%; height:55%;
  background:radial-gradient(50% 100% at 50% 0%, rgba(79,140,255,.25), transparent 70%);
  filter:blur(20px); opacity:.35; pointer-events:none;
}
.shop-card:hover{ transform:translateY(-2px); box-shadow:0 12px 28px rgba(0,0,0,.28), 0 3px 10px rgba(0,0,0,.22) }
.shop-card:active{ transform:translateY(0); }

/* –æ–±–ª–æ–∂–∫–∞ */
.shop-img{ width:100%; aspect-ratio:16/9; object-fit:cover; background:var(--surface) }

/* —Ç–µ–∫—Å—Ç—ã */
.shop-title{ font-size:15px; font-weight:900; padding:0 12px; margin-top:6px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap }
.shop-sub{ font-size:12px; color:var(--muted); padding:0 12px; min-height:2lh;
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
.shop-price{ font-weight:900; padding:10px 12px 12px; display:flex; justify-content:flex-start; align-items:center; gap:8px; }

/* –°–∫–µ–ª–µ—Ç–æ–Ω—ã */
@keyframes shimmer{ 0%{background-position:-200% 0} 100%{background-position:200% 0} }
.sk{
  border-radius:14px; border:1px solid var(--border); overflow:hidden;
  background:var(--card); box-shadow:0 8px 24px rgba(0,0,0,.18);
}
.sk-img, .sk-line, .sk-price{
  background:linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.14), rgba(255,255,255,.04));
  background-size:200% 100%; animation:shimmer 1.2s infinite;
}
.sk-img{ width:100%; aspect-ratio:16/9 }
.sk-body{ padding:10px 12px 12px; display:grid; gap:8px }
.sk-line{ height:12px; border-radius:8px }
.sk-price{ height:18px; width:40%; border-radius:10px }

/* –æ—Å—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ –æ–ø—É—â–µ–Ω–∞ —Ä–∞–¥–∏ –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ ‚Äî –≤—Å—ë –æ—Å—Ç–∞–ª–æ—Å—å –∫–∞–∫ –±—ã–ª–æ */
</style>
</head>
<body>
<div class="balance-badge" id="balance-badge">
  <span id="balance-total">0 üé¥</span>
  <span id="balance-delta" class="delta zero">0</span>
</div>

<div class="wrap">
  <div class="card" id="card">
    <!-- HOME -->
    <section id="screen-home" class="grid">
      <h1>üè† –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h1>
      <p>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ForHer. v0.60</p>
      <button class="menu-btn" id="btn-settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-task">‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-shop">üõí –ú–∞–≥–∞–∑–∏–Ω <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-info">‚ÑπÔ∏è –ò–Ω—Ñ–æ <span>‚Ä∫</span></button>
    </section>

    <!-- SETTINGS / TASK / INFO / etc. (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->

    <!-- SHOP (list) -->
    <section id="screen-shop" class="grid hidden">
      <div class="topbar">
        <button class="menu-btn" id="back-from-shop" style="width:auto;padding:8px 12px">‚Üê –ù–∞–∑–∞–¥</button>
        <h1 style="margin:0">üõí –ú–∞–≥–∞–∑–∏–Ω</h1>
      </div>
      <div class="shop-cats" id="shop-cats"></div>
      <div class="divider" style="height:1px;background:var(--border)"></div>
      <div class="shop-grid" id="shop-grid"></div>
    </section>

    <!-- SHOP (item) -->
    <section id="screen-shop-item" class="grid hidden">
      <div class="topbar">
        <button class="menu-btn" id="back-from-item" style="width:auto;padding:8px 12px">‚Üê –ú–∞–≥–∞–∑–∏–Ω</button>
        <h1 id="item-title" style="margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">–¢–æ–≤–∞—Ä</h1>
      </div>
      <img id="item-img" class="shop-img" alt="cover" />
      <div style="display:flex;gap:8px;align-items:center;padding:0 2px">
        <span id="item-price" style="font-weight:900;font-size:18px">0 üé¥</span>
        <span id="item-cat" style="font-size:12px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--surface);color:var(--muted)">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
      </div>
      <div id="item-desc" style="font-size:14px"></div>
      <div id="item-botdesc" style="font-size:12px;color:var(--muted)"></div>
      <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É ¬´–ö—É–ø–∏—Ç—å¬ª, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É –≤ –±–æ—Ç–∞.</div>
    </section>
  </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
const $  = (id) => document.getElementById(id);

// ====== STATE ======
let balanceTotal = 0, balanceToday = 0, moodLevel=0, userGoal='', userName='';
let DEPS=[], mode='normal', selectedDepId=null;
let SHOP=[], SHOP_CATS=[], SHOP_SELECTED=new Set(), CUR_PRODUCT=null;
let PRICE_OVERRIDES = {};

// ====== HELPERS ======
const cs = {
  get: (k) => new Promise(res => tg?.CloudStorage?.getItem?.(k, v => res(v))),
  set: (k, v) => new Promise(res => tg?.CloudStorage?.setItem?.(k, String(v), () => res(true)))
};
const fmtInt = (n)=> new Intl.NumberFormat('ru-RU').format(Math.max(0, Math.round(Number(n)||0)));
const parsePrice = (x)=>{
  if (x===null||x===undefined||x==='') return NaN;
  const v = Number(String(x).replace(',', '.'));
  return Number.isFinite(v) ? v : NaN;
};
const priceFor = (p)=>{
  const base = parsePrice(p?.price_base ?? p?.price ?? p?.base_price);
  const ovr  = parsePrice(PRICE_OVERRIDES?.[p?.id]);
  const n = Number.isNaN(ovr) ? base : ovr;
  return Number.isNaN(n) ? 0 : Math.max(0, Math.round(n));
};
function b64urlToJson(b64){
  try{ const norm=b64.replace(/-/g,'+').replace(/_/g,'/'); return JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(norm),c=>c.charCodeAt(0)))); }catch{ return null; }
}

// ====== SHOP ======
async function loadShop(){
  const ver = new URLSearchParams(location.search).get('v') || 'v1';
  const r = await fetch(`shop.json?v=${encodeURIComponent(ver)}`, { cache:'no-store' });
  if (!r.ok) throw new Error('http '+r.status);
  const arr = await r.json();
  SHOP = (Array.isArray(arr)?arr:[]).filter(p=>p && p.active!==false);
  SHOP_CATS = Array.from(new Set(SHOP.map(p=>p.category).filter(Boolean)));
}
function renderShopCats(){
  const box = $('shop-cats'); if(!box) return;
  box.innerHTML = '';
  const all = document.createElement('div');
  all.className = 'shop-chip' + (SHOP_SELECTED.size===0?' active':''); all.textContent='–í—Å–µ';
  all.onclick = ()=>{ SHOP_SELECTED.clear(); renderShopCats(); renderShopGrid(); };
  box.appendChild(all);
  SHOP_CATS.forEach(cat=>{
    const chip = document.createElement('div');
    chip.className = 'shop-chip' + (SHOP_SELECTED.has(cat)?' active':''); chip.textContent = cat;
    chip.onclick = ()=>{ SHOP_SELECTED.has(cat)?SHOP_SELECTED.delete(cat):SHOP_SELECTED.add(cat); renderShopCats(); renderShopGrid(); };
    box.appendChild(chip);
  });
}
function filteredProducts(){ return SHOP_SELECTED.size? SHOP.filter(p=>SHOP_SELECTED.has(p.category)) : SHOP; }

// skeletons
function renderSkeletonGrid(n){
  const grid = $('shop-grid'); if(!grid) return;
  grid.innerHTML='';
  for(let i=0;i<n;i++){
    const sk = document.createElement('div');
    sk.className='sk';
    sk.innerHTML = `
      <div class="sk-img"></div>
      <div class="sk-body">
        <div class="sk-line" style="width:70%"></div>
        <div class="sk-line" style="width:90%"></div>
        <div class="sk-price"></div>
      </div>`;
    grid.appendChild(sk);
  }
}

function preload(src){
  return new Promise((resolve)=>{
    const img=new Image();
    img.onload = ()=>resolve(true);
    img.onerror= ()=>resolve(false);
    img.src = src;
  });
}

async function renderShopGrid(){
  const grid = $('shop-grid'); if(!grid) return;
  const list = filteredProducts();
  if (!list.length){ grid.innerHTML = '<div class="menu-btn" style="justify-content:center">–ü—É—Å—Ç–æ</div>'; return; }

  // —Ä–∏—Å—É–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫
  renderSkeletonGrid(list.length);

  // –ø–æ –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏ ‚Äî –∂–¥—ë–º –∑–∞–≥—Ä—É–∑–∫—É –æ–±–ª–æ–∂–∫–∏, –∑–∞—Ç–µ–º –ø–æ–¥–º–µ–Ω—è–µ–º —Å–∫–µ–ª–µ—Ç–æ–Ω –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É
  const tasks = list.map(async (p, idx)=>{
    const ok = await preload(p.image);
    const price = priceFor(p);
    const card = document.createElement('div');
    card.className = 'shop-card';
    card.innerHTML = `
      <img class="shop-img" src="${p.image}" alt="" ${ok?'':'style="opacity:.85"'} />
      <div class="shop-title">${p.title}</div>
      <div class="shop-sub">${p.short || p.subtitle || ''}</div>
      <div class="shop-price">${fmtInt(price)} üé¥</div>
    `;
    card.onclick = ()=>openProduct(p);
    const sk = grid.children[idx];
    if (sk) sk.replaceWith(card);
  });
  await Promise.all(tasks);
}

function openProduct(p){
  CUR_PRODUCT = p;
  $('item-title').textContent = p.title || '–¢–æ–≤–∞—Ä';
  $('item-img').src = p.image;
  $('item-price').textContent = `${fmtInt(priceFor(p))} üé¥`;
  $('item-cat').textContent = p.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
  $('item-desc').innerHTML = (p.description||'').replace(/\n/g,'<br>');
  $('item-botdesc').textContent = p.bot_description || '';
  showScreen('shop-item');
  updateMainButtonShopItem(true);
}
function updateMainButtonShopItem(show){
  if(!tg) return;
  if (!CUR_PRODUCT){ tg.MainButton.hide(); return; }
  tg.MainButton.setText(`–ö—É–ø–∏—Ç—å –∑–∞ ${fmtInt(priceFor(CUR_PRODUCT))} üé¥`);
  if (show) tg.MainButton.show();
}
function purchaseCurrentProduct(){
  if (!CUR_PRODUCT) return;
  const price = fmtInt(priceFor(CUR_PRODUCT));
  const ok = confirm(`–ö—É–ø–∏—Ç—å ¬´${CUR_PRODUCT.title}¬ª –∑–∞ ${price} üé¥?`);
  if (!ok) return;
  try { tg?.sendData(JSON.stringify({ shop_buy:{ id:String(CUR_PRODUCT.id) } })); } catch(e){}
  try { tg?.HapticFeedback?.notificationOccurred('success'); } catch {}
  setTimeout(()=>tg?.close?.(), 120);
}

// ====== NAV / INIT (—É—Ä–µ–∑–∞–Ω–æ –¥–æ –Ω—É–∂–Ω–æ–≥–æ) ======
function showScreen(name){
  ['home','shop','shop-item'].forEach(id=>{ const el=$(`screen-${id}`); if(el) el.classList.toggle('hidden', id!==name); });
  if (name==='shop'){ renderShopCats(); renderSkeletonGrid(6); loadShop().then(renderShopGrid).catch(e=>{ $('shop-grid').innerHTML = `<div class="menu-btn" style="justify-content:center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞</div>`; }); tg?.MainButton?.hide(); }
}
function bind(){
  $('btn-shop')?.addEventListener('click', ()=>showScreen('shop'));
  $('back-from-shop')?.addEventListener('click', ()=>showScreen('home'));
  $('back-from-item')?.addEventListener('click', ()=>{ showScreen('shop'); tg?.MainButton?.hide(); });
  tg?.onEvent?.('mainButtonClicked', ()=>{ const onItem=!$('screen-shop-item').classList.contains('hidden'); if(onItem) purchaseCurrentProduct(); });
}
async function hydrate(){
  const p = new URLSearchParams(location.search);
  // —Ü–µ–Ω—ã (override)
  const pb64 = p.get('pricesb64'); const praw = p.get('prices');
  if (pb64){ const j=b64urlToJson(pb64); if(j) PRICE_OVERRIDES=j; }
  else if(praw){ try{ const j=JSON.parse(praw); if(j) PRICE_OVERRIDES=j; }catch{} }
  if (!pb64 && !praw){ const cp = await cs.get('shop_prices'); if (cp){ try{ PRICE_OVERRIDES=JSON.parse(cp)||{} }catch{} } }
}
async function init(){
  tg?.ready(); tg?.expand();
  await hydrate();
  bind();
  showScreen('home');
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
