<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>ForHer ‚Äî –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg:#f6f8fc; --card:#ffffff; --text:#0b1220; --muted:#5b6676; --border:#e6e9f2;
  --surface:#f1f4fa; --accent:#4f8cff; --btn-bg:var(--surface); --btn-fg:var(--text);
  --input-bg:#fbfcff; --input-fg:var(--text);
  --mood:#8aa0b4; --meter:#4f8cff; --radius:16px;
  --good:#20c997; --bad:#ff4d4f; --warn:#ff9f43;
}
@media (prefers-color-scheme: dark){
:root{
  --bg:#0f1115; --card:#161923; --text:#e9eef6; --muted:#9aa4b2; --border:#232838;
  --surface:#10141e; --accent:#4f8cff; --btn-bg:var(--surface); --btn-fg:var(--text);
  --input-bg:#0e1118; --input-fg:var(--text);
}}
*{box-sizing:border-box}
html,body{
  margin:0; padding:0; height:100%;
  background:var(--bg); color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
}
.wrap{
  min-height:100%; display:grid; place-items:center;
  padding:24px; position:relative; overflow:hidden;
}
.card{
  width:min(560px,92vw);
  padding:clamp(14px,4vw,20px);
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:0 8px 32px rgba(0,0,0,.12);
  overflow:hidden; position:relative;
  transition:transform .18s ease, opacity .18s ease;
  z-index:2; margin-inline:auto;
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏, —Ç–µ–∫—Å—Ç */
h1{margin:0 0 12px;font-size:22px;text-align:center;}
p{margin:0 0 18px;color:var(--muted);text-align:center;line-height:1.5;}
.grid{display:grid;gap:14px;width:100%;justify-items:center;}

/* –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é */
.menu-btn{
  display:flex;align-items:center;justify-content:space-between;
  width:100%;padding:14px 16px;font-size:16px;
  border-radius:12px;background:var(--btn-bg);color:var(--btn-fg);
  border:1px solid var(--border);cursor:pointer;
  transition:transform .08s ease, background .2s ease, box-shadow .2s ease;
  box-shadow:0 1px 0 rgba(0,0,0,.04) inset; -webkit-tap-highlight-color:transparent;
}
.menu-btn:hover{ box-shadow:0 4px 14px rgba(0,0,0,.08); }
.menu-btn:active{ transform:scale(.98); }

/* –§–æ—Ä–º—ã */
.row{display:grid;gap:14px;width:100%;}
.row.two{grid-template-columns:1fr 1fr;}
@media (max-width:520px){ .row.two{grid-template-columns:1fr;} }
label{display:block;font-size:15px;color:var(--muted);margin-bottom:6px;text-align:left;}
input,textarea{
  width:100%;background:var(--input-bg);color:var(--input-fg);
  border:1px solid var(--border);border-radius:12px;
  padding:12px 14px;font-size:16px;outline:none;
  transition:border-color .2s, box-shadow .2s;
}
input:focus,textarea:focus{border-color:var(--accent); box-shadow:0 0 0 4px rgb(79 140 255 / 12%);}
textarea{min-height:120px;resize:vertical;}
.hint{font-size:12px;color:var(--muted);margin-top:8px;text-align:center;}

/* –û–±—â–∏–π layout */
.topbar{display:flex;align-items:center;gap:8px;margin:-8px 0 12px;justify-content:center;}
.back{
  padding:6px 10px;border-radius:10px;background:var(--surface);
  border:1px solid var(--border);color:var(--text);cursor:pointer;
}
.back:active{transform:translateY(1px);}
.hidden{display:none;}

/* –§–æ–Ω–æ–≤—ã–µ —à–∞—Ä—ã */
.wrap::before,.wrap::after{
  content:"";position:absolute;width:70vmax;height:70vmax;border-radius:50%;
  background:radial-gradient(closest-side,rgba(79,140,255,.12),transparent 70%);
  filter:blur(20px);z-index:0;animation:float 24s ease-in-out infinite alternate;pointer-events:none;
}
.wrap::before{top:-30vmax;left:-20vmax;}
.wrap::after{bottom:-30vmax;right:-25vmax;animation-duration:28s;}
@keyframes float{0%{transform:translateY(-10px);}100%{transform:translateY(10px);}}

/* ====== –ú–∞–≥–∞–∑–∏–Ω ====== */
.shop-cats{
  display:flex;gap:8px;flex-wrap:wrap;
  justify-content:center;margin-top:8px;
}
.shop-chip{
  padding:8px 14px;border-radius:999px;border:1px solid var(--border);
  background:var(--surface);cursor:pointer;user-select:none;
  font-size:14px;transition:.15s;
}
.shop-chip.active{
  background:var(--card);border-color:var(--accent);
  box-shadow:0 0 0 4px rgb(79 140 255 / 12%);
}

/* —Å–µ—Ç–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ */
.shop-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:16px;justify-items:center;align-items:start;
}
@media (min-width:560px){ .shop-grid{grid-template-columns:repeat(3,1fr);} }

/* –∫–∞—Ä—Ç–æ—á–∫–∏ */
.shop-card{
  display:flex;flex-direction:column;align-items:center;justify-content:space-between;
  text-align:center;background:var(--card);
  border:1px solid var(--border);border-radius:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  cursor:pointer;transition:transform .1s ease, box-shadow .2s ease;
  width:100%;max-width:220px;overflow:hidden;padding-bottom:10px;
}
.shop-card:hover{box-shadow:0 10px 24px rgba(0,0,0,.12);}
.shop-card:active{transform:translateY(1px) scale(0.995);}

/* –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
.shop-img{
  width:100%;aspect-ratio:1/1;object-fit:cover;
  border-bottom:1px solid var(--border);
  background:var(--surface);
}

/* —Ç–µ–∫—Å—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.shop-title{
  font-size:15px;font-weight:800;margin-top:8px;padding:0 10px;
  word-wrap:break-word;
}
.shop-sub{
  font-size:13px;color:var(--muted);padding:0 10px;
  white-space:normal;overflow-wrap:break-word;
  line-height:1.3;min-height:2.4em;
}
.shop-price{
  font-weight:900;padding:8px 10px;margin-top:auto;
  display:flex;justify-content:center;align-items:center;
  border-top:1px solid var(--border);width:100%;
}

/* –∫–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ */
.item-hero{
  width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:12px;
  border:1px solid var(--border);margin-bottom:8px;
}
.item-price{font-weight:900;font-size:18px;}
.item-meta{
  display:flex;gap:8px;flex-wrap:wrap;justify-content:center;
  align-items:center;margin-bottom:4px;
}
.item-cat{
  font-size:12px;padding:4px 8px;border:1px solid var(--border);
  border-radius:999px;background:var(--surface);color:var(--muted);
}
#item-desc{
  font-size:14px;color:var(--text);
  white-space:normal;overflow-wrap:break-word;line-height:1.4;
  text-align:center;margin-top:6px;
}

/* skeleton */
.skel-card{
  width:100%;height:auto;aspect-ratio:1/1.2;
  border:1px solid var(--border);border-radius:16px;
  background:linear-gradient(90deg,#e9edf6,#f6f8fc,#e9edf6);
  background-size:200% 100%;animation:shimmer 1.2s linear infinite;
}
@keyframes shimmer{
  0%{background-position:200% 0;}100%{background-position:-200% 0;}
}
</style>
</head>
<body>
<div class="mood-overlay" id="mood-overlay"></div>

<!-- –ë–µ–π–¥–∂ –±–∞–ª–∞–Ω—Å–∞ -->
<div id="balance-badge" class="balance-badge">
  <span id="balance-total">0 üé¥</span>
  <span id="balance-delta" class="delta zero">0</span>
</div>

<div class="wrap">
  <div class="card" id="card">

    <!-- HOME -->
    <section id="screen-home" class="grid">
      <h1>üè† –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h1>
      <p>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ForHer. v0.60</p>
      <button class="menu-btn" id="btn-settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-task">‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-shop">üõí –ú–∞–≥–∞–∑–∏–Ω <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-info">‚ÑπÔ∏è –ò–Ω—Ñ–æ <span>‚Ä∫</span></button>
    </section>

    <!-- SETTINGS -->
    <section id="screen-settings" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-settings">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1></div>
      <button class="menu-btn" id="btn-edit-schedule">üõå –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-edit-goal">üéØ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-deps-add">üß≤ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ <span>‚Ä∫</span></button>
    </section>

    <!-- INFO -->
    <section id="screen-info" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-info">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">‚ÑπÔ∏è –ò–Ω—Ñ–æ</h1></div>
      <button class="menu-btn" id="btn-info-day">üìÖ –ò—Ç–æ–≥–∏ –¥–Ω—è <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-info-mood">üß† –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –±–æ—Ç–∞ <span>‚Ä∫</span></button>
      <button class="menu-btn" id="btn-info-bonuses">üé¥ –ë–æ–Ω—É—Å—ã –∏ —à—Ç—Ä–∞—Ñ—ã <span>‚Ä∫</span></button>
    </section>

    <!-- DAY SUMMARY -->
    <section id="screen-stats-day" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-stats-day">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üìÖ –ò—Ç–æ–≥–∏ –¥–Ω—è</h1></div>
      <div class="summary">
        <div class="summary-row">
          <div class="summary-col">
            <div class="summary-amount" id="sum-current">0 üé¥</div>
            <div class="summary-label">—Å–µ–≥–æ–¥–Ω—è</div>
          </div>
          <div class="summary-arrow">
            ‚Üí
            <div id="sum-delta" class="delta-badge zero">0</div>
          </div>
          <div class="summary-col">
            <div class="summary-amount" id="sum-next">0 üé¥</div>
            <div class="summary-label">–∑–∞–≤—Ç—Ä–∞</div>
          </div>
        </div>
        <div class="divider"></div>
        <button class="menu-btn" id="btn-day-details">üßæ –ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ —á–∞—Ç–µ <span>‚Ä∫</span></button>
        <div class="hint">–°–ª–µ–≤–∞ ‚Äî —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å, —Å–ø—Ä–∞–≤–∞ ‚Äî –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ —É—á—ë—Ç–∞ —Å—É–º–º—ã –∑–∞ –¥–µ–Ω—å.</div>
      </div>
    </section>

    <!-- MOOD -->
    <section id="screen-stats-mood" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-stats-mood">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üß† –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –±–æ—Ç–∞</h1></div>
      <div class="mood-card">
        <div class="mood-emoji" id="mood-emoji">üòå</div>
        <div class="mood-title" id="mood-title">–†–æ–≤–Ω—ã–π (0)</div>
        <div class="mood-desc" id="mood-desc">–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å. –ü–æ—Ä–æ–≤–Ω—É –º—è–≥–∫–∏—Ö –∏ –∂—ë—Å—Ç–∫–∏—Ö —Ñ—Ä–∞–∑ ‚Äî –ø–æ –¥–µ–ª—É.</div>
      </div>
      <p class="hint">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ üé¥ –∏ –º–µ–Ω—è–µ—Ç —Å—Ç–∏–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π.</p>
    </section>

    <!-- BONUSES -->
    <section id="screen-bonuses" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-bonuses">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üé¥ –ë–æ–Ω—É—Å—ã –∏ —à—Ç—Ä–∞—Ñ—ã</h1></div>
      <h2 class="subttl good">–ë–æ–Ω—É—Å—ã</h2>
      <p class="subhint">–ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –º–æ–¥—É–ª—é –¥–Ω–µ–≤–Ω–æ–π —Å—É–º–º—ã. –û—Ä–∞–Ω–∂–µ–≤—ã–º ‚Äî —Å–µ—Ä–∏–∏.</p>
      <div class="rule-table" id="bonus-table">
        <div class="rule-head"><div>–ü—Ä–∞–≤–∏–ª–æ</div><div>–†–∞–∑–æ–≤–æ</div><div>–ú–∞–∫—Å/–¥–µ–Ω—å</div></div>
      </div>
      <div class="rule-total good" id="bonus-total">–ò—Ç–æ–≥–æ –º–∞–∫—Å–∏–º—É–º –±–æ–Ω—É—Å–æ–≤: +0%</div>

      <h2 class="subttl bad" style="margin-top:10px">–®—Ç—Ä–∞—Ñ—ã</h2>
      <p class="subhint">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã —É–º–µ–Ω—å—à–∞—é—Ç –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä. –§–∏–∫—Å-—à—Ç—Ä–∞—Ñ—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ üé¥.</p>
      <div class="rule-table" id="penalty-table">
        <div class="rule-head"><div>–ü—Ä–∞–≤–∏–ª–æ</div><div>–†–∞–∑–æ–≤–æ</div><div>–ú–∞–∫—Å/–¥–µ–Ω—å</div></div>
      </div>
      <div class="rule-total bad" id="penalty-total">–ú–∞–∫—Å–∏–º—É–º —à—Ç—Ä–∞—Ñ–æ–≤: ‚àí0%</div>
    </section>

    <!-- SCHEDULE -->
    <section id="screen-schedule" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-schedule">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üõå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞ —Å–Ω–∞</h1></div>
      <p>–£–∫–∞–∂–∏ –≤—Ä–µ–º—è –æ—Ç—Ö–æ–¥–∞ –∫–æ —Å–Ω—É –∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è. –§–æ—Ä–º–∞—Ç 24-—á–∞—Å–æ–≤–æ–π, HH:MM.</p>
      <div class="row two">
        <div><label for="sleep">–û—Ç—Ö–æ–¥ –∫–æ —Å–Ω—É</label><input id="sleep" type="time" step="60" required /></div>
        <div><label for="wake">–ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ</label><input id="wake" type="time" step="60" required /></div>
      </div>
      <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</div>
    </section>

    <!-- GOAL -->
    <section id="screen-goal" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-goal">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üéØ –¶–µ–ª—å</h1></div>
      <p><b>–Ø</b> [—Å–¥–µ–ª–∞—é –¥–µ–π—Å—Ç–≤–∏–µ] <b>—Ä–∞–¥–∏</b> [–º–æ–µ–π —Ü–µ–ª–∏]. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ü–µ–ª—å, —Ä–∞–¥–∏ –∫–æ—Ç–æ—Ä–æ–π —Ç—ã –¥–≤–∏–≥–∞–µ—à—å—Å—è.</p>
      <textarea id="goal" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Å–Ω–∞ –∏ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"></textarea>
      <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å.</div>
    </section>

    <!-- DEPS ADD -->
    <section id="screen-deps-add" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-deps-add">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üß≤ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</h1></div>
      <label for="dep-title">–Ø –∑–∞–≤–∏—Å–∏–º –æ—Ç‚Ä¶</label>
      <input id="dep-title" type="text" placeholder="—Å–ª–∞–¥–∫–æ–≥–æ / —Å–æ—Ü—Å–µ—Ç–µ–π / –∞–ª–∫–æ–≥–æ–ª—è‚Ä¶" />
      <div class="scale-head" style="margin-top:4px">
        <label>–°–∏–ª–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</label>
        <div class="readout"><span>–≤–µ—Å</span> <span class="pill" id="dep-strength-pill">1,0</span></div>
      </div>
      <div class="scale-labels"><span>—Å–ª–∞–±–∞—è</span><span>—Å–∏–ª—å–Ω–∞—è</span></div>
      <div class="slider-wrap">
        <input id="dep-strength" type="range" min="0.1" max="3" step="0.1" value="1.0" />
      </div>
      <div class="hint">–°–∏—Å—Ç–µ–º–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π —Å–Ω–∏–∑—É ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –≤ –±–æ—Ç–∞.</div>
      <div id="deps-current" class="grid" style="gap:8px; margin-top:8px"></div>
    </section>

    <!-- TASK -->
    <section id="screen-task" class="grid hidden">
      <div class="topbar">
        <button class="back" id="back-from-task">‚Üê –ù–∞–∑–∞–¥</button>
        <h1 style="margin:0">‚úçÔ∏è –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h1>
      </div>
      <p>–§–æ—Ä–º–∞—Ç: <b>–Ø</b> [—Å–¥–µ–ª–∞—é –¥–µ–π—Å—Ç–≤–∏–µ] <b>—Ä–∞–¥–∏</b> [–º–æ–µ–π —Ü–µ–ª–∏].</p>

      <div class="grid">
        <label for="action">–Ø</label>
        <input id="action" type="text" placeholder="–∏–∑—É—á—É –º–∞—Ç–µ—Ä–∏–∞–ª—ã / —Å–¥–µ–ª–∞—é 10 –æ—Ç–∂–∏–º–∞–Ω–∏–π" />
        <p class="goal-line" style="margin:-6px 0 10px; color:var(--muted)">—Ä–∞–¥–∏ <b id="goal-view">–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –º–µ—á—Ç—ã</b></p>

        <div class="grid" style="gap:8px">
          <label>–†–µ–∂–∏–º</label>
          <div class="chips">
            <div class="chip" id="chip-will">üí™ –°–∏–ª–∞ –≤–æ–ª–∏</div>
            <div class="chip" id="chip-add">üß≤ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å</div>
          </div>
        </div>

        <div id="deps-block" class="grid hidden" style="gap:8px">
          <label>–í—ã–±–µ—Ä–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å</label>
          <div id="deps-list" class="grid" style="gap:8px"></div>
          <div class="hint">–ï—Å–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤—å —á–µ—Ä–µ–∑ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏¬ª.</div>
        </div>

        <div class="scale-head">
          <label id="scale-title">–í–ª–∏—è–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —Ü–µ–ª—å</label>
          <div class="readout"><span>–≤–µ—Å</span> <span class="pill" id="imp-pill">1,0</span></div>
        </div>
        <div class="scale-labels"><span id="lbl-min">–ö–æ—Å–≤–µ–Ω–Ω–æ–µ</span><span id="lbl-max">–ü—Ä—è–º–æ–µ</span></div>
        <div class="slider-wrap">
          <input id="importanceRange" type="range" min="0.1" max="3" step="0.1" value="1.0" />
        </div>

        <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É.</div>
      </div>
    </section>

    <!-- SHOP (list) -->
    <section id="screen-shop" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-shop">‚Üê –ù–∞–∑–∞–¥</button><h1 style="margin:0">üõí –ú–∞–≥–∞–∑–∏–Ω</h1></div>
      <div class="shop-cats" id="shop-cats"></div>
      <div class="divider"></div>

      <div class="shop-grid" id="shop-grid">
        <!-- skeletons -->
      </div>
    </section>

    <!-- SHOP (item) -->
    <section id="screen-shop-item" class="grid hidden">
      <div class="topbar"><button class="back" id="back-from-item">‚Üê –ú–∞–≥–∞–∑–∏–Ω</button><h1 id="item-title" style="margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">–¢–æ–≤–∞—Ä</h1></div>
      <img id="item-img" class="item-hero" alt="cover" />
      <div class="item-meta">
        <span class="item-cat" id="item-cat">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
        <span class="item-price" id="item-price">0 üé¥</span>
      </div>
      <div id="item-desc" style="font-size:14px; color:var(--text) white-space: normal;       /* –†–∞–∑—Ä–µ—à–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ */ overflow-wrap: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ */ text-overflow: unset;      /* –£–±–∏—Ä–∞–µ—Ç —Ç—Ä–æ–µ—Ç–æ—á–∏–µ */display: -webkit-box;"></div>
      <div id="item-botdesc" class="hint"></div>
      <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É ¬´–ö—É–ø–∏—Ç—å¬ª, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É –≤ –±–æ—Ç–∞.</div>
    </section>

  </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
const $  = (id) => document.getElementById(id);
const isValidTime = (v) => /^\d{2}:\d{2}$/.test(v);

/* CloudStorage */
const cs = {
  get: (k) => new Promise(res => tg?.CloudStorage?.getItem?.(k, v => res(v))),
  set: (k, v) => new Promise(res => tg?.CloudStorage?.setItem?.(k, String(v), () => res(true)))
};

let balanceTotal = 0;
let balanceToday = 0;
let moodLevel    = 0;
let userGoal     = '';
let userName     = '';

let mode          = 'normal';
let DEPS          = [];
let selectedDepId = null;

/* SHOP */
let SHOP = [];
let SHOP_CATS = [];
let SHOP_SELECTED = new Set();
let CUR_PRODUCT = null;
let PRICES = {}; // –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ü–µ–Ω—ã —Å –±—ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

/* mood presets */
const MOOD = {
  2:   { emoji:'üòá', title:'–î–æ–±—Ä—è—á–æ–∫ (+2)', color:'#20c997', desc:'–Ø –º—è–≥–∫–∏–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π. –õ–∞–π—Ç–æ–≤—ã–µ –Ω—É–¥–∂–∏, –º–Ω–æ–≥–æ –ø–æ—Ö–≤–∞–ª—ã.' },
  1:   { emoji:'üôÇ', title:'–¢—ë–ø–ª—ã–π (+1)',   color:'#2ea8ff', desc:'–î—Ä—É–∂–µ–ª—é–±–µ–Ω, –Ω–æ —Å–æ–±—Ä–∞–Ω. –ù–∞–ø–æ–º–∏–Ω–∞—é –º—è–≥–∫–æ, –º–æ—Ç–∏–≤–∏—Ä—É—é.' },
  0:   { emoji:'üòå', title:'–†–æ–≤–Ω—ã–π (0)',    color:'#8aa0b4', desc:'–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å. –ü–æ—Ä–æ–≤–Ω—É –º—è–≥–∫–∏—Ö –∏ –∂—ë—Å—Ç–∫–∏—Ö —Ñ—Ä–∞–∑.' },
  [-1]:{ emoji:'üòæ', title:'–ö–æ–ª—é—á–∏–π (‚àí1)',  color:'#ff9966', desc:'–°—Ç–∞–Ω–æ–≤–ª—é—Å—å –ø—Ä—è–º–µ–µ. –ú–µ–Ω—å—à–µ –Ω–µ–∂–Ω–æ—Å—Ç–µ–π ‚Äî –±–æ–ª—å—à–µ –¥–µ–ª–∞.' },
  [-2]:{ emoji:'üòà', title:'–ó–ª–æ–π (‚àí2)',     color:'#ff4d4f', desc:'–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–≥–æ—Å—Ç—å. –¶–µ–ª—å –≤–∞–∂–Ω–µ–µ –æ—Ç–≥–æ–≤–æ—Ä–æ–∫.' },
};
const clampMood = (m)=>{ m = parseInt(m||0,10); if(m>2)m=2; if(m<-2)m=-2; return m; }
const fmtInt = (n)=> new Intl.NumberFormat('ru-RU').format(n);

/* ===== Utils ===== */
function depTitleDisplay(t){
  t = String(t || '').trim();
  const low = t.toLowerCase();
  if (!t) return '';
  if (low.startsWith('–∑–∞–≤–∏—Å–∏–º')) return t;
  if (low.startsWith('–æ—Ç '))     return `–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å ${t}`;
  return `–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç ${t}`;
}
function lineClamp(text, n=2){ return String(text||''); }
function pickSubtitle(p){
  return p.subtitle || p.short || (p.description ? String(p.description).split('\n')[0] : '');
}
function toNumberMaybe(x){
  if (x == null) return null;
  if (typeof x === 'number') return Number.isFinite(x) ? x : null;
  // —Å—Ä–µ–∑–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, —ç–º–æ–¥–∑–∏, ¬´–≥—Ä–∏—Ç–∞¬ª –∏ –¥—Ä. —Å–∏–º–≤–æ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —á–∏—Å–ª–∞/–∑–Ω–∞–∫/—Ç–æ—á–∫—É
  const cleaned = String(x).replace(/[^\d.-]/g, '');
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : null;
}

function priceOf(p){
  const id   = String(p.id);
  const dyn  = toNumberMaybe(PRICES?.[id]);                             // –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–∞ –∏–∑ –±—ç–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  const base = toNumberMaybe(p.price ?? p.base_price ?? p.cost ?? '');  // –±–∞–∑–æ–≤–∞—è –∏–∑ shop.json

  const val = (dyn ?? base ?? 0);
  return Math.max(0, Math.round(val));
}
function b64json(str){
  try{
    const norm = (str||'').replace(/-/g,'+').replace(/_/g,'/');
    const bin  = atob(norm);
    const bytes = new Uint8Array([...bin].map(c=>c.charCodeAt(0)));
    return JSON.parse(new TextDecoder("utf-8").decode(bytes));
  }catch(e){ return null; }
}

/* ===== Bonuses tables (–∫–∞–∫ –±—ã–ª–∏) ===== */
const BONUS_RULES = [
  { emoji:"üßÆ", title:"–ú–∞–ª—ã–µ —à–∞–≥–∏", desc:"–ó–∞ –ª—é–±—É—é –æ—Ç–º–µ—á–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É: +1% –∑–∞ —à—Ç—É–∫—É, –º–∞–∫—Å–∏–º—É–º +10%/–¥–µ–Ω—å.", per:+1, max:+10 },
  { emoji:"‚≠êÔ∏è", title:"–ó–Ω–∞—á–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è", desc:"–ó–∞ –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É –≤–µ—Å–æ–º ‚â•2.0: +10% –±–µ–∑ –≤–µ—Ä—Ö–Ω–µ–≥–æ –ª–∏–º–∏—Ç–∞.", per:+10, max:+999 },
  { emoji:"‚ö°", title:"–ë–µ–∑ –ø—Ä–æ–≤–∞–ª–æ–≤", desc:"–ï—Å–ª–∏ –≤ –¥–Ω–µ –Ω–µ—Ç –ø—Ä–æ–≤–∞–ª–æ–≤: +10% –æ–¥–∏–Ω —Ä–∞–∑.", per:+10, max:+10 },
  { emoji:"üöÄ", title:"–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç", desc:"–ü–µ—Ä–≤–∞—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —á–∞—Å–∞ –ø–æ—Å–ª–µ –ø–æ–¥—ä—ë–º–∞: +5% –æ–¥–∏–Ω —Ä–∞–∑.", per:+5, max:+5 },
  { emoji:"‚è±Ô∏è", title:"Hi-impact –≤ –ø–µ—Ä–≤—ã–µ 5—á", desc:"–õ—é–±–∞—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è ‚â•2.0 –≤ –ø–µ—Ä–≤—ã–µ 5 —á–∞—Å–æ–≤: +10% –æ–¥–∏–Ω —Ä–∞–∑.", per:+10, max:+10 },
  { emoji:"üß≤", title:"–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–æ–±–æ—Ä–µ–Ω—ã", desc:"–ï—Å–ª–∏ –≤ –¥–Ω–µ –±—ã–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –≤—Å–µ –æ—Ç–º–µ—á–µ–Ω—ã ¬´‚úÖ¬ª: +20%. –ï—Å–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–µ—Ç –≤–æ–æ–±—â–µ ‚Äî –ø–∞—Å—Å–∏–≤–Ω—ã–µ +10%.", per:+20, max:+20 },
  { emoji:"üõå", title:"–†–µ–∂–∏–º —Å–æ–±–ª—é–¥—ë–Ω", desc:"–ü–æ–¥—ä—ë–º –∏ —Å–æ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã –≤ –æ–∫–Ω–µ 10 –º–∏–Ω—É—Ç: +20% –∑–∞ –¥–µ–Ω—å.", per:+20, max:+20 },
  { emoji:"üüß", title:"–°–µ—Ä–∏—è: –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —à–∞–≥", desc:"–í—Ç–æ—Ä–æ–π –¥–µ–Ω—å –ø–æ–¥—Ä—è–¥ –¥–∞—ë—Ç +1%, —Ç—Ä–µ—Ç–∏–π +2% ‚Ä¶ –º–∞–∫—Å–∏–º—É–º +10%.", per:+1, max:+10 },
  { emoji:"üüß", title:"–°–µ—Ä–∏—è: —Ä–µ–∂–∏–º", desc:"–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ ‚Äî –∑–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–π –ø–æ–¥—ä—ë–º+—Å–æ–Ω, –º–∞–∫—Å–∏–º—É–º +10%.", per:+1, max:+10 },
  { emoji:"üüß", title:"–°–µ—Ä–∏—è: –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏", desc:"–î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: 0.5% √ó —Å–ª–æ–∂–Ω–æ—Å—Ç—å √ó N (N‚â§21). –°–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –ø–æ –≤—Å–µ–º.", per:+0.5, max:+31.5 },
];
const PENALTY_RULES = [
  { emoji:"‚ùå", title:"–ü—Ä–æ–≤–∞–ª—ã —Å–≤–µ—Ä—Ö –ø–µ—Ä–≤–æ–≥–æ", desc:"‚àí5% –∑–∞ –∫–∞–∂–¥—ã–π –ø—Ä–æ–≤–∞–ª —Å–≤–µ—Ä—Ö –ø–µ—Ä–≤–æ–≥–æ, –º–∞–∫—Å–∏–º—É–º ‚àí30%/–¥–µ–Ω—å.", per:-5, max:-30 },
  { emoji:"üìµ", title:"–ò–≥–Ω–æ—Ä –Ω—É–¥–∂–µ–π", desc:"‚àí1% –∑–∞ –∫–∞–∂–¥—ã–π –∏–≥–Ω–æ—Ä, –º–∞–∫—Å–∏–º—É–º ‚àí10%/–¥–µ–Ω—å.", per:-1, max:-10 },
  { emoji:"‚õî", title:"–†–µ–∂–∏–º –Ω–∞—Ä—É—à–µ–Ω", desc:"–ü–æ–¥—ä—ë–º/—Å–æ–Ω –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã: ‚àí10% –∑–∞ —Å–æ–±—ã—Ç–∏–µ (–¥–æ ‚àí20%).", per:-10, max:-20 },
  { emoji:"üï≥Ô∏è", title:"–ù–µ—Ç –≤–∞–∂–Ω–æ–≥–æ —à–∞–≥–∞", desc:"–ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π ¬´–æ–±—ã—á–Ω–æ–π¬ª –∑–∞–¥–∞—á–∏, –¥–≤–∏–≥–∞—é—â–µ–π —Ü–µ–ª—å: ‚àí300 üé¥.", per:0, max:0 },
  { emoji:"üóìÔ∏è", title:"–ü—É—Å—Ç–æ–π –¥–µ–Ω—å", desc:"–ù–µ—Ç –∑–∞–¥–∞—á –≤–æ–æ–±—â–µ: ‚àí500 üé¥.", per:0, max:0 },
];
function fmtPct(n){ return (n>0?`+${n}`:`${n}`) + "%"; }
function renderRuleList(tableEl, rules, isBonus){
  tableEl.querySelectorAll('.rule-row').forEach(n=>n.remove());
  rules.forEach(r=>{
    const row = document.createElement('div');
    row.className = 'rule-row';
    row.innerHTML = `
      <div class="rule-name">
        <div class="ttl">${r.emoji} ${r.title}</div>
        <div class="desc">${r.desc}</div>
      </div>
      <div class="rule-per ${isBonus?'good':(r.per<0?'bad':'good')}">${r.per===0?'‚Äî':fmtPct(r.per)}</div>
      <div class="rule-max ${isBonus?'good':(r.max<0?'bad':'good')}">${r.max===0?'‚Äî':fmtPct(r.max)}</div>
    `;
    tableEl.appendChild(row);
  });
}
function renderBonusesScreen(){
  const bt = $('bonus-table');
  const pt = $('penalty-table');
  if (bt && pt){
    renderRuleList(bt, BONUS_RULES, true);
    renderRuleList(pt, PENALTY_RULES, false);
    const bonusSum = BONUS_RULES.reduce((s,r)=>s+(r.max>0?r.max:0),0);
    const penSum   = PENALTY_RULES.reduce((s,r)=>s+(r.max<0?r.max:0),0);
    $('bonus-total').textContent   = `–ò—Ç–æ–≥–æ –º–∞–∫—Å–∏–º—É–º –±–æ–Ω—É—Å–æ–≤: ${fmtPct(bonusSum)}`;
    $('penalty-total').textContent = `–ú–∞–∫—Å–∏–º—É–º —à—Ç—Ä–∞—Ñ–æ–≤: ${fmtPct(penSum)}`;
  }
}

/* ===== hydrate from URL/CS ===== */
async function hydrateFromParamsOrCS(){
  const p = new URLSearchParams(location.search);
  const b  = p.get('b'),  bt = p.get('bt');
  const m  = p.get('m'),  g  = p.get('g') || p.get('goal');
  const n  = p.get('name');
  const depsb64   = p.get('depsb64');
  const pricesb64 = p.get('pricesb64'); // <-- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ü–µ–Ω—ã

  let changed = false;

  if (b  !== null) { balanceTotal = parseInt(b,10) || 0; changed = true; }
  if (bt !== null) { balanceToday = parseInt(bt,10) || 0; changed = true; }
  if (m  !== null) { moodLevel    = clampMood(m);        changed = true; }
  if (g)           { userGoal     = g.trim();             changed = true; }
  if (n)           { userName     = n.trim();             changed = true; }
  if (depsb64)     { DEPS         = b64json(depsb64) || []; changed = true; }
  if (pricesb64)   { PRICES       = b64json(pricesb64) || {}; changed = true; }

  if (!changed && tg?.CloudStorage){
    const [cb, cbt, cm, cg, cn, cd, cpr] = await Promise.all([
      cs.get('b'), cs.get('bt'), cs.get('m'), cs.get('g'), cs.get('name'), cs.get('depsb64'), cs.get('shop_prices')
    ]);
    if (cb  != null) balanceTotal = parseInt(cb,10)  || 0;
    if (cbt != null) balanceToday = parseInt(cbt,10) || 0;
    if (cm  != null) moodLevel    = clampMood(cm);
    if (cg) userGoal = cg;
    if (cn) userName = cn;
    if (cd) DEPS = b64json(cd) || [];
    if (cpr) { try{ PRICES = JSON.parse(cpr) || {}; } catch{} }
  }

  // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±64/—Ü–µ–Ω—ã –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ URL
  if (changed && tg?.CloudStorage){
    const depsB64 = (()=>{ try{
      const enc = new TextEncoder().encode(JSON.stringify(DEPS||[], null, 0));
      const bin = Array.from(enc).map(x=>String.fromCharCode(x)).join('');
      return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_');
    }catch(e){ return ''; }})();
    await Promise.allSettled([
      cs.set('b', balanceTotal), cs.set('bt', balanceToday),
      cs.set('m', moodLevel), cs.set('g', userGoal || ''), cs.set('name', userName || ''),
      cs.set('depsb64', depsB64),
      cs.set('shop_prices', JSON.stringify(PRICES||{}))
    ]);
  }
}

/* ===== Theme & chrome ===== */
function applyTheme(){
  const scheme = tg?.colorScheme ?? 'light';
  const set = (k,v)=>document.documentElement.style.setProperty(k,v);
  if(scheme==='dark'){
    set('--bg','#0f1115'); set('--card','#161923'); set('--text','#e9eef6'); set('--muted','#9aa4b2'); set('--border','#232838'); set('--surface','#10141e'); set('--accent','#4f8cff'); set('--btn-bg','var(--surface)'); set('--btn-fg','var(--text)'); set('--input-bg','#0e1118'); set('--input-fg','var(--text)');
  } else {
    set('--bg','#f6f8fc'); set('--card','#ffffff'); set('--text','#0b1220'); set('--muted','#5b6676'); set('--border','#e6e9f2'); set('--surface','#f1f4fa'); set('--accent','#4f8cff'); set('--btn-bg','var(--surface)'); set('--btn-fg','var(--text)'); set('--input-bg','#fbfcff'); set('--input-fg','var(--text)');
  }
  if(tg?.themeParams?.button_color){ set('--accent', tg.themeParams.button_color); }
}
function renderBalanceBadge(){
  $('balance-total').textContent = `${fmtInt(balanceTotal)} üé¥`;
  const d = $('balance-delta');
  if (balanceToday > 0){ d.textContent = `+${fmtInt(balanceToday)}`; d.className = 'delta pos'; }
  else if (balanceToday < 0){ d.textContent = `${fmtInt(balanceToday)}`; d.className = 'delta neg'; }
  else { d.textContent = '0'; d.className = 'delta zero'; }
}
function setMoodColor(){
  const c = (MOOD[moodLevel] || MOOD[0]).color;
  document.documentElement.style.setProperty('--mood', c);
}

/* ===== Screens ===== */
function showScreen(name){
  ['home','settings','schedule','goal','task','info','stats-mood','stats-day','bonuses','deps-add','shop','shop-item'].forEach(id=>{
    $(`screen-${id}`).classList.toggle('hidden', id!==name);
  });
  const card = $('card'); card.classList.add('swap'); setTimeout(()=>card.classList.remove('swap'), 180);
  document.body.classList.toggle('mood-on', name==='stats-mood');

  if(!tg) return;
  if(name==='schedule'){ tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å'); updateMainButtonSchedule(); }
  else if(name==='goal'){ tg.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'); updateMainButtonGoal(); }
  else if(name==='task'){ tg.MainButton.setText('–°–æ–∑–¥–∞—Ç—å'); updateMainButtonTask(); renderTaskDepsList();}
  else if(name==='deps-add'){ tg.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'); updateMainButtonDeps(); setTimeout(updateMainButtonDeps, 0); }
  else if(name==='shop-item'){ updateMainButtonShopItem(true); }
  else { tg.MainButton.hide(); }

  if(name==='stats-mood'){
    const m = MOOD[moodLevel] || MOOD[0];
    $('mood-emoji').textContent = m.emoji;
    $('mood-title').textContent = m.title;
    $('mood-desc').textContent  = m.desc;
    setMoodColor();
  }
  if(name==='stats-day'){ renderDaySummary(); }
  if(name==='bonuses'){ renderBonusesScreen(); }
  if(name==='deps-add'){ renderDepsCurrent(); }
  if(name==='shop'){ mountShop(); }
}

/* ===== Day summary ===== */
function renderDaySummary(){
  const cur = balanceTotal;
  const delta = balanceToday;
  const nxt = cur + delta;
  $('sum-current').textContent = `${fmtInt(cur)} üé¥`;
  $('sum-next').textContent    = `${fmtInt(nxt)} üé¥`;
  const db = $('sum-delta');
  if (delta > 0) { db.textContent = `+${fmtInt(delta)}`; db.className = 'delta-badge pos'; }
  else if (delta < 0){ db.textContent = `${fmtInt(delta)}`; db.className = 'delta-badge neg'; }
  else { db.textContent = '0'; db.className = 'delta-badge zero'; }
}

/* ===== Inputs ===== */
function updateMainButtonSchedule(){ if(!tg) return; const ok = isValidTime($('sleep').value||'') && isValidTime($('wake').value||''); tg.MainButton[ok?'show':'hide'](); }
function updateMainButtonGoal(){ if(!tg) return; const ok = ( $('goal').value||'' ).trim().length>0; tg.MainButton[ok?'show':'hide'](); }
function updateMainButtonTask(){
  if(!tg) return;
  const hasAction = ( $('action').value||'' ).trim().length > 0;
  const needDep   = (mode === 'addiction');
  const ok = hasAction && (!needDep || !!selectedDepId);
  tg.MainButton[ ok ? 'show' : 'hide' ]();
}
function updateMainButtonDeps(){
  if(!tg) return;
  const ok = ( ($('dep-title')?.value || '').trim().length > 0 );
  tg.MainButton[ ok ? 'show' : 'hide']();
}
function setMode(newMode){
  if (newMode === mode) {
    mode = 'normal';
    $('chip-will').classList.remove('active');
    $('chip-add').classList.remove('active');
  } else {
    mode = newMode;
    $('chip-will').classList.toggle('active', mode==='willpower');
    $('chip-add').classList.toggle('active', mode==='addiction');
  }
  updateScaleLabels(); updateSliderUI();
  const showDeps = (mode === 'addiction');
  $('deps-block')?.classList.toggle('hidden', !showDeps);
  if (showDeps) renderTaskDepsList();
  updateMainButtonTask();
}
function updateScaleLabels(){
  const lblMin = $('lbl-min'), lblMax = $('lbl-max'), title = $('scale-title');
  if (mode === 'willpower'){
    lblMin.textContent = '–ü—Ä–æ—Å—Ç–æ–µ'; lblMax.textContent = '–ú—É—á–∏—Ç–µ–ª—å–Ω–æ–µ';
    title.textContent = '–°–∏–ª–∞ –≤–æ–ª–∏ ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ —Ç—è–∂–µ–ª–æ';
  } else if (mode === 'addiction'){
    lblMin.textContent = '–ë–∞–ª—É—é—Å—å'; lblMax.textContent = '–°–∏–ª—å–Ω–∞—è —Ç—è–≥–∞';
    title.textContent = '–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å ‚Äî –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Ç—è–≥–∏';
  } else {
    lblMin.textContent = '–ö–æ—Å–≤–µ–Ω–Ω–æ–µ'; lblMax.textContent = '–ü—Ä—è–º–æ–µ';
    title.textContent = '–í–ª–∏—è–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —Ü–µ–ª—å';
  }
}
function colorForValue(val){
  const t = Math.min(1, Math.max(0, (val - 0.1) / (3 - 0.1)));
  if (mode === 'willpower'){
    const start = [79,140,255], end = [192,72,255];
    const r = Math.round(start[0] + (end[0]-start[0])*t);
    const g = Math.round(start[1] + (end[1]-start[1])*t);
    const b = Math.round(start[2] + (end[2]-start[2])*t);
    return `rgb(${r} ${g} ${b})`;
  } else if (mode === 'addiction'){
    const start = [255,170,54], end = [255,77,79];
    const r = Math.round(start[0] + (end[0]-start[0])*t);
    const g = Math.round(start[1] + (end[1]-start[1])*t);
    const b = Math.round(start[2] + (end[2]-start[2])*t);
    return `rgb(${r} ${g} ${b})`;
  } else {
    const start = [64,199,129], end = [79,140,255];
    const r = Math.round(start[0] + (end[0]-start[0])*t);
    const g = Math.round(start[1] + (end[1]-start[1])*t);
    const b = Math.round(start[2] + (end[2]-start[2])*t);
    return `rgb(${r} ${g} ${b})`;
  }
}
function updateSliderUI(){
  const r = $('importanceRange'); if(r){
    const v = parseFloat(r.value||'1') || 1;
    const p = ((v - 0.1) / (3 - 0.1)) * 100;
    document.documentElement.style.setProperty('--meter', colorForValue(v));
    r.style.setProperty('--val', `${p}%`);
    $('imp-pill').textContent = new Intl.NumberFormat('ru-RU',{minimumFractionDigits:1,maximumFractionDigits:1}).format(v);
  }
  const s = $('dep-strength'); if(s){
    const v2 = parseFloat(s.value||'1') || 1;
    const p2 = ((v2 - 0.1) / (3 - 0.1)) * 100;
    document.documentElement.style.setProperty('--meter', colorForValue(v2));
    s.style.setProperty('--val', `${p2}%`);
    $('dep-strength-pill').textContent = new Intl.NumberFormat('ru-RU',{minimumFractionDigits:1,maximumFractionDigits:1}).format(v2);
  }
}

/* ===== Dependencies UI ===== */
function renderTaskDepsList(){
  const block = $('deps-block');
  const list  = $('deps-list');
  if (!block || !list) return;
  if (mode !== 'addiction'){ block.classList.add('hidden'); return; }
  block.classList.remove('hidden');
  list.innerHTML = '';
  const deps = DEPS;
  if (!deps.length){
    list.innerHTML = '<div class="hint">–ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. –î–æ–±–∞–≤—å —á–µ—Ä–µ–∑ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏¬ª.</div>';
    return;
  }
  deps.forEach(d => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'dep-option' + (String(selectedDepId)===String(d.id) ? ' active' : '');
    btn.dataset.id = String(d.id);
    btn.innerHTML = `
      <span>üß≤</span>
      <span class="dep-title">${depTitleDisplay(d.title)}</span>
      <span class="dep-weight">–≤–µ—Å ${new Intl.NumberFormat('ru-RU',{minimumFractionDigits:1,maximumFractionDigits:1}).format(d.strength)}</span>
    `;
    list.appendChild(btn);
  });
}
$('deps-list')?.addEventListener('click', (e)=>{
  const row = e.target.closest('.dep-option');
  if(!row) return;
  selectedDepId = row.dataset.id;
  document.querySelectorAll('#deps-list .dep-option').forEach(el=>{ el.classList.toggle('active', el === row); });
  const d = DEPS.find(x => String(x.id) === String(selectedDepId));
  if (d){
    const r = $('importanceRange');
    if(r){ r.value = String(d.strength); updateSliderUI(); }
  }
  if (mode !== 'addiction') {
    setMode('addiction');
  } else {
    $('chip-add')?.classList.add('active');
    $('deps-block')?.classList.remove('hidden');
    updateScaleLabels(); updateSliderUI();
  }
  updateMainButtonTask();
});
function renderDepsCurrent(){
  const box = $('deps-current');
  if (!box) return;
  box.innerHTML = '<div class="badge">–¢–≤–æ–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</div>';
  if (!DEPS || DEPS.length===0){
    const p = document.createElement('p'); p.className='hint'; p.textContent = '–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é –≤—ã—à–µ ‚Üë';
    box.appendChild(p); return;
  }
  DEPS.forEach(dep=>{
    const row = document.createElement('div');
    row.className = 'menu-btn';
    row.innerHTML = `üß≤ ${depTitleDisplay(dep.title)} <span style="font-weight:800; font-size:12px; opacity:.8">–≤–µ—Å ${new Intl.NumberFormat('ru-RU',{minimumFractionDigits:1,maximumFractionDigits:1}).format(dep.strength)}</span>`;
    box.appendChild(row);
  });
}

/* ===== SHOP: skeletons, load, render ===== */
function renderShopSkeletons(count=6){
  const grid = $('shop-grid'); if(!grid) return;
  grid.innerHTML = '';
  for(let i=0;i<count;i++){
    const s = document.createElement('div');
    s.className = 'skel-card';
    s.innerHTML = `
      <div class="skel-img"></div>
      <div class="skel-line"></div>
      <div class="skel-line"></div>
      <div class="skel-line short"></div>
    `;
    grid.appendChild(s);
  }
}
async function preloadImages(urls){
  const tasks = (urls||[]).map(u => new Promise(res=>{
    const img = new Image();
    img.onload = ()=>res(true);
    img.onerror = ()=>res(false);
    img.src = u;
  }));
  await Promise.allSettled(tasks);
}
async function loadShop(){
  const ver = new URLSearchParams(location.search).get('v') || 'v1';
  const r = await fetch(`shop.json?v=${encodeURIComponent(ver)}`, { cache:'no-store' });
  if(!r.ok) throw new Error('http '+r.status);
  const arr = await r.json();
  SHOP = (Array.isArray(arr)?arr:[]).filter(p => p && p.active !== false);
  SHOP_CATS = Array.from(new Set(SHOP.map(p => p.category).filter(Boolean)));
  // –ü—Ä–µ–ª–æ–∞–¥ –∫–∞—Ä—Ç–∏–Ω–æ–∫
  await preloadImages(SHOP.map(p=>p.image).filter(Boolean));
}
function mountShop(){
  renderShopSkeletons(6);
  if (!SHOP.length){
    loadShop()
      .then(()=>{ renderShopCats(); renderShopGrid(); })
      .catch(err=>{
        const grid = $('shop-grid');
        if (grid) grid.innerHTML = `<div class="shop-card" style="padding:12px;display:grid;align-items:center;justify-items:center">
          <div class="shop-sub" style="text-align:center">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω (shop.json). ${err.message||''}</div>
        </div>`;
      });
  } else {
    renderShopCats(); renderShopGrid();
  }
}
function renderShopCats(){
  const catsEl = $('shop-cats'); if(!catsEl) return;
  catsEl.innerHTML = '';
  const all = document.createElement('div');
  all.className = 'shop-chip' + (SHOP_SELECTED.size===0 ? ' active' : '');
  all.textContent = '–í—Å–µ';
  all.addEventListener('click', ()=>{ SHOP_SELECTED.clear(); renderShopCats(); renderShopGrid(); });
  catsEl.appendChild(all);

  SHOP_CATS.forEach(cat=>{
    const chip = document.createElement('div');
    chip.className = 'shop-chip' + (SHOP_SELECTED.has(cat) ? ' active' : '');
    chip.textContent = cat;
    chip.addEventListener('click', ()=>{
      if (SHOP_SELECTED.has(cat)) SHOP_SELECTED.delete(cat); else SHOP_SELECTED.add(cat);
      renderShopCats(); renderShopGrid();
    });
    catsEl.appendChild(chip);
  });
}
function filteredProducts(){
  if (SHOP_SELECTED.size === 0) return SHOP;
  return SHOP.filter(p => SHOP_SELECTED.has(p.category));
}
function renderShopGrid(){
  const grid = $('shop-grid'); if(!grid) return;
  const list = filteredProducts();
  if (!list.length){
    grid.innerHTML = '<div class="shop-card" style="padding:12px;display:grid;align-items:center;justify-items:center"><div class="shop-sub" style="text-align:center">–ü–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç.</div></div>';
    return;
  }
  grid.innerHTML = '';
  list.forEach(p=>{
    const price = priceOf(p);
    const sub = pickSubtitle(p);
    const card = document.createElement('div');
    card.className = 'shop-card';
    card.innerHTML = `
      <img class="shop-img" src="${p.image}" alt="" loading="lazy" onerror="this.style.opacity=0.6" />
      <div class="shop-title">${p.title}</div>
      <div class="shop-sub">${sub || ''}</div>
      <div class="shop-price"><span>${fmtInt(price)} üé¥</span></div>
    `;
    card.addEventListener('click', ()=>openProduct(p));
    grid.appendChild(card);
  });
}
function openProduct(p){
  CUR_PRODUCT = p || null;
  if (!p) return;
  $('item-title').textContent = p.title || '–¢–æ–≤–∞—Ä';
  const img = $('item-img'); img.src = p.image; img.alt = p.title || '';
  $('item-price').textContent = `${fmtInt(priceOf(p))} üé¥`;
  $('item-cat').textContent = p.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
  $('item-desc').innerHTML = (p.description||'').replace(/\n/g,'<br>');
  $('item-botdesc').textContent = p.bot_description || '';
  showScreen('shop-item');
}
function updateMainButtonShopItem(show){
  if(!tg) return;
  if (!CUR_PRODUCT){ tg.MainButton.hide(); return; }
  tg.MainButton.setText(`–ö—É–ø–∏—Ç—å –∑–∞ ${fmtInt(priceOf(CUR_PRODUCT))} üé¥`);
  if (show) tg.MainButton.show();
}
function purchaseCurrentProduct(){
  if (!CUR_PRODUCT) return;
  const price = fmtInt(priceOf(CUR_PRODUCT));
  const ok = confirm(`–ö—É–ø–∏—Ç—å ¬´${CUR_PRODUCT.title}¬ª –∑–∞ ${price} üé¥?`);
  if (!ok) return;
  const payload = { shop_buy: { id: String(CUR_PRODUCT.id) } };
  try { tg?.sendData(JSON.stringify(payload)); } catch(e){ console.error(e); }
  try { tg?.HapticFeedback?.notificationOccurred('success'); } catch {}
  setTimeout(()=>tg?.close?.(), 120);
}

/* ===== Bind / Init ===== */
function bind(){
  $('btn-settings')?.addEventListener('click', ()=>showScreen('settings'));
  $('btn-task')?.addEventListener('click', ()=>showScreen('task'));
  $('btn-shop')?.addEventListener('click', ()=>showScreen('shop'));

  // Info hub
  $('btn-info')?.addEventListener('click', ()=>showScreen('info'));
  $('back-from-info')?.addEventListener('click', ()=>showScreen('home'));
  $('btn-info-day')?.addEventListener('click', ()=>showScreen('stats-day'));
  $('btn-info-mood')?.addEventListener('click', ()=>showScreen('stats-mood'));
  $('btn-info-bonuses')?.addEventListener('click', ()=>showScreen('bonuses'));
  $('back-from-bonuses')?.addEventListener('click', ()=>showScreen('info'));

  $('btn-day-details')?.addEventListener('click', ()=>{
    try { tg?.HapticFeedback?.impactOccurred('heavy'); } catch {}
    try { tg?.sendData(JSON.stringify({ request: 'day_details' })); } catch(e){ console.error(e); }
    setTimeout(()=>tg?.close?.(), 120);
  });

  $('back-from-stats-mood')?.addEventListener('click', ()=>showScreen('info'));
  $('back-from-stats-day')?.addEventListener('click',  ()=>showScreen('info'));

  $('btn-edit-schedule')?.addEventListener('click', ()=>showScreen('schedule'));
  $('btn-edit-goal')?.addEventListener('click', ()=>showScreen('goal'));
  $('btn-deps-add')?.addEventListener('click', ()=>showScreen('deps-add'));
  $('back-from-settings')?.addEventListener('click', ()=>showScreen('home'));
  $('back-from-schedule')?.addEventListener('click', ()=>showScreen('settings'));
  $('back-from-goal')?.addEventListener('click', ()=>showScreen('settings'));
  $('back-from-deps-add')?.addEventListener('click', ()=>showScreen('settings'));
  $('back-from-task')?.addEventListener('click', ()=>showScreen('home'));

  // –ú–∞–≥–∞–∑–∏–Ω
  $('back-from-shop')?.addEventListener('click', ()=>showScreen('home'));
  $('back-from-item')?.addEventListener('click', ()=>{ showScreen('shop'); tg?.MainButton?.hide(); });

  $('sleep')?.addEventListener('input', updateMainButtonSchedule);
  $('wake')?.addEventListener('input', updateMainButtonSchedule);
  $('goal')?.addEventListener('input', updateMainButtonGoal);
  $('action')?.addEventListener('input', updateMainButtonTask);
  $('dep-title')?.addEventListener('input', updateMainButtonDeps);

  $('chip-will')?.addEventListener('click', ()=>setMode('willpower'));
  $('chip-add')?.addEventListener('click',  ()=>setMode('addiction'));

  $('importanceRange')?.addEventListener('input', updateSliderUI);
  $('dep-strength')?.addEventListener('input', updateSliderUI);
}
function sendPayload(){
  const payload = {};
  payload.tz_offset_min = new Date().getTimezoneOffset();

  if(!$('screen-schedule').classList.contains('hidden')){
    const st=$('sleep').value, wt=$('wake').value;
    if(!isValidTime(st)||!isValidTime(wt)) return;
    payload.sleep_time=st; payload.wake_time=wt;
  }
  if(!$('screen-goal').classList.contains('hidden')){
    const g=($('goal').value||'').trim(); if(!g) return; payload.goal=g;
  }
  if(!$('screen-deps-add').classList.contains('hidden')){
    const t=($('dep-title').value||'').trim(); if(!t) return;
    const s=parseFloat($('dep-strength').value||'1')||1;
    payload.dependency_add = { title: t, strength: s };
  }
  if(!$('screen-task').classList.contains('hidden')){
    const a=($('action').value||'').trim(); if(!a) return;
    const goalText=($('goal-view').textContent||'').trim();
    const r = $('importanceRange');
    const val = parseFloat(r.value||'1') || 1;

    payload.task           = `–Ø ${a} —Ä–∞–¥–∏ ${goalText}`;
    payload.importance     = val;
    payload.importance_f   = val;
    payload.importance_ru  = new Intl.NumberFormat('ru-RU',{minimumFractionDigits:1,maximumFractionDigits:1}).format(val);
    payload.mode           = mode;
    payload.willpower      = (mode==='willpower');
    payload.addiction      = (mode==='addiction');

    if (mode==='addiction' && selectedDepId){
      const d = DEPS.find(x => String(x.id) === String(selectedDepId));
      payload.dep_id    = selectedDepId;
      payload.dep_title = d?.title || '';
    }
  }

  try { tg?.sendData(JSON.stringify(payload)); } catch(e){ console.error(e); }
  try { tg?.HapticFeedback?.notificationOccurred('success'); } catch {}
  setTimeout(()=>tg?.close(), 120);
}

function normalizeDeps(arr){
  return (Array.isArray(arr) ? arr : [])
    .map((d, i) => ({
      id: String(d.id ?? d._id ?? i + 1),
      title: String(d.title ?? d.name ?? '').trim(),
      strength: Number(d.strength ?? d.weight ?? d.value ?? 1) || 1
    }))
    .filter(d => d.title);
}

async function init(){
  tg?.ready(); tg?.expand(); applyTheme(); tg?.onEvent('themeChanged', applyTheme);

  await hydrateFromParamsOrCS();
  DEPS = normalizeDeps(DEPS);
  renderBalanceBadge(); setMoodColor();
  if (userGoal && $('goal-view')) { $('goal-view').textContent = userGoal; }

  bind(); updateScaleLabels(); updateSliderUI();

  // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω
  const params = new URLSearchParams(location.search);
  let screen = (params.get('screen') || 'home').toLowerCase();
  const sp = tg?.initDataUnsafe?.start_param;
  if (sp && typeof sp === 'string') {
    const usp = new URLSearchParams(sp);
    screen = (usp.get('screen') || screen || 'home').toLowerCase();
    const g2 = usp.get('g') || usp.get('goal');
    if (!userGoal && g2 && $('goal-view')) { $('goal-view').textContent = g2; }
  }
  if      (screen==='schedule')   showScreen('schedule');
  else if (screen==='goal')       showScreen('goal');
  else if (screen==='task')       showScreen('task');
  else if (screen==='info')       showScreen('info');
  else if (screen==='stats-day')  showScreen('stats-day');
  else if (screen==='stats_mood' || screen==='mood') showScreen('stats-mood');
  else if (screen==='bonuses')    showScreen('bonuses');
  else if (screen==='deps_add' || screen==='deps-add') showScreen('deps-add');
  else if (screen==='shop')       showScreen('shop');
  else                            showScreen('home');

  tg?.onEvent('mainButtonClicked', ()=>{
    const onShopItem = !$('screen-shop-item')?.classList.contains('hidden');
    if (onShopItem) purchaseCurrentProduct(); else sendPayload();
  });
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
