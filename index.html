<!DOCTYPE html> 
<html lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–†–µ–∂–∏–º —Å–Ω–∞ ‚Äî Telegram WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
  :root {
    /* —Ç—ë–º–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω) */ 
    --bg: #0f1115;
    --card: #161923;
    --text: #e9eef6;
    --muted: #9aa4b2;
    --border: #232838;
    --surface: #10141e;      /* —Ñ–æ–Ω —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∫–Ω–æ–ø–∫–∏/inputs) */
    --accent: #4f8cff;
    --btn-bg: var(--surface);
    --btn-fg: var(--text);
    --input-bg: #0e1118;
    --input-fg: var(--text);
  }
  * { box-sizing: border-box }
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: var(--bg); color: var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial;
  }
  .wrap { min-height: 100%; display: grid; place-items: center; padding: 24px }
  .card {
    width: 100%; max-width: 560px; background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,.35);
  }
  h1 { margin: 0 0 12px; font-size: 20px }
  p  { margin: 0 0 18px; color: var(--muted) }
  .grid { display: grid; gap: 12px }

  /* –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞–µ–º—ã–µ –≤ –ª—é–±–æ–π —Ç–µ–º–µ */
  .menu-btn{
    display:flex; align-items:center; justify-content:space-between;
    width:100%; padding:14px 16px; font-size:16px; border-radius:12px;
    background: var(--btn-bg); color: var(--btn-fg);
    border: 1px solid var(--border); cursor:pointer;
  }
  .menu-btn:disabled { opacity: .6; cursor: not-allowed }

  .row { display:grid; gap:14px }
  .row.two { grid-template-columns:1fr 1fr }

  label { display:block; font-size:13px; color:var(--muted); margin-bottom:6px }

  input[type="time"], textarea {
    display:block; width:100%; background: var(--input-bg); color: var(--input-fg);
    border:1px solid var(--border); border-radius:12px; padding:12px 14px; font-size:16px;
    outline:none; transition:border-color .2s
  }
  input[type="time"]:focus, textarea:focus { border-color: var(--accent) }
  textarea { min-height:120px; resize:vertical }

  .hint { font-size:12px; color:var(--muted); margin-top:8px; text-align:center }
  .topbar { display:flex; align-items:center; gap:8px; margin:-8px 0 12px }
  .back { padding:6px 10px; border-radius:10px; background: var(--surface); border:1px solid var(--border); color: var(--text); cursor:pointer }
  .hidden { display:none }

  /* –∏–Ω–ø—É—Ç—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∫–æ–ª–æ–Ω–∫–∏ */
  .row.two > div { min-width: 0; }
  
  /* –∏–Ω–ø—É—Ç—ã –≤—Å–µ–≥–¥–∞ –≤–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —à–∏—Ä–∏–Ω—É */
  input[type="time"] {
    width: 100%;
    max-width: 100%;
    min-width: 0;
    box-sizing: border-box;
  }
  
  /* –º–æ–±–∏–ª—å–Ω—ã–π –±—Ä–µ–π–∫–ø–æ–∏–Ω—Ç ‚Äî –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö */
  @media (max-width: 480px) {
    .row.two { grid-template-columns: 1fr; }
    .card { padding: 16px; }             /* —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –æ—Ç—Å—Ç—É–ø—ã */
  }
  
  /* –Ω–∞ –æ—á–µ–Ω—å —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –º–æ–∂–Ω–æ –µ—â—ë —É–º–µ–Ω—å—à–∏—Ç—å –∑–∞–∑–æ—Ä */
  @media (max-width: 360px) {
    .grid, .row { gap: 10px; }
  }

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –¥–∞—ë—Ç –Ω–∏—á–µ–º—É ¬´–≤—ã–ø–∞—Å—Ç—å¬ª –Ω–∞—Ä—É–∂—É + –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —à–∏—Ä–∏–Ω–∞/–ø–∞–¥–¥–∏–Ω–≥–∏ */
.card{
  width: min(560px, 92vw);
  padding: clamp(14px, 4vw, 20px);
  overflow: hidden;         /* –∫–ª—é—á–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ */
  box-sizing: border-box;
}

/* –ì—Ä–∏–¥—ã –≤—Å–µ–≥–¥–∞ –≤ —à–∏—Ä–∏–Ω—É –∫–∞—Ä—Ç–æ—á–∫–∏ */
.grid, .row{ width: 100%; }

/* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—é—Ç —Ä–æ–¥–∏—Ç–µ–ª—è */
.row > div{ min-width: 0; }

/* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö ‚Äî –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ */
@media (max-width: 520px){
  .row.two{ grid-template-columns: 1fr; }
  .grid, .row{ gap: 12px; }
}

/* –ò–Ω–ø—É—Ç—ã –≤—Ä–µ–º–µ–Ω–∏: –Ω–µ –≤—ã–ª–∞–∑—è—Ç, —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞, –æ—Ç–∫–ª—é—á–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∏–¥ iOS */
input[type="time"]{
  width: 100%;
  max-width: 100%;
  min-width: 0;
  display: block;
  box-sizing: border-box;
  height: 48px;             /* —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
  line-height: 48px;
  padding: 0 14px;
  appearance: none;
  -webkit-appearance: none;  /* iOS Safari */
  background-clip: padding-box;
  border-radius: 12px;
}

/* (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —á—É—Ç—å –ø—Ä–∏–≥–ª—É—à–∏—Ç—å –∏–∫–æ–Ω–∫—É –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ */
input[type="time"]::-webkit-calendar-picker-indicator{
  opacity: .8;
}

/* –ù–∞ –æ—á–µ–Ω—å —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö ‚Äì –µ—â—ë –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
@media (max-width: 360px){
  .grid, .row{ gap: 10px; }
  .card{ padding: 12px; }
}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- HOME -->
      <section id="screen-home" class="grid">
        <h1>üåô –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</h1>
        <p>–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–æ—Ç–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Å–Ω–∞.</p>
        <button class="menu-btn" onclick="showScreen('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ <span>‚Ä∫</span></button>
        <button class="menu-btn" disabled>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ <span>‚Ä¢</span></button>
        <button class="menu-btn" disabled>‚è±Ô∏è –¢–∞–π–º–µ—Ä <span>‚Ä¢</span></button>
      </section>

      <!-- SETTINGS -->
      <section id="screen-settings" class="grid hidden">
        <div class="topbar">
          <button class="back" onclick="showScreen('home')">‚Üê –ù–∞–∑–∞–¥</button>
          <h1 style="margin:0">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
        </div>
        <button class="menu-btn" onclick="showScreen('schedule')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ <span>‚Ä∫</span></button>
        <button class="menu-btn" onclick="showScreen('goal')">üéØ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å <span>‚Ä∫</span></button>
      </section>

      <!-- SCHEDULE -->
      <section id="screen-schedule" class="grid hidden">
        <div class="topbar">
          <button class="back" onclick="showScreen('settings')">‚Üê –ù–∞–∑–∞–¥</button>
          <h1 style="margin:0">üõå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∂–∏–º–∞ —Å–Ω–∞ v5</h1>
        </div>
        <p>–£–∫–∞–∂–∏ –≤—Ä–µ–º—è –æ—Ç—Ö–æ–¥–∞ –∫–æ —Å–Ω—É –∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è. –§–æ—Ä–º–∞—Ç 24-—á–∞—Å–æ–≤–æ–π, HH:MM.</p>
        <div class="row two">
          <div><label for="sleep">–û—Ç—Ö–æ–¥ –∫–æ —Å–Ω—É</label><input id="sleep" type="time" step="60" required oninput="updateMainButtonSchedule()" /></div>
          <div><label for="wake">–ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ</label><input id="wake" type="time" step="60" required oninput="updateMainButtonSchedule()" /></div>
        </div>
        <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</div>
      </section>

      <!-- GOAL -->
      <section id="screen-goal" class="grid hidden">
        <div class="topbar">
          <button class="back" onclick="showScreen('settings')">‚Üê –ù–∞–∑–∞–¥</button>
          <h1 style="margin:0">üéØ –¶–µ–ª—å</h1>
        </div>
        <p><b>–Ø —Å–¥–µ–ª–∞—é –≤—Å—ë —Ä–∞–¥–∏‚Ä¶</b> –ù–∞–ø–∏—à–∏ —Å–≤–æ—é –ª–∏—á–Ω—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É —Ü–µ–ª–∏.</p>
        <textarea id="goal" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –∑–¥–æ—Ä–æ–≤–æ–≥–æ —Å–Ω–∞ –∏ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å" oninput="updateMainButtonGoal()"></textarea>
        <div class="hint">–ù–∞–∂–º–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å.</div>
      </section>
    </div>
  </div>

  <script>
  // ===== Telegram WebApp =====
  const tg = window.Telegram?.WebApp;

  // ------- helpers -------
  const $ = (id) => document.getElementById(id);
  const isValidTime = (v) => /^\d{2}:\d{2}$/.test(v);

  function applyTheme() {
    const scheme = tg?.colorScheme ?? 'light';
    const set = (k, v) => document.documentElement.style.setProperty(k, v);

    if (scheme === 'dark') {
      set('--bg','#0f1115'); set('--card','#161923'); set('--text','#e9eef6');
      set('--muted','#9aa4b2'); set('--border','#232838'); set('--surface','#10141e');
      set('--accent','#4f8cff'); set('--btn-bg','var(--surface)'); set('--btn-fg','var(--text)');
      set('--input-bg','#0e1118'); set('--input-fg','var(--text)');
    } else {
      set('--bg','#f6f8fc'); set('--card','#ffffff'); set('--text','#0b1220');
      set('--muted','#5b6676'); set('--border','#e6e9f2'); set('--surface','#f1f4fa');
      set('--accent','#4f8cff'); set('--btn-bg','var(--surface)'); set('--btn-fg','var(--text)');
      set('--input-bg','#fbfcff'); set('--input-fg','var(--text)');
    }
    if (tg?.themeParams?.button_color) {
      set('--accent', tg.themeParams.button_color);
    }
  }

  // ------- navigation -------
  function showScreen(name) {
    ['home','settings','schedule','goal'].forEach(id => {
      $(`screen-${id}`).classList.toggle('hidden', id !== name);
    });

    if (!tg) return;
    if (name === 'schedule') {
      tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å');
      updateMainButtonSchedule();
    } else if (name === 'goal') {
      tg.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å');
      updateMainButtonGoal();
    } else {
      tg.MainButton.hide();
    }
  }

  // ------- validators for MainButton -------
  function updateMainButtonSchedule() {
    if (!tg) return;
    const st = $('sleep')?.value || '';
    const wt = $('wake')?.value  || '';
    tg.MainButton[ (isValidTime(st) && isValidTime(wt)) ? 'show' : 'hide' ]();
  }
  function updateMainButtonGoal() {
    if (!tg) return;
    const g = ($('goal')?.value || '').trim();
    tg.MainButton[ g ? 'show' : 'hide' ]();
  }

  // ------- send to bot -------
  function sendPayload() {
    const onSchedule = !$('screen-schedule').classList.contains('hidden');
    const onGoal     = !$('screen-goal').classList.contains('hidden');

    const payload = {};
    if (onSchedule) {
      const st = $('sleep').value, wt = $('wake').value;
      if (!isValidTime(st) || !isValidTime(wt)) return;
      payload.sleep_time = st; payload.wake_time = wt;
    }
    if (onGoal) {
      const g = ($('goal').value || '').trim();
      if (!g) return;
      payload.goal = g;
    }

    try { tg?.sendData(JSON.stringify(payload)); } catch(e) { console.error('sendData error', e); }
    try { tg?.HapticFeedback?.notificationOccurred('success'); } catch {}
    setTimeout(() => tg?.close(), 120);
  }

  // ------- init -------
  function bindEvents() {
    // –∑–∞–º–µ–Ω–∏—Ç—å inline-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏: –≤–µ—à–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Ç—É—Ç
    $('btn-settings')?.addEventListener('click', () => showScreen('settings'));
    $('btn-edit-schedule')?.addEventListener('click', () => showScreen('schedule'));
    $('btn-edit-goal')?.addEventListener('click', () => showScreen('goal'));
    $('back-from-settings')?.addEventListener('click', () => showScreen('home'));
    $('back-from-schedule')?.addEventListener('click', () => showScreen('settings'));
    $('back-from-goal')?.addEventListener('click', () => showScreen('settings'));

    $('sleep')?.addEventListener('input', updateMainButtonSchedule);
    $('wake')?.addEventListener('input', updateMainButtonSchedule);
    $('goal')?.addEventListener('input', updateMainButtonGoal);
  }

  function init() {
    try {
      tg?.ready();
      tg?.expand();
      applyTheme();
      tg?.onEvent('themeChanged', applyTheme);
      tg?.onEvent('mainButtonClicked', sendPayload);
    } catch(e) { /* ignore */ }

    bindEvents();

    // robust deep-link: —É—á–∏—Ç—ã–≤–∞–µ–º –∏ v=..., –∏ –ª—é–±–æ–π –ø–æ—Ä—è–¥–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    const params = new URLSearchParams(location.search);
    const screen = (params.get('screen') || '').toLowerCase();

    // –∏–Ω–æ–≥–¥–∞ WebView –ø—Ä–æ–≥–ª–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–π show ‚Äî –ø–æ–≤—Ç–æ—Ä–∏–º –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
    const target = (screen === 'schedule' || screen === 'goal') ? screen : 'home';
    showScreen(target);
    setTimeout(() => showScreen(target), 0); // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞
  }

  document.addEventListener('DOMContentLoaded', init);

  // –ù–∞ —Å–ª—É—á–∞–π —Å–∫—Ä—ã—Ç–æ–π –æ—à–∏–±–∫–∏, —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å
  window.addEventListener('error', (e) => {
    console.log('JS error:', e.message);
  });
</script>
</body>
</html>
