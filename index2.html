<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GER40 ‚Äî Candles</title>

  <style>
    :root {
      --bg: #f8fafc; --card: #ffffff; --border: #e5e7eb;
      --text: #111827; --muted: #6b7280; --accent: #2563eb;
      --green: #22c55e; --red: #ef4444;
    }
    body { margin:0; background:var(--bg); color:var(--text); font:14px/1.5 "Inter",system-ui,-apple-system,Segoe UI,Roboto,sans-serif; display:flex; flex-direction:column; min-height:100vh; }
    header { display:flex; align-items:center; justify-content:space-between; padding:16px 28px; background:var(--card); border-bottom:1px solid var(--border); box-shadow:0 2px 6px rgba(0,0,0,.03); position:sticky; top:0; z-index:10; }
    #title { font-weight:600; font-size:16px; }
    #subtitle { color:var(--muted); font-size:13px; }
    main { flex:1; display:grid; grid-template-columns:2fr 1fr; gap:20px; padding:24px; max-width:1400px; margin:0 auto; width:100%; box-sizing:border-box; }
    section { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    #chart { height:70vh; }
    h2 { margin:0 0 10px; font-size:15px; font-weight:600; color:var(--text); }
    p { margin:0 0 8px; color:var(--muted); font-size:13px; }
    .btn { border:1px solid var(--border); padding:8px 14px; border-radius:10px; cursor:pointer; background:var(--card); color:var(--text); transition:all .15s; }
    .btn:hover { border-color:var(--accent); color:var(--accent); }
    footer { text-align:center; font-size:12px; color:var(--muted); padding:14px 0 20px; }
    #err { color:var(--red); white-space:pre-wrap; font-family:ui-monospace, Menlo, Consolas, monospace; margin-top:10px; }

    /* —Ñ–æ—Ä–º–∞ —Å–ø—Ä–∞–≤–∞ */
    .field { margin-top:12px; }
    .label { font-size:12px; color:var(--muted); margin-bottom:6px; display:block; }
    textarea { width:100%; min-height:84px; resize:vertical; padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none; font:13px/1.45 inherit; background: #fff; }
    textarea:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,.08); }
    .actions { display:flex; gap:10px; margin-top:14px; }
    .btn.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
    .btn.primary:hover { filter:brightness(0.95); }
    .muted { color:var(--muted); }
    .small { font-size:12px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
</head>
<body>
<header>
  <div>
    <div id="title">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
    <div id="subtitle">–û–∂–∏–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ</div>
  </div>
  <button id="copyLinkBtn" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
</header>

<main>
  <section>
    <div id="chart"></div>
    <div id="err" style="display:none"></div>
  </section>

  <section>
    <h2>–ë—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑</h2>
    <form id="analysisForm">
      <div class="field">
        <label class="label" for="f_overview">–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑</label>
        <textarea id="f_overview" placeholder="–ö—Ä–∞—Ç–∫–æ: —á—Ç–æ –±—ã–ª–æ –∏ –≥–¥–µ –º—ã —Å–µ–π—á–∞—Å‚Ä¶"></textarea>
      </div>
      <div class="field">
        <label class="label" for="f_target">–¶–µ–ª—å –¥–≤–∏–∂–µ–Ω–∏—è</label>
        <textarea id="f_target" placeholder="–ö—É–¥–∞ –±—ã —Ä–∞–±–æ—Ç–∞–ª(–∞), –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –ø–æ —Ü–µ–Ω–∞–º/–∑–æ–Ω–∞–º‚Ä¶"></textarea>
      </div>
      <div class="field">
        <label class="label" for="f_triggers">–¢—Ä–∏–≥–≥–µ—Ä—ã</label>
        <textarea id="f_triggers" placeholder="–û—Ç –∫–∞–∫–∏—Ö –∑–æ–Ω/–ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏—Å–∫–∞–ª(–∞) –≤—Ö–æ–¥‚Ä¶"></textarea>
      </div>
      <div class="field">
        <label class="label" for="f_inval">–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è</label>
        <textarea id="f_inval" placeholder="–ì–¥–µ –∏–¥–µ—è –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –±—ã—Ç—å —Ä–∞–±–æ—á–µ–π‚Ä¶"></textarea>
      </div>

      <div class="actions">
        <button type="submit" class="btn primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–∞</button>
        <button type="button" class="btn" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
      </div>
      <p class="small muted">–°–æ–≤–µ—Ç: –∑–∞–ø–æ–ª–Ω–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–ª–æ–∫ ‚Äî –æ—Å—Ç–∞–ª—å–Ω–æ–µ –º–æ–∂–Ω–æ –ø–æ–∑–∂–µ.</p>
    </form>

    <h2 style="margin-top:18px">–°–≤–æ–¥–∫–∞</h2>
    <p id="stats" class="muted">‚Äì</p>
  </section>
</main>

<footer>¬© 2025 GER40 Viewer ‚Ä¢ GitHub Pages</footer>

<script>
  const qs = new URLSearchParams(location.search);
  const $ = id => document.getElementById(id);

  function showError(msg) {
    $('err').style.display = 'block';
    $('err').textContent = msg;
    $('title').textContent = '–û—à–∏–±–∫–∞';
    $('subtitle').textContent = msg;
  }

  function b64urlToBytes(b64u) {
    const b64 = (b64u||'').replace(/-/g,'+').replace(/_/g,'/');
    const pad = b64.length%4 ? 4-(b64.length%4):0;
    const bin = atob(b64+'='.repeat(pad));
    return Uint8Array.from(bin, c=>c.charCodeAt(0));
  }

  let PAYLOAD = null; // —Å–æ—Ö—Ä–∞–Ω–∏–º –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–º–µ—Å—Ç–µ —Å –∞–Ω–∞–ª–∏–∑–æ–º

  function parsePayload() {
    if (qs.get('demo')==='1') {
      const start=new Date('2025-01-01');
      const candles=Array.from({length:30},(_,i)=>{
        const d=new Date(start.getTime()+i*86400000);
        const o=17000+i*10, h=o+70, l=o-50, c=o+(i%2?30:-20);
        return {time:d.toISOString().slice(0,10),open:o,high:h,low:l,close:c};
      });
      return {symbol:'DEMO',exchange:'TEST',timeframe:'1D',candles};
    }
    const d=qs.get('d'), j=qs.get('j');
    try{
      if(d){ const infl=pako.inflate(b64urlToBytes(d)); return JSON.parse(new TextDecoder().decode(infl)); }
      if(j){ return JSON.parse(decodeURIComponent(j)); }
    }catch(e){ showError('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞: '+e.message); }
    return null;
  }

  function summarize(candles){
    const f=candles[0], l=candles.at(-1);
    const min=Math.min(...candles.map(c=>c.low));
    const max=Math.max(...candles.map(c=>c.high));
    const change=((l.close-f.open)/f.open*100).toFixed(2);
    return `–ü–µ—Ä–∏–æ–¥: ${f.time} ‚Üí ${l.time}<br>–ú–∏–Ω/–ú–∞–∫—Å: ${min.toFixed(2)} / ${max.toFixed(2)}<br>–ò–∑–º.: ${change}%`;
  }

  function renderChart(payload){
    const container=$('chart');
    const chart=LightweightCharts.createChart(container,{
      autoSize:true,
      layout:{background:{type:'solid',color:'#ffffff'}, textColor:'#111'},
      grid:{ vertLines:{color:'rgba(0,0,0,.05)'}, horzLines:{color:'rgba(0,0,0,.05)'} },
      rightPriceScale:{borderVisible:false},
      timeScale:{borderVisible:false,rightOffset:2,barSpacing:8,fixLeftEdge:true},
      crosshair:{mode:LightweightCharts.CrosshairMode.Normal}
    });
    const series=chart.addCandlestickSeries({
      upColor:'#22c55e',downColor:'#ef4444',
      borderUpColor:'#16a34a',borderDownColor:'#dc2626',
      wickUpColor:'#16a34a',wickDownColor:'#dc2626'
    });
    series.setData(payload.candles);
    chart.timeScale().fitContent();

    $('title').textContent=(payload.symbol||'GER40')+' ‚Äî –¥–Ω–µ–≤–Ω—ã–µ —Å–≤–µ—á–∏';
    $('subtitle').textContent=(payload.exchange||'FOREXCOM')+' ‚Ä¢ '+(payload.timeframe||'1D')+' ‚Ä¢ –±–∞—Ä–æ–≤: '+payload.candles.length;
    $('stats').innerHTML=summarize(payload.candles);
  }

  // ---- –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞ ----
  function buildReport() {
    const overview = $('f_overview').value.trim();
    const target = $('f_target').value.trim();
    const triggers = $('f_triggers').value.trim();
    const inval = $('f_inval').value.trim();

    if (!overview && !target && !triggers && !inval) {
      alert('–ó–∞–ø–æ–ª–Ω–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ üôè');
      return null;
    }
    const c = PAYLOAD.candles || [];
    const meta = {
      symbol: PAYLOAD.symbol || 'GER40',
      exchange: PAYLOAD.exchange || 'FOREXCOM',
      timeframe: PAYLOAD.timeframe || '1D',
      period: c.length ? { from: c[0].time, to: c[c.length-1].time } : null,
    };
    return { meta, overview, target, triggers, invalidation: inval };
  }

  function sendToTelegram(report) {
    // 1) WebApp —Ä–µ–∂–∏–º (–∏–¥–µ–∞–ª—å–Ω–æ): –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç—É –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º
    const tg = window.Telegram && window.Telegram.WebApp;
    if (tg && typeof tg.sendData === 'function') {
      tg.sendData(JSON.stringify({ kind:'analysis', payload: report }));
      // –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç ‚Äî –Ω–∞ –≤—Å—è–∫–∏–π
      setTimeout(()=> tg.close(), 50);
      return;
    }
    // 2) –§–æ–ª–±—ç–∫: Telegram Share (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–µ—Ä–µ—Ç —á–∞—Ç –∏ –Ω–∞–∂–º—ë—Ç ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å¬ª)
    const lines = [
      'üìù –ê–Ω–∞–ª–∏–∑ –ø–æ –≥—Ä–∞—Ñ–∏–∫—É',
      `${report.meta.symbol} @ ${report.meta.exchange} ‚Ä¢ ${report.meta.timeframe}`,
      report.meta.period ? `–ü–µ—Ä–∏–æ–¥: ${report.meta.period.from} ‚Üí ${report.meta.period.to}` : '',
      '',
      report.overview ? `–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑:\n${report.overview}` : '',
      report.target ? `–¶–µ–ª—å –¥–≤–∏–∂–µ–Ω–∏—è:\n${report.target}` : '',
      report.triggers ? `–¢—Ä–∏–≥–≥–µ—Ä—ã:\n${report.triggers}` : '',
      report.invalidation ? `–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è:\n${report.invalidation}` : ''
    ].filter(Boolean).join('\n');
    const shareUrl = 'https://t.me/share/url?text=' + encodeURIComponent(lines);
    location.href = shareUrl;
    // –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É —á—É—Ç—å –ø–æ–∑–∂–µ (–≤–Ω—É—Ç—Ä–∏ WebView/–º–æ–±–∏–ª–∫–∞—Ö –æ–±—ã—á–Ω–æ –æ–∫)
    setTimeout(()=> { window.close(); }, 800);
  }

  document.addEventListener('DOMContentLoaded',()=>{
    $('copyLinkBtn').addEventListener('click',async()=>{
      try{await navigator.clipboard.writeText(location.href);}catch{}
      const b=$('copyLinkBtn'); const t=b.textContent;
      b.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'; setTimeout(()=>b.textContent=t,1000);
    });

    PAYLOAD = parsePayload();
    if(!PAYLOAD){ $('subtitle').textContent='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (?demo=1 –¥–ª—è —Ç–µ—Å—Ç–∞)'; }
    else {
      try { renderChart(PAYLOAD); }
      catch(e){ showError(e.message); }
    }

    $('analysisForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const rep = buildReport();
      if (rep) sendToTelegram(rep);
    });
    $('cancelBtn').addEventListener('click', ()=> window.close());
  });
</script>
</body>
</html>
